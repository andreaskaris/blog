
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Andreas Karis' blog about anything Kubernetes, OpenShift, Linux and Networking">
      
      
      
        <link rel="canonical" href="https://andreaskaris.github.io/blog/networking/bpf-and-tcpdump/">
      
      
        <link rel="prev" href="../arp_and_the_neighbor_table/">
      
      
        <link rel="next" href="../bonding_in_linux/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>BPF and tcpdump - Andreas Karis Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="RSS feed of created content" href="https://andreaskaris.github.io/blog/feed_rss_created.xml">
  <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="https://andreaskaris.github.io/blog/feed_rss_updated.xml">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Andreas Karis Blog" class="md-header__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Andreas Karis Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BPF and tcpdump
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ceph/" class="md-tabs__link">
        Ceph
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../linux/" class="md-tabs__link">
        Linux
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        Networking
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../openshift/" class="md-tabs__link">
        OpenShift and Kubernetes
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../openstack/" class="md-tabs__link">
        OpenStack
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../coding/" class="md-tabs__link">
        Coding
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
  
    
    <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
          

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Andreas Karis Blog" class="md-nav__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Andreas Karis Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../ceph/">Ceph</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Ceph
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph-manual-test/" class="md-nav__link">
        Ceph manual test with qemu
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../linux/">Linux</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        cgroups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        Containers in Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/hugepages/" class="md-nav__link">
        Hugepages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/ipxe-boot-environment/" class="md-nav__link">
        iPXE boot environment on Fedora
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/java-idrac-issues/" class="md-nav__link">
        Java Idrac Issues
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/meson/" class="md-nav__link">
        meson
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        namespaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/old_java_version_with_xorgs_in_container/" class="md-nav__link">
        Old Java inside a container with xorgs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/org-gnome-shell-overrides/" class="md-nav__link">
        Workaround for org.gnome.shell.overrides not installed
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/get-process-cgroup-info-and-limits/" class="md-nav__link">
        Retrieving process cgroup resource usage and limit info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/libvirt-uefi-without-secureboot/" class="md-nav__link">
        RHEL Booting a virtual machine with UEFI but without secure boot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/setting-journalctl-limits/" class="md-nav__link">
        Setting journalctl limits
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups_cpu_quota/" class="md-nav__link">
        Using cgroups for CFS bandwidth control
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Networking</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../accept-source-routing/" class="md-nav__link">
        Accept Source Routing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arp_and_the_neighbor_table/" class="md-nav__link">
        ARP and the Neighbor table
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        BPF and tcpdump
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bonding_in_linux/" class="md-nav__link">
        Bonding in Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../juniper_x520/" class="md-nav__link">
        Configure Juniper switch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ovn-interconnection.md" class="md-nav__link">
        Hands-on with OVN Interconnection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../haproxy-and-h2c/" class="md-nav__link">
        haproxy and HTTP/2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install-openvswitch-on-rocky/" class="md-nav__link">
        Install Open vSwitch on Rocky Linux 8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../geneve_tunneling/" class="md-nav__link">
        Geneve tunneling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../netlink/" class="md-nav__link">
        Netlink
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ovn_standalone_on_fedora/" class="md-nav__link">
        OVN standalone on Fedora
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ovs_recirculation/" class="md-nav__link">
        OVS packet recirculation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ovs-vxlan-tunnels-and-dscp/" class="md-nav__link">
        OVS VXLAN tunnels and DSCP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ovs_with_gdb/" class="md-nav__link">
        OVS with GDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packet-tracing-with-ovn/" class="md-nav__link">
        Packet tracing with OVN
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../useful-commands/" class="md-nav__link">
        Useful commands
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../wireguard/" class="md-nav__link">
        Wireguard
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../openshift/">OpenShift and Kubernetes</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          OpenShift and Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/alertmanager/" class="md-nav__link">
        AlertManager
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/analyzing-cni/" class="md-nav__link">
        Analyzing CNI calls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ocp-custom-release-image/" class="md-nav__link">
        Building custom release images for OpenShift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/cpu-manager-with-custom-machine-config-pool/" class="md-nav__link">
        CPU manager with custom MachineConfigPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/crio-conmon-runc/" class="md-nav__link">
        Crio vs conmon vs runc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/dedicated-service-monitors/" class="md-nav__link">
        DedicatedServiceMonitors in OpenShift Monitoring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/etcd_perf/" class="md-nav__link">
        Etcd Performance tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/get-vs-list-api-calls/" class="md-nav__link">
        Get vs List API Calls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_httpbin_tshark_sidecar/" class="md-nav__link">
        Httpbin tshark sidecar container
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kubernetes_cluster/" class="md-nav__link">
        Hints for installing kubernetes on Fedora
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/HPA/" class="md-nav__link">
        Horizontal Pod Autoscaler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/how_rhcos_updates_work/" class="md-nav__link">
        How RHCOS updates work
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kubelet-filesystems/" class="md-nav__link">
        How kubelet monitors filesystems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ocp4-infra-nodes-with-machineset-without-worker-label/" class="md-nav__link">
        Infra nodes with MachineSets without worker label
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ingresscontroller_router_sharding_ocp_on_osp/" class="md-nav__link">
        Ingress Controller Sharding OCP on OSP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ingress-controller-sharding-on-separate-vip/" class="md-nav__link">
        Ingress Controller Sharding on separate VIP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_mirror_registry/" class="md-nav__link">
        Installing a cluster with a mirror registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/istio-1.6-on-ocp.4.x/" class="md-nav__link">
        Istio 1.6 on OpenShift 4.x
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kata/" class="md-nav__link">
        kata containers and the kata operatora
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ovn-kind-hybrid-overlay/" class="md-nav__link">
        Kind with OVN Kubernetes Hybrid Overlay
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kind-with-private-registry/" class="md-nav__link">
        Kind with private registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/list_docker_registry_containers/" class="md-nav__link">
        List container images in registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/mounting-container-image/" class="md-nav__link">
        Mount a container image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/install_openshift_on_openstack/" class="md-nav__link">
        OpenShift on OpenStack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/patch-service-loadbalancer-ingress-ip/" class="md-nav__link">
        Patch status.loadBalancer.ingress IP manually
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/private-registry/" class="md-nav__link">
        Private container registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/proxy-ocp-4.5/" class="md-nav__link">
        Proxy OCP 4.5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/rpm-ostree-failed-to-find-image/" class="md-nav__link">
        rpm-ostreed failed to find image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/scc/" class="md-nav__link">
        Security Context Constraints (SCC)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift-scc-with-mutating-webhooks/" class="md-nav__link">
        SCCs and mutating webhooks - a lesson learned
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/fix-selinux-labels-coreos/" class="md-nav__link">
        SElinux labels fix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_troubleshooting_etcd_state/" class="md-nav__link">
        Troubleshooting etcd state
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/useful-ocp-commands/" class="md-nav__link">
        Useful commands for OpenShift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/useful-ocp-sdn-commands/" class="md-nav__link">
        Useful commands for OpenShift SDN
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/troubleshooting_openshift_on_openstack_worker_creation/" class="md-nav__link">
        Troubleshooting OpenShift on OpenStack worker creation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../openstack/">OpenStack</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          OpenStack
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/reattach_to_running_deployment/" class="md-nav__link">
        Reattach to running deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/using_clouds_yaml/" class="md-nav__link">
        Using clouds.yaml
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../coding/">Coding</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Coding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/operator-sdk-reconciliation/" class="md-nav__link">
        Controller Reconciliation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/vimrc/" class="md-nav__link">
        My vimrc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/golang-ip-conversion/" class="md-nav__link">
        Golang IP address conversion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
        </div>
      </div>
    </div>
  
  
    
    <!--
    <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
          

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
        </div>
      </div>
    </div>
    -->
  

          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>BPF and tcpdump</h1>

<h2 id="introduction">Introduction</h2>
<p>I sometimes used to find myself in situations where tcpdump's filters seemingly did not work the way that I expected them to. In those situations I often simply ran tcpdump in line buffered mode (<code class="highlight">-l</code>) and piped the output into <code class="highlight">grep</code> to find what I was looking for. Particularly the VLAN filter used to give me some headaches with older versions of tcpdump and libpcap. In this article, I will try to shed some light at how tcpdump (via libpcap) generates bytecode for filtering packets. Understanding how the bytecode is generated and how it works should help you understand why a filter expression might not match a specific packet that you are looking for.</p>
<p>This article extends upon the introduction into tcpdump's BPF compiler provided in the blog post <a href="https://blog.cloudflare.com/bpf-the-forgotten-bytecode/" target="_blank">BPF - the forgotten bytecode</a>. Before reading on, read through this resource, then come back here. The blog post also links to the paper <a href="https://www.tcpdump.org/papers/bpf-usenix93.pdf" target="_blank">The BSD Packet Filter: A New Architecture for User-level Packet Capture</a> if you want to further deepen your understanding. The <a href="https://www.kernel.org/doc/Documentation/networking/filter.txt" target="_blank">Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a> kernel documentation might come in handy when following the examples below. Please also note that when I refer to BPF in this article, I refer to classic BPF and not to eBPF.</p>
<h2 id="tcpdump-expressions-and-bpf">tcpdump expressions and BPF</h2>
<h3 id="compiling-a-basic-bpf-expression">Compiling a basic BPF expression</h3>
<p>After reading through the aforementioned material, you should already have an understanding of tcpdump's BPF compiler. Any expression that you give to tcpdump will be compiled into bytecode which in turn will be given to the kernel's JIT compiler. Let's use an easy example and look at the <code class="highlight">icmp</code> filter.</p>
<p>First, we will capture on the loopback interface and ping <code class="highlight"><span class="mf">127.0.0.1</span></code> at the same time:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">timeout</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="nx">lo</span><span class="w"> </span><span class="o">-</span><span class="nx">w</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span>
<span class="nx">dropped</span><span class="w"> </span><span class="nx">privs</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">tcpdump</span>
<span class="nx">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="nx">listening</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">lo</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">),</span><span class="w"> </span><span class="nx">capture</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="nx">bytes</span>
<span class="mi">0</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="nx">captured</span>
<span class="mi">6</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="nx">received</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="nx">dropped</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">kernel</span>
</code></pre></div></td></tr></table></div></p>
<p>Let's look at one of the captured packets. Each visual block in the hexdump is a halfword, or 16 bits. Offsets in tcpdump are specified in Bytes.
The IP ethertype is 0x800 and can be found in Bytes 12 and 13, the ICMP protocol number for ICMP is 0x01 and can be found in Byte 23:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">r</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="w"> </span><span class="o">-</span><span class="nx">xx</span>
<span class="nx">reading</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">)</span>
<span class="nx">dropped</span><span class="w"> </span><span class="nx">privs</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">tcpdump</span>
<span class="mi">11</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="m m-Double">13.451990</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">localhost</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">localhost</span><span class="p">:</span><span class="w"> </span><span class="nx">ICMP</span><span class="w"> </span><span class="nx">echo</span><span class="w"> </span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">seq</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">64</span>

<span class="w">                                            </span><span class="o">|</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="p">(</span><span class="mi">0800</span><span class="p">)</span>
<span class="w">                                            </span><span class="o">|</span>
<span class="w">                                            </span><span class="nx">v</span>
<span class="w">    </span><span class="mh">0x0000</span><span class="p">:</span><span class="w">  </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0800</span><span class="w"> </span><span class="mi">4500</span>
<span class="w">    </span><span class="mh">0x0010</span><span class="p">:</span><span class="w">  </span><span class="mi">0054</span><span class="w"> </span><span class="mi">17</span><span class="nx">ee</span><span class="w"> </span><span class="mi">4000</span><span class="w"> </span><span class="mi">4001</span><span class="w"> </span><span class="mi">24</span><span class="nx">b9</span><span class="w"> </span><span class="mi">7</span><span class="nx">f00</span><span class="w"> </span><span class="mi">0001</span><span class="w"> </span><span class="mi">7</span><span class="nx">f00</span>
<span class="w">                               </span><span class="o">^</span>
<span class="w">                               </span><span class="o">|</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">ICMP</span><span class="w"> </span><span class="p">(</span><span class="mi">01</span><span class="p">)</span>

<span class="w">    </span><span class="mh">0x0020</span><span class="p">:</span><span class="w">  </span><span class="mi">0001</span><span class="w"> </span><span class="mi">0800</span><span class="w"> </span><span class="mi">947</span><span class="nx">c</span><span class="w"> </span><span class="mi">0001</span><span class="w"> </span><span class="mi">0001</span><span class="w"> </span><span class="mi">4566</span><span class="w"> </span><span class="mi">7663</span><span class="w"> </span><span class="mi">0000</span>
<span class="w">    </span><span class="mh">0x0030</span><span class="p">:</span><span class="w">  </span><span class="mi">0000</span><span class="w"> </span><span class="nx">e2e4</span><span class="w"> </span><span class="mi">0600</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">1011</span><span class="w"> </span><span class="mi">1213</span><span class="w"> </span><span class="mi">1415</span>
<span class="w">    </span><span class="mh">0x0040</span><span class="p">:</span><span class="w">  </span><span class="mi">1617</span><span class="w"> </span><span class="mi">1819</span><span class="w"> </span><span class="mi">1</span><span class="nx">a1b</span><span class="w"> </span><span class="mi">1</span><span class="nx">c1d</span><span class="w"> </span><span class="mi">1</span><span class="nx">e1f</span><span class="w"> </span><span class="mi">2021</span><span class="w"> </span><span class="mi">2223</span><span class="w"> </span><span class="mi">2425</span>
<span class="w">    </span><span class="mh">0x0050</span><span class="p">:</span><span class="w">  </span><span class="mi">2627</span><span class="w"> </span><span class="mi">2829</span><span class="w"> </span><span class="mi">2</span><span class="nx">a2b</span><span class="w"> </span><span class="mi">2</span><span class="nx">c2d</span><span class="w"> </span><span class="mi">2</span><span class="nx">e2f</span><span class="w"> </span><span class="mi">3031</span><span class="w"> </span><span class="mi">3233</span><span class="w"> </span><span class="mi">3435</span>
<span class="w">    </span><span class="mh">0x0060</span><span class="p">:</span><span class="w">  </span><span class="mi">3637</span>
</code></pre></div></td></tr></table></div></p>
<p>And here is how tcpdump compiles the <code class="highlight">icmp</code> filter expression for an interface for a live capture:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="nx">lo</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">icmp</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x800</span><span class="w">           </span><span class="nx">jt</span><span class="w"> </span><span class="mi">2</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">5</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">IP</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">5</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">ICMP</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">0</span>
</code></pre></div></td></tr></table></div></p>
<p>We'd also expect this to be the same when we look at our capture file:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">r</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">icmp</span>
<span class="nx">reading</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">)</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x800</span><span class="w">           </span><span class="nx">jt</span><span class="w"> </span><span class="mi">2</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">5</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">IP</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">5</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">ICMP</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">0</span>
</code></pre></div></td></tr></table></div></p>
<p>So far, so good and straight forward. We look at Byte 23 and check if the IP protocol number is 1. Before that, we check the ethernet header in Byte 12 and make sure that we are using IP.</p>
<h3 id="differences-when-filtering-on-the-wire-versus-reading-from-a-packet-capture-file">Differences when filtering on the wire versus reading from a packet capture file</h3>
<p>Depending on the tcpdump version in use, your provided expression might be compiled slightly differently. What's more, there is a difference between the bytecode that is compiled for live packet captures on interfaces and for the bytecode that is compiled for filtering packet capture files. Earlier, we looked at the <code class="highlight">icmp</code> filter. We will now see what happens when we filter for a VLAN number with the <code class="highlight">vlan</code> filter.</p>
<p>The <a href="https://en.wikipedia.org/wiki/EtherType" target="_blank">Wikipedia article about EtherTypes</a> lists the EtherTypes for VLANS: 
for 802.1q the value is <code class="highlight"><span class="mf">0</span><span class="n">x8100</span></code>, for Q-in-Q we would expect to see <code class="highlight"><span class="mf">0</span><span class="n">x88A8</span></code> and for double tagging <code class="highlight"><span class="mf">0</span><span class="n">x9100</span></code>. We expect
to find one of these values in Bytes 12 and 13 of the Ethernet header.
And when we apply the filter to our previously captured file, this is precisely what the expression is compiled to. Tcpdump first loads the halfword at Bytes 12 and 13. Then it sequentially checks if the value matches either of the known EtherTypes for VLAN:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">r</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">vlan</span>
<span class="nx">reading</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">lo</span><span class="p">.</span><span class="nx">pcap</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">)</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x8100</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">2</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m m-Double">802.1</span><span class="nx">q</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x88a8</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">3</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">Q</span><span class="o">-</span><span class="k">in</span><span class="o">-</span><span class="nx">Q</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x9100</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">5</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="p">&lt;</span><span class="o">----</span><span class="w"> </span><span class="nx">ethertype</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">double</span><span class="w"> </span><span class="nx">tagging</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">0</span>
</code></pre></div></td></tr></table></div></p>
<p>Now, let's look at a live capture from the loopback interface. We might expect the same bytecode, but instead we see the following:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">[</span><span class="n">root@host ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">lo</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">vlan</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="n">ldb</span><span class="w">      </span><span class="o">[</span><span class="n">-4048</span><span class="o">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="n">#0x1</span><span class="w">             </span><span class="n">jt</span><span class="w"> </span><span class="mi">6</span><span class="w">    </span><span class="n">jf</span><span class="w"> </span><span class="mi">2</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="n">ldh</span><span class="w">      </span><span class="o">[</span><span class="n">12</span><span class="o">]</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="n">#0x8100</span><span class="w">          </span><span class="n">jt</span><span class="w"> </span><span class="mi">6</span><span class="w">    </span><span class="n">jf</span><span class="w"> </span><span class="mi">4</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="n">#0x88a8</span><span class="w">          </span><span class="n">jt</span><span class="w"> </span><span class="mi">6</span><span class="w">    </span><span class="n">jf</span><span class="w"> </span><span class="mi">5</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="n">#0x9100</span><span class="w">          </span><span class="n">jt</span><span class="w"> </span><span class="mi">6</span><span class="w">    </span><span class="n">jf</span><span class="w"> </span><span class="mi">7</span>
<span class="p">(</span><span class="mi">006</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="n">#262144</span>
<span class="p">(</span><span class="mi">007</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="n">#0</span>
</code></pre></div></td></tr></table></div></p>
<p>The expression is different now! Why is that? Well, the kernel has an internal optimization and will actually store VLAN and other ancillary information in a location with a negative offset.</p>
<p>The reason for this is that the kernel no longer passes specific information as-is to libpcap. See <a href="https://bugs.launchpad.net/ubuntu/+source/tcpdump/+bug/1641429" target="_blank">https://bugs.launchpad.net/ubuntu/+source/tcpdump/+bug/1641429</a> for further details:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nv">The</span><span class="w"> </span><span class="nv">kernel</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">longer</span><span class="w"> </span><span class="nv">passes</span><span class="w"> </span><span class="nv">vlan</span><span class="w"> </span><span class="nv">tag</span><span class="w"> </span><span class="nv">information</span><span class="w"> </span><span class="nv">as</span><span class="o">-</span><span class="nv">is</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">libpcap</span>,<span class="w"> </span><span class="nv">instead</span><span class="w"> </span><span class="nv">BPF</span><span class="w"> </span><span class="nv">needs</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="nv">ancillary</span><span class="w"> </span><span class="nv">data</span>.

<span class="nv">That</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">reason</span><span class="w"> </span><span class="s2">&quot;vlan 114&quot;</span><span class="w"> </span><span class="nv">works</span><span class="w"> </span><span class="ss">(</span><span class="nv">because</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">right</span><span class="w"> </span><span class="nv">thing</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">manual</span><span class="w"> </span><span class="nv">filter</span><span class="w"> </span><span class="nv">doesn</span><span class="err">&#39;t, because libpcap never actually sees this.</span>

<span class="err">Offsets are negative because this is the way to access this ancillary data (like vlan tags) in the Linux kernel:</span>
<span class="err">https://github.com/torvalds/linux/blob/6f0d349d922ba44e4348a17a78ea51b7135965b1/include/uapi/linux/filter.h#L60</span>
</code></pre></div></td></tr></table></div></p>
<p>And see the kernel documentation as well: <a href="https://github.com/torvalds/linux/blob/7acac4b3196caee5e21fb5ea53f8bc124e6a16fc/include/uapi/linux/filter.h#L60" target="_blank">https://github.com/torvalds/linux/blob/7acac4b3196caee5e21fb5ea53f8bc124e6a16fc/include/uapi/linux/filter.h#L60</a>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">RATIONALE</span><span class="p">.</span><span class="w"> </span><span class="n">Negative</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BPF</span><span class="p">.</span>
<span class="w">   </span><span class="n">We</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">ancillary</span><span class="w"> </span><span class="n">data</span><span class="p">.</span>
<span class="w">   </span><span class="n">Unlike</span><span class="w"> </span><span class="n">introduction</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">instructions</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">break</span>
<span class="w">   </span><span class="n">existing</span><span class="w"> </span><span class="n">compilers</span><span class="o">/</span><span class="n">optimizers</span><span class="p">.</span>
<span class="w"> </span><span class="o">*/</span>
#<span class="n">define</span><span class="w"> </span><span class="n">SKF_AD_OFF</span><span class="w">    </span><span class="p">(</span><span class="o">-</span><span class="mi">0</span><span class="n">x1000</span><span class="p">)</span>
<span class="w"> </span><span class="p">(...)</span>
#<span class="n">define</span><span class="w"> </span><span class="n">SKF_AD_VLAN_TAG</span><span class="w"> </span><span class="mi">44</span>
#<span class="n">define</span><span class="w"> </span><span class="n">SKF_AD_VLAN_TAG_PRESENT</span><span class="w"> </span><span class="mi">48</span>
<span class="w"> </span><span class="p">(...)</span>
</code></pre></div></td></tr></table></div>
<p>According to the kernel code, we expect to find an indication that a VLAN tag is present at the following location: </p>
<ul>
<li><code class="highlight">-0x1000 + 48 = - 4096 + 48 = 4048</code></li>
</ul>
<p>The VLAN number is stored at location:</p>
<ul>
<li><code class="highlight">-0x1000 + 44 = - 4096 + 44 = 4052</code></li>
</ul>
<p>For example, let's look for VLAN 32 (0x20) in our packet capture file. We first verify if we find a VLAN ethertype in
Bytes 12 and 13. If so, we load Bytes 14 and 15 and extract the last 12 bits (the VID). We then check if those match 0x20:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># tcpdump -r lo.pcap -d vlan 32</span>
<span class="n">reading</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">lo</span><span class="o">.</span><span class="n">pcap</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="n">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w">                                  </span><span class="c1"># &lt;---- look for dot1q, etc. at Byte 12</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x8100          jt 4    jf 2         # &lt;---- ethertype for 802.1q </span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x88a8          jt 4    jf 3         # &lt;---- ethertype for Q-in-Q</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x9100          jt 4    jf 8         # &lt;---- ethertype for double tagging</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="n">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w">                                  </span><span class="c1"># &lt;---- load Bytes 14 and 15</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w">      </span><span class="c1">#0xfff                                # &lt;---- extract the last 12 bits from the field (VID)</span>
<span class="p">(</span><span class="mi">006</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x20            jt 7    jf 8         # &lt;---- check for VLAN 32</span>
<span class="p">(</span><span class="mi">007</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="c1">#262144</span>
<span class="p">(</span><span class="mi">008</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="c1">#0</span>
</code></pre></div></td></tr></table></div></p>
<p>That, too, makes sense. But if we do a live capture, the logic becomes more complex. We first check at location
<code class="highlight">SKF_AD_VLAN_TAG_PRESENT</code> (-4048) to find out if a VLAN is present. If true, we load location <code class="highlight">SKF_AD_VLAN_TAG</code> (-4052) and
extract the last 12 bits from there and then check if the value equals 0x20. Otherwise, we check Bytes 12 and 14 like above:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">host</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># tcpdump -i lo vlan 32 -d</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="n">ldb</span><span class="w">      </span><span class="p">[</span><span class="o">-</span><span class="mi">4048</span><span class="p">]</span><span class="w">                             </span><span class="c1"># &lt;---- load value at location SKF_AD_VLAN_TAG_PRESENT</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x1             jt 6    jf 2       # &lt;---- if the value is true, check SKF_AD_VLAN_TAG, otherwise read in Byte 12</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="n">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w">                                </span><span class="c1"># &lt;---- load the content at Byte 12</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x8100          jt 6    jf 4</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x88a8          jt 6    jf 5</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x9100          jt 6    jf 14</span>
<span class="p">(</span><span class="mi">006</span><span class="p">)</span><span class="w"> </span><span class="n">ldb</span><span class="w">      </span><span class="p">[</span><span class="o">-</span><span class="mi">4048</span><span class="p">]</span><span class="w">                             </span><span class="c1"># &lt;---- does the kernel special field report this as a VLAN?</span>
<span class="p">(</span><span class="mi">007</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x1             jt 8    jf 10</span>
<span class="p">(</span><span class="mi">008</span><span class="p">)</span><span class="w"> </span><span class="n">ldb</span><span class="w">      </span><span class="p">[</span><span class="o">-</span><span class="mi">4052</span><span class="p">]</span><span class="w">                             </span><span class="c1"># &lt;---- load value at location SKF_AD_VLAN_TAG</span>
<span class="p">(</span><span class="mi">009</span><span class="p">)</span><span class="w"> </span><span class="n">ja</span><span class="w">       </span><span class="mi">11</span><span class="w">                                  </span><span class="c1"># &lt;---- jump to instruction 11</span>
<span class="p">(</span><span class="mi">010</span><span class="p">)</span><span class="w"> </span><span class="n">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
<span class="p">(</span><span class="mi">011</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w">      </span><span class="c1">#0xfff                              # &lt;---- extract the last 12 bits from the field (VID)</span>
<span class="p">(</span><span class="mi">012</span><span class="p">)</span><span class="w"> </span><span class="n">jeq</span><span class="w">      </span><span class="c1">#0x20            jt 13   jf 14      # &lt;---- look for VLAN 32 as earlier</span>
<span class="p">(</span><span class="mi">013</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="c1">#262144</span>
<span class="p">(</span><span class="mi">014</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="w">      </span><span class="c1">#0</span>
</code></pre></div></td></tr></table></div></p>
<p>As a conclusion:</p>
<ul>
<li>Data from a <code class="highlight"><span class="na">.pcap</span></code> file is treated as if everything came directly from the wire, the offsets are the same as we'd see them on the physical layer.</li>
<li>When we capture data from an interface, libpcap will use kernel ancillary data but it will also add a fallback expression in newer versions.</li>
</ul>
<h3 id="how-does-tcpdump-compile-user-provided-expressions-source-code-analysis">How does tcpdump compile user provided expressions - Source code analysis</h3>
<p>Let's look at how tcpdump (by means of libpcap) compiles its expressions into the appropriate BPF bytecode.</p>
<p>tcpdump will compile different types of BPF depending on if the optimization flag is set but also particularly depending on if we open a file for reading or if we run a live capture.</p>
<p>The <code class="highlight">-r</code> indicates to read from a file and the parameter is read here:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1759" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1759</a></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">        </span><span class="nv">case</span><span class="w"> </span><span class="s1">&#39;r&#39;</span>:
<span class="w">            </span><span class="nv">RFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">optarg</span><span class="c1">;</span>
<span class="w">            </span><span class="k">break</span><span class="c1">;</span>
</code></pre></div></td></tr></table></div>
<p>Opening a file for reading happens here:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2053" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2053</a>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#ifdef HAVE_PCAP_SET_TSTAMP_PRECISION</span>
<span class="w">        </span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcap_open_offline_with_tstamp_precision</span><span class="p">(</span><span class="n">RFileName</span><span class="p">,</span>
<span class="w">            </span><span class="n">ndo</span><span class="o">-&gt;</span><span class="n">ndo_tstamp_precision</span><span class="p">,</span><span class="w"> </span><span class="n">ebuf</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcap_open_offline</span><span class="p">(</span><span class="n">RFileName</span><span class="p">,</span><span class="w"> </span><span class="n">ebuf</span><span class="p">);</span>
<span class="cp">#endif</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>If <code class="highlight">-r</code> is not specified, then libpcap will listen on the interface instead:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2135" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2135</a>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">        </span><span class="o">/*</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">name</span><span class="p">.</span>
<span class="w">         </span><span class="o">*/</span>
<span class="w">        </span><span class="n">pd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">open_interface</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ndo</span><span class="p">,</span><span class="w"> </span><span class="n">ebuf</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>How the BPF will be compiled depends on if a file was used as an input or if tcpdump reads from a socket on a network interface. The actual compilation of the user provided filter expression to BPF happens here:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2238" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2238</a>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>    if (pcap_compile(pd, &amp;fcode, cmdbuf, Oflag, netmask) &lt; 0)
        error(&quot;%s&quot;, pcap_geterr(pd));
</code></pre></div></td></tr></table></div></li>
</ul>
<p>If the <code class="highlight">-d</code> parameter (and thus the <code class="highlight">dflag</code>) is set, tcpdump will call libpcap's <code class="highlight">bpf_dump</code> function to print the expression in one of three formats:</p>
<ul>
<li>
<p><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1595" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1595</a>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">        </span><span class="nv">case</span><span class="w"> </span><span class="s1">&#39;d&#39;</span>:
<span class="w">            </span><span class="o">++</span><span class="nv">dflag</span><span class="c1">;</span>
<span class="w">            </span><span class="k">break</span><span class="c1">;</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2240" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2240</a>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>    if (dflag) {
        bpf_dump(&amp;fcode, dflag);
        pcap_close(pd);
        free(cmdbuf);
        pcap_freecode(&amp;fcode);
        exit_tcpdump(S_SUCCESS);
    }
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<p>The different dump formats are explained in the man page:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nv">man</span><span class="w"> </span><span class="nv">tcpdump</span>
<span class="ss">(</span>...<span class="ss">)</span>
<span class="w">       </span><span class="o">-</span><span class="nv">d</span><span class="w">     </span><span class="nv">Dump</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">compiled</span><span class="w"> </span><span class="nv">packet</span><span class="o">-</span><span class="nv">matching</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">human</span><span class="w"> </span><span class="nv">readable</span><span class="w"> </span><span class="nv">form</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">standard</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">stop</span>.

<span class="w">              </span><span class="nv">Please</span><span class="w">  </span><span class="nv">mind</span><span class="w">  </span><span class="nv">that</span><span class="w">  </span><span class="nv">although</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">compilation</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">always</span><span class="w"> </span><span class="nv">DLT</span><span class="o">-</span><span class="nv">specific</span>,<span class="w"> </span><span class="nv">typically</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">impossible</span><span class="w"> </span><span class="ss">(</span><span class="nv">and</span>
<span class="w">              </span><span class="nv">unnecessary</span><span class="ss">)</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">specify</span><span class="w"> </span><span class="nv">which</span><span class="w"> </span><span class="nv">DLT</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">dump</span><span class="w"> </span><span class="nv">because</span><span class="w"> </span><span class="nv">tcpdump</span><span class="w"> </span><span class="nv">uses</span><span class="w"> </span><span class="nv">either</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">DLT</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w">  </span><span class="nv">in</span>
<span class="w">              </span><span class="nv">put</span><span class="w">  </span><span class="nv">pcap</span><span class="w">  </span><span class="nv">file</span><span class="w">  </span><span class="nv">specified</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="o">-</span><span class="nv">r</span>,<span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="nv">DLT</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="nv">interface</span><span class="w"> </span><span class="nv">specified</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span>,<span class="w"> </span><span class="nv">or</span>
<span class="w">              </span><span class="nv">the</span><span class="w"> </span><span class="nv">particular</span><span class="w"> </span><span class="nv">DLT</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="nv">interface</span><span class="w"> </span><span class="nv">specified</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="o">-</span><span class="nv">y</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span><span class="w"> </span><span class="nv">respectively</span>.<span class="w"> </span><span class="nv">In</span><span class="w"> </span><span class="nv">these</span><span class="w"> </span><span class="nv">cases</span><span class="w"> </span><span class="nv">the</span>
<span class="w">              </span><span class="nv">dump</span><span class="w"> </span><span class="nv">shows</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">exact</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">would</span><span class="w"> </span><span class="nv">filter</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="nv">interface</span><span class="w"> </span><span class="nv">without</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span>.

<span class="w">              </span><span class="nv">However</span>,<span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="nv">neither</span><span class="w"> </span><span class="o">-</span><span class="nv">r</span><span class="w"> </span><span class="nv">nor</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">specified</span>,<span class="w"> </span><span class="nv">specifying</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="nv">prevents</span><span class="w"> </span><span class="nv">tcpdump</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">guessing</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">suitable</span>
<span class="w">              </span><span class="nv">network</span><span class="w"> </span><span class="nv">interface</span><span class="w"> </span><span class="ss">(</span><span class="nv">see</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span><span class="ss">)</span>.<span class="w">  </span><span class="nv">In</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">case</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">DLT</span><span class="w"> </span><span class="nv">defaults</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">EN10MB</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">another</span><span class="w">  </span><span class="nv">valid</span>
<span class="w">              </span><span class="nv">value</span><span class="w"> </span><span class="nv">manually</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="o">-</span><span class="nv">y</span>.

<span class="w">       </span><span class="o">-</span><span class="nv">dd</span><span class="w">    </span><span class="nv">Dump</span><span class="w"> </span><span class="nv">packet</span><span class="o">-</span><span class="nv">matching</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">C</span><span class="w"> </span><span class="nv">program</span><span class="w"> </span><span class="nv">fragment</span>.

<span class="w">       </span><span class="o">-</span><span class="nv">ddd</span><span class="w">   </span><span class="nv">Dump</span><span class="w"> </span><span class="nv">packet</span><span class="o">-</span><span class="nv">matching</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">decimal</span><span class="w"> </span><span class="nv">numbers</span><span class="w"> </span><span class="ss">(</span><span class="nv">preceded</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">count</span><span class="ss">)</span>.
<span class="ss">(</span>...<span class="ss">)</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="building-a-filter-expression-compiler">Building a filter expression compiler</h3>
<h4 id="documentation">Documentation</h4>
<p>In order to build a filter expression compiler, we look at the source code:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/master/tcpdump.c#L2238" target="_blank">https://github.com/the-tcpdump-group/tcpdump/blob/master/tcpdump.c#L2238</a></li>
</ul>
<p>And at this documentation here:</p>
<ul>
<li><a href="https://www.tcpdump.org/pcap.html" target="_blank">https://www.tcpdump.org/pcap.html</a></li>
</ul>
<h4 id="installing-dependencies">Installing dependencies</h4>
<p>Install build dependencies. For example, on RHEL 8:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>subscription-manager repos --enable=codeready-builder-for-rhel-8-x86_64-rpms 
yum install libpcap-devel -y
</code></pre></div></td></tr></table></div></p>
<h4 id="creating-the-code">Creating the code</h4>
<p>Now, create the following code:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">cat</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">libpcap_expression_compiler</span><span class="p">.</span><span class="n">c</span>
<span class="o">//</span><span class="w"> </span><span class="k">From</span><span class="err">:</span>
<span class="o">//</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">the</span><span class="o">-</span><span class="n">tcpdump</span><span class="o">-</span><span class="k">group</span><span class="o">/</span><span class="n">tcpdump</span><span class="o">/</span><span class="k">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">tcpdump</span><span class="p">.</span><span class="n">c#L2238</span>
<span class="o">//</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">tcpdump</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">pcap</span><span class="p">.</span><span class="n">html</span>
<span class="o">//</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="p">.</span><span class="n">netfilter</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">iptables</span><span class="o">/</span><span class="n">tree</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="n">nfbpf_compile</span><span class="p">.</span><span class="n">c</span>

<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcap</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Concatenate all input arguments into a long string</span>
<span class="cm"> */</span>
<span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">concat_args</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">arg_string</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="nf">len</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="nf">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">arg_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="nf">len</span><span class="o">+</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">strcat</span><span class="p">(</span><span class="n">arg_string</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot; &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="n">strcat</span><span class="p">(</span><span class="n">arg_string</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">arg_string</span><span class="p">;</span>
<span class="err">}</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">pcap_t</span><span class="w"> </span><span class="o">*</span><span class="n">handle</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">dev</span><span class="err">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;lo&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">errbuf</span><span class="o">[</span><span class="n">PCAP_ERRBUF_SIZE</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">bpf_program</span><span class="w"> </span><span class="n">fcode</span><span class="p">;</span>
<span class="w">    </span><span class="n">bpf_u_int32</span><span class="w"> </span><span class="n">localnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">netmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">Oflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filter_exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Empty filter expression\n&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;Compiling expression &#39;%s&#39;\n\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filter_exp</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcap_lookupnet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localnet</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">netmask</span><span class="p">,</span><span class="w"> </span><span class="n">errbuf</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Can&#39;t get netmask for device %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="n">localnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">netmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcap_open_live</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">BUFSIZ</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">errbuf</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Couldn&#39;t open device %s: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">errbuf</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcap_compile</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fcode</span><span class="p">,</span><span class="w"> </span><span class="n">filter_exp</span><span class="p">,</span><span class="w"> </span><span class="n">Oflag</span><span class="p">,</span><span class="w"> </span><span class="n">netmask</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Couldn&#39;t parse filter %s: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filter_exp</span><span class="p">,</span><span class="w"> </span><span class="n">pcap_geterr</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
<span class="w">         </span><span class="k">return</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;*** Dump compiled packet-matching code (-d) ***\n\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">bpf_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcode</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;\n*** Dump packet-matching code as a C program fragment (-dd) ***\n\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">bpf_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcode</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;\n*** Dump packet-matching code as bytecode (-ddd) ***\n\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">bpf_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcode</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="p">.</span><span class="n">netfilter</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">iptables</span><span class="o">/</span><span class="n">tree</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="n">nfbpf_compile</span><span class="p">.</span><span class="n">c</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;\n*** Dump packet-matching code as bytecode (on one line) ***\n\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">ins</span><span class="p">;</span>
<span class="w">    </span><span class="n">ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcode</span><span class="p">.</span><span class="n">bf_insns</span><span class="p">;</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fcode</span><span class="p">.</span><span class="n">bf_len</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fcode</span><span class="p">.</span><span class="n">bf_len</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ins</span><span class="p">,</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%u %u %u %u,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jt</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jf</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%u %u %u %u\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jt</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jf</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">);</span>

<span class="w">    </span><span class="n">pcap_close</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="k">free</span><span class="p">(</span><span class="n">filter_exp</span><span class="p">);</span>
<span class="w">    </span><span class="n">pcap_freecode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcode</span><span class="p">);</span>

<span class="w">    </span><span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="err">}</span>
<span class="n">EOF</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="compiling-the-code">Compiling the code</h4>
<p>And compile it:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>gcc libpcap_expression_compiler.c -o libpcap_expression_compiler -lpcap
</code></pre></div></td></tr></table></div></p>
<h4 id="using-the-tool">Using the tool</h4>
<p>The tool will now produce the same output as tcpdump with the <code class="highlight">-d</code>, <code class="highlight">-dd</code> or <code class="highlight">-ddd</code> flag set. In order to do so, it will attach to the loopback interface, so the binary must be run with sufficient privileges.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> ./libpcap_expression_compiler vlan 32
Compiling expression &#39;vlan 32&#39;

*** Dump compiled packet-matching code (-d) ***

(000) ldb      [-4048]
(001) jeq      #0x1             jt 6    jf 2
(002) ldh      [12]
(003) jeq      #0x8100          jt 6    jf 4
(004) jeq      #0x88a8          jt 6    jf 5
(005) jeq      #0x9100          jt 6    jf 14
(006) ldb      [-4048]
(007) jeq      #0x1             jt 8    jf 10
(008) ldb      [-4052]
(009) ja       11
(010) ldh      [14]
(011) and      #0xfff
(012) jeq      #0x20            jt 13   jf 14
(013) ret      #8192
(014) ret      #0

*** Dump packet-matching code as a C program fragment (-dd) ***

{ 0x30, 0, 0, 0xfffff030 },
{ 0x15, 4, 0, 0x00000001 },
{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 2, 0, 0x00008100 },
{ 0x15, 1, 0, 0x000088a8 },
{ 0x15, 0, 8, 0x00009100 },
{ 0x30, 0, 0, 0xfffff030 },
{ 0x15, 0, 2, 0x00000001 },
{ 0x30, 0, 0, 0xfffff02c },
{ 0x5, 0, 0, 0x00000001 },
{ 0x28, 0, 0, 0x0000000e },
{ 0x54, 0, 0, 0x00000fff },
{ 0x15, 0, 1, 0x00000020 },
{ 0x6, 0, 0, 0x00002000 },
{ 0x6, 0, 0, 0x00000000 },

*** Dump packet-matching code as bytecode (-ddd) ***

15
48 0 0 4294963248
21 4 0 1
40 0 0 12
21 2 0 33024
21 1 0 34984
21 0 8 37120
48 0 0 4294963248
21 0 2 1
48 0 0 4294963244
5 0 0 1
40 0 0 14
84 0 0 4095
21 0 1 32
6 0 0 8192
6 0 0 0

*** Dump packet-matching code as bytecode (on one line) ***

15,48 0 0 4294963248,21 4 0 1,40 0 0 12,21 2 0 33024,21 1 0 34984,21 0 8 37120,48 0 0 4294963248,21 0 2 1,48 0 0 4294963244,5 0 0 1,40 0 0 14,84 0 0 4095,21 0 1 32,6 0 0 8192,6 0 0 0
</code></pre></div></td></tr></table></div>
<p>Or let's create another filter expression, just as another example:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> ./libpcap_expression_compiler host 127.0.0.254 and tcp and port 5353
Compiling expression &#39;host 127.0.0.254 and tcp and port 5353&#39;

*** Dump compiled packet-matching code (-d) ***

(000) ldh      [12]
(001) jeq      #0x800           jt 2    jf 16
(002) ld       [26]
(003) jeq      #0x7f0000fe      jt 6    jf 4
(004) ld       [30]
(005) jeq      #0x7f0000fe      jt 6    jf 16
(006) ldb      [23]
(007) jeq      #0x6             jt 8    jf 16
(008) ldh      [20]
(009) jset     #0x1fff          jt 16   jf 10
(010) ldxb     4*([14]&amp;0xf)
(011) ldh      [x + 14]
(012) jeq      #0x14e9          jt 15   jf 13
(013) ldh      [x + 16]
(014) jeq      #0x14e9          jt 15   jf 16
(015) ret      #8192
(016) ret      #0

*** Dump packet-matching code as a C program fragment (-dd) ***

{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 0, 14, 0x00000800 },
{ 0x20, 0, 0, 0x0000001a },
{ 0x15, 2, 0, 0x7f0000fe },
{ 0x20, 0, 0, 0x0000001e },
{ 0x15, 0, 10, 0x7f0000fe },
{ 0x30, 0, 0, 0x00000017 },
{ 0x15, 0, 8, 0x00000006 },
{ 0x28, 0, 0, 0x00000014 },
{ 0x45, 6, 0, 0x00001fff },
{ 0xb1, 0, 0, 0x0000000e },
{ 0x48, 0, 0, 0x0000000e },
{ 0x15, 2, 0, 0x000014e9 },
{ 0x48, 0, 0, 0x00000010 },
{ 0x15, 0, 1, 0x000014e9 },
{ 0x6, 0, 0, 0x00002000 },
{ 0x6, 0, 0, 0x00000000 },

*** Dump packet-matching code as bytecode (-ddd) ***

17
40 0 0 12
21 0 14 2048
32 0 0 26
21 2 0 2130706686
32 0 0 30
21 0 10 2130706686
48 0 0 23
21 0 8 6
40 0 0 20
69 6 0 8191
177 0 0 14
72 0 0 14
21 2 0 5353
72 0 0 16
21 0 1 5353
6 0 0 8192
6 0 0 0

*** Dump packet-matching code as bytecode (on one line) ***

17,40 0 0 12,21 0 14 2048,32 0 0 26,21 2 0 2130706686,32 0 0 30,21 0 10 2130706686,48 0 0 23,21 0 8 6,40 0 0 20,69 6 0 8191,177 0 0 14,72 0 0 14,21 2 0 5353,72 0 0 16,21 0 1 5353,6 0 0 8192,6 0 0 0
</code></pre></div></td></tr></table></div></p>
<h2 id="generating-and-using-bpf-bytecode-with-iptables">Generating and using BPF bytecode with iptables</h2>
<p>The aforementioned article <a href="https://blog.cloudflare.com/bpf-the-forgotten-bytecode/" target="_blank">BPF - the forgotten bytecode</a> shows that BPF bytecode can also be used outside of tcpdump. Let's see how we can use BPF bytecode together with iptables to filter traffic.</p>
<h3 id="dependencies">Dependencies</h3>
<p>For RHEL/CentOS 8, during my testing I installed the following build dependencies for the examples below:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="s1">&#39;@Development Tools&#39;</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">gcc</span><span class="o">-</span><span class="n">toolset</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">binutils</span><span class="o">-</span><span class="n">devel</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">readline</span><span class="o">-</span><span class="n">devel</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">elfutils</span><span class="o">-</span><span class="n">libelf</span><span class="o">-</span><span class="n">devel</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">clang</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">llvm</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="generating-bpf-bytecode-with-tcpdump">Generating BPF bytecode with tcpdump</h3>
<p>There are several different options to generate BPF bytecode. The easiest way is to use tcpdump to generate it from a provided filter expression. The iptables bpf module requires input that is generated with data link type <code class="highlight">DLT_RAW</code>. </p>
<h4 id="prerequisites-for-tcpdump">Prerequisites for tcpdump</h4>
<p>In my case, <code class="highlight">DLT_RAW</code> was not supported by my distribution's build (RHEL 8). If you find yourself in the same situation, you can build a recent version of tcpdump directly from source. </p>
<p>Example build instructions:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code>git clone https://github.com/the-tcpdump-group/tcpdump
git clone https://github.com/the-tcpdump-group/libpcap.git
cd libpcap/
git checkout origin/libpcap-1.10
./configure
make install
cd ../tcpdump/ 
git checkout origin/tcpdump-4.99
./configure
make install
</code></pre></div></td></tr></table></div></p>
<h4 id="comparing-link-layer-header-types-dlts">Comparing link-layer header types (DLTs)</h4>
<p>Compare the output of the following commands - the first one, <code class="highlight">EN10MB</code>, accounts for ethernet headers whereas <code class="highlight">RAW</code> starts at the IP headers:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">implicit</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="nx">DLT</span>
<span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">tcp</span><span class="w"> </span><span class="nx">dst</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">8080</span>
<span class="nx">Warning</span><span class="p">:</span><span class="w"> </span><span class="nx">assuming</span><span class="w"> </span><span class="nx">Ethernet</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x86dd</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">2</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">6</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x6</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">4</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">15</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">56</span><span class="p">]</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1f90</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">15</span>
<span class="p">(</span><span class="mi">006</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x800</span><span class="w">           </span><span class="nx">jt</span><span class="w"> </span><span class="mi">7</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">15</span>
<span class="p">(</span><span class="mi">007</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<span class="p">(</span><span class="mi">008</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x6</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">9</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">15</span>
<span class="p">(</span><span class="mi">009</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
<span class="p">(</span><span class="mi">010</span><span class="p">)</span><span class="w"> </span><span class="nx">jset</span><span class="w">     </span><span class="err">#</span><span class="mh">0x1fff</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">15</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">11</span>
<span class="p">(</span><span class="mi">011</span><span class="p">)</span><span class="w"> </span><span class="nx">ldxb</span><span class="w">     </span><span class="mi">4</span><span class="o">*</span><span class="p">([</span><span class="mi">14</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span>
<span class="p">(</span><span class="mi">012</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="p">(</span><span class="mi">013</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1f90</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">15</span>
<span class="p">(</span><span class="mi">014</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mi">015</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">0</span>
<span class="err">#</span><span class="w"> </span><span class="nx">RAW</span><span class="w"> </span><span class="nx">DLT</span>
<span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">y</span><span class="w"> </span><span class="nx">RAW</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">tcp</span><span class="w"> </span><span class="nx">dst</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">8080</span>
<span class="p">(</span><span class="mi">000</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w">      </span><span class="err">#</span><span class="mh">0xf0</span>
<span class="p">(</span><span class="mi">002</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x60</span><span class="w">            </span><span class="nx">jt</span><span class="w"> </span><span class="mi">3</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">7</span>
<span class="p">(</span><span class="mi">003</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="p">(</span><span class="mi">004</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x6</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">5</span><span class="w">    </span><span class="nx">jf</span><span class="w"> </span><span class="mi">18</span>
<span class="p">(</span><span class="mi">005</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">42</span><span class="p">]</span>
<span class="p">(</span><span class="mi">006</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1f90</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">17</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">18</span>
<span class="p">(</span><span class="mi">007</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">(</span><span class="mi">008</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w">      </span><span class="err">#</span><span class="mh">0xf0</span>
<span class="p">(</span><span class="mi">009</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x40</span><span class="w">            </span><span class="nx">jt</span><span class="w"> </span><span class="mi">10</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">18</span>
<span class="p">(</span><span class="mi">010</span><span class="p">)</span><span class="w"> </span><span class="nx">ldb</span><span class="w">      </span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="p">(</span><span class="mi">011</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x6</span><span class="w">             </span><span class="nx">jt</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">18</span>
<span class="p">(</span><span class="mi">012</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="p">(</span><span class="mi">013</span><span class="p">)</span><span class="w"> </span><span class="nx">jset</span><span class="w">     </span><span class="err">#</span><span class="mh">0x1fff</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">18</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">14</span>
<span class="p">(</span><span class="mi">014</span><span class="p">)</span><span class="w"> </span><span class="nx">ldxb</span><span class="w">     </span><span class="mi">4</span><span class="o">*</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span>
<span class="p">(</span><span class="mi">015</span><span class="p">)</span><span class="w"> </span><span class="nx">ldh</span><span class="w">      </span><span class="p">[</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>
<span class="p">(</span><span class="mi">016</span><span class="p">)</span><span class="w"> </span><span class="nx">jeq</span><span class="w">      </span><span class="err">#</span><span class="mh">0x1f90</span><span class="w">          </span><span class="nx">jt</span><span class="w"> </span><span class="mi">17</span><span class="w">   </span><span class="nx">jf</span><span class="w"> </span><span class="mi">18</span>
<span class="p">(</span><span class="mi">017</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">262144</span>
<span class="p">(</span><span class="mi">018</span><span class="p">)</span><span class="w"> </span><span class="nx">ret</span><span class="w">      </span><span class="err">#</span><span class="mi">0</span>
</code></pre></div></td></tr></table></div></p>
<p>As stated earlier, for <code class="highlight">iptables -m bpf</code>, we need the output that's generated by <code class="highlight">DLT_RAW</code>.</p>
<p>For further information about DLTs, see <a href="https://www.tcpdump.org/linktypes.html" target="_blank">LINK-LAYER HEADER TYPES</a> which states the following for <code class="highlight">DLT_RAW</code>:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>Raw IP; the packet begins with an IPv4 or IPv6 header, with the version field of the header indicating whether it&#39;s an IPv4 or IPv6 heade
</code></pre></div></td></tr></table></div></p>
<h4 id="using-a-simple-filter-expression-with-tcpdump">Using a simple filter expression with tcpdump</h4>
<p>You can generate the bytecode for iptables with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code># tcpdump -y RAW -ddd tcp dst port 8080 | tr &#39;\n&#39; &#39;,&#39; | sed &#39;s/,$//&#39;
19,48 0 0 0,84 0 0 240,21 0 4 96,48 0 0 6,21 0 13 6,40 0 0 42,21 10 11 8080,48 0 0 0,84 0 0 240,21 0 8 64,48 0 0 9,21 0 6 6,40 0 0 6,69 4 0 8191,177 0 0 0,72 0 0 2,21 0 1 8080,6 0 0 262144,6 0 0 0
</code></pre></div></td></tr></table></div></p>
<p>And now, you can use this bytecode with iptables:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> python3 -m http.server 8080 &gt;/dev/null 2&gt;&amp;1 &amp;
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
200
<span class="gh">#</span> iptables -I INPUT -m bpf --bytecode &quot;$(tcpdump -y RAW -ddd tcp dst port 8080 | tr &#39;\n&#39; &#39;,&#39; | sed &#39;s/,$//&#39;)&quot; -j REJECT
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
000
<span class="gh">#</span> iptables -L INPUT -nv --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1        2   120 REJECT     all  --  <span class="gs">*      *</span>       0.0.0.0/0            0.0.0.0/0           match bpf 48 0 0 0,84 0 0 240,21 0 4 96,48 0 0 6,21 0 13 6,40 0 0 42,21 10 11 8080,48 0 0 0,84 0 0 240,21 0 8 64,48 0 0 9,21 0 6 6,40 0 0 6,69 4 0 8191,177 0 0 0,72 0 0 2,21 0 1 8080,6 0 0 262144,6 0 0 0 reject-with icmp-port-unreachable
</code></pre></div></td></tr></table></div></p>
<h4 id="tcpdump-with-an-explicit-offset-expression">tcpdump with an explicit offset expression</h4>
<p>Let's get a bit more fancy and let's filter the same packets with a custom offset expression. 
In <code class="highlight">test.pcap</code>, I captured a TCP request to port 8080. The hexdump looks as follows. I am purposefully ignoring the ethernet header by only providing <code class="highlight">-x</code> as <code class="highlight">DLT_RAW</code> begins with the IP header:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">nn</span><span class="w"> </span><span class="o">-</span><span class="nx">r</span><span class="w"> </span><span class="nx">test</span><span class="p">.</span><span class="nx">pcap</span><span class="w"> </span><span class="o">-</span><span class="nx">x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">tail</span><span class="w"> </span><span class="o">-</span><span class="nx">n</span><span class="w"> </span><span class="mi">10</span>
<span class="nx">reading</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">test</span><span class="p">.</span><span class="nx">pcap</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">),</span><span class="w"> </span><span class="nx">snapshot</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">262144</span>
<span class="mi">08</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="m m-Double">05.409490</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="m m-Double">127.0.0.1.8080</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m m-Double">127.0.0.1.55346</span><span class="p">:</span><span class="w"> </span><span class="nx">Flags</span><span class="w"> </span><span class="p">[</span><span class="nx">F</span><span class="p">.],</span><span class="w"> </span><span class="nx">seq</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">ack</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="nx">win</span><span class="w"> </span><span class="mi">342</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="p">[</span><span class="nx">nop</span><span class="p">,</span><span class="nx">nop</span><span class="p">,</span><span class="nx">TS</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="mi">1370696821</span><span class="w"> </span><span class="nx">ecr</span><span class="w"> </span><span class="mi">1370694317</span><span class="p">],</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="mh">0x0000</span><span class="p">:</span><span class="w">  </span><span class="mi">4500</span><span class="w"> </span><span class="mi">0034</span><span class="w"> </span><span class="mi">896</span><span class="nx">d</span><span class="w"> </span><span class="mi">4000</span><span class="w"> </span><span class="mi">4006</span><span class="w"> </span><span class="nx">b354</span><span class="w"> </span><span class="mi">7</span><span class="nx">f00</span><span class="w"> </span><span class="mi">0001</span>
<span class="w">    </span><span class="mh">0x0010</span><span class="p">:</span><span class="w">  </span><span class="mi">7</span><span class="nx">f00</span><span class="w"> </span><span class="mi">0001</span><span class="w"> </span><span class="mi">1</span><span class="nx">f90</span><span class="w"> </span><span class="nx">d832</span><span class="w"> </span><span class="mi">2</span><span class="nx">b16</span><span class="w"> </span><span class="nx">be50</span><span class="w"> </span><span class="nx">ec11</span><span class="w"> </span><span class="mi">89</span><span class="nx">b4</span>
<span class="w">    </span><span class="mh">0x0020</span><span class="p">:</span><span class="w">  </span><span class="mi">8011</span><span class="w"> </span><span class="mi">0156</span><span class="w"> </span><span class="nx">fe28</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0101</span><span class="w"> </span><span class="mi">080</span><span class="nx">a</span><span class="w"> </span><span class="mi">51</span><span class="nx">b3</span><span class="w"> </span><span class="mi">2</span><span class="nx">c75</span>
<span class="w">    </span><span class="mh">0x0030</span><span class="p">:</span><span class="w">  </span><span class="mi">51</span><span class="nx">b3</span><span class="w"> </span><span class="mi">22</span><span class="nx">ad</span>
<span class="mi">08</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="m m-Double">05.409525</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="m m-Double">127.0.0.1.55346</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m m-Double">127.0.0.1.8080</span><span class="p">:</span><span class="w"> </span><span class="nx">Flags</span><span class="w"> </span><span class="p">[.],</span><span class="w"> </span><span class="nx">ack</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">win</span><span class="w"> </span><span class="mi">342</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="p">[</span><span class="nx">nop</span><span class="p">,</span><span class="nx">nop</span><span class="p">,</span><span class="nx">TS</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="mi">1370696821</span><span class="w"> </span><span class="nx">ecr</span><span class="w"> </span><span class="mi">1370696821</span><span class="p">],</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="mh">0x0000</span><span class="p">:</span><span class="w">  </span><span class="mi">4500</span><span class="w"> </span><span class="mi">0034</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">4000</span><span class="w"> </span><span class="mi">4006</span><span class="w"> </span><span class="mi">3</span><span class="nx">cc2</span><span class="w"> </span><span class="mi">7</span><span class="nx">f00</span><span class="w"> </span><span class="mi">0001</span>
<span class="w">    </span><span class="mh">0x0010</span><span class="p">:</span><span class="w">  </span><span class="mi">7</span><span class="nx">f00</span><span class="w"> </span><span class="mi">0001</span><span class="w"> </span><span class="nx">d832</span><span class="w"> </span><span class="mi">1</span><span class="nx">f90</span><span class="w"> </span><span class="nx">ec11</span><span class="w"> </span><span class="mi">89</span><span class="nx">b4</span><span class="w"> </span><span class="mi">2</span><span class="nx">b16</span><span class="w"> </span><span class="nx">be51</span>
<span class="w">                             </span><span class="o">^</span>
<span class="w">                             </span><span class="o">|--------</span><span class="w"> </span><span class="nx">dst</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mh">0x1f90</span><span class="w"> </span><span class="p">(</span><span class="nx">Bytes</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span>
<span class="w">    </span><span class="mh">0x0020</span><span class="p">:</span><span class="w">  </span><span class="mi">8010</span><span class="w"> </span><span class="mi">0156</span><span class="w"> </span><span class="mi">2423</span><span class="w"> </span><span class="mi">0000</span><span class="w"> </span><span class="mi">0101</span><span class="w"> </span><span class="mi">080</span><span class="nx">a</span><span class="w"> </span><span class="mi">51</span><span class="nx">b3</span><span class="w"> </span><span class="mi">2</span><span class="nx">c75</span>
<span class="w">    </span><span class="mh">0x0030</span><span class="p">:</span><span class="w">  </span><span class="mi">51</span><span class="nx">b3</span><span class="w"> </span><span class="mi">2</span><span class="nx">c75</span>
</code></pre></div></td></tr></table></div></p>
<p>We want to identify all packets with a dst port of <code class="highlight"><span class="mf">8080</span></code> (or <code class="highlight"><span class="mf">0</span><span class="n">x1f90</span></code> in hex notation). We are looking for halfword 11, or Bytes 22 and 23. The tcpdump expression would hence be:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>ether[22:2] == 0x1f90
</code></pre></div></td></tr></table></div>
Don't be mislead by the <code class="highlight">ether</code> keyword. We are filtering with <code class="highlight">DLT_RAW</code> and hence have to ignore the etherheader.</p>
<p>And the compiled expression:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>#  tcpdump -y RAW -d ether[22:2] == 0x1f90
(000) ldh      [22]
(001) jeq      #0x1f90          jt 2    jf 3
(002) ret      #262144
(003) ret      #0
# tcpdump -y RAW -ddd ether[22:2] == 0x1f90 | tr &#39;\n&#39; &#39;,&#39; | sed &#39;s/,$//&#39;
4,40 0 0 22,21 0 1 8080,6 0 0 262144,6 0 0 0
</code></pre></div></td></tr></table></div></p>
<p>And we can test this again:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> python3 -m http.server 8080 &gt;/dev/null 2&gt;&amp;1 &amp;
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
200
<span class="gh">#</span> iptables -I INPUT -m bpf --bytecode &quot;$(tcpdump -y RAW -ddd ether[22:2] == 0x1f90 | tr &#39;\n&#39; &#39;,&#39; | sed &#39;s/,$//&#39;)&quot; -j REJECT
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
000
<span class="gh">#</span> iptables -L INPUT -nv --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1        2   120 REJECT     all  --  <span class="gs">*      *</span>       0.0.0.0/0            0.0.0.0/0           match bpf 40 0 0 22,21 0 1 8080,6 0 0 262144,6 0 0 0 reject-with icmp-port-unreachable
</code></pre></div></td></tr></table></div></p>
<h3 id="generating-bpf-bytecode-with-nfbpf_compile">Generating BPF bytecode with nfbpf_compile</h3>
<p>While searching for more resources, I found <a href="https://www.lowendtalk.com/discussion/47469/bpf-a-bytecode-for-filtering" target="_blank">BPF: A Bytecode for filtering</a>.
The article links to <a href="https://git.netfilter.org/iptables/tree/utils/nfbpf_compile.c" target="_blank">nfbpf_compile.c</a> which can generate <code class="highlight">iptables -m bpf</code> compatible bytecode
by using <code class="highlight">DLT_RAW</code>.</p>
<p>Here's the full script from the above link (just in case the original resource changes):
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">cat</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nbpf_compile</span><span class="p">.</span><span class="n">c</span>
<span class="cm">/*</span>
<span class="cm"> * BPF program compilation tool</span>
<span class="cm"> *</span>
<span class="cm"> * Generates decimal output, similar to `tcpdump -ddd ...`.</span>
<span class="cm"> * Unlike tcpdump, will generate for any given link layer type.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Willem de Bruijn (willemb@google.com)</span>
<span class="cm"> * Copyright Google, Inc. 2013</span>
<span class="cm"> * Licensed under the GNU General Public License version 2 (GPLv2)</span>
<span class="cm">*/</span>

<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcap</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">bpf_program</span><span class="w"> </span><span class="n">program</span><span class="p">;</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">ins</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dlt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DLT_RAW</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Usage:    %s [link] &#39;&lt;program&gt;&#39;\n\n&quot;</span>
<span class="w">                </span><span class="ss">&quot;          link is a pcap linklayer type:\n&quot;</span>
<span class="w">                </span><span class="ss">&quot;          one of EN10MB, RAW, SLIP, ...\n\n&quot;</span>
<span class="w">                </span><span class="ss">&quot;Examples: %s RAW &#39;tcp and greater 100&#39;\n&quot;</span>
<span class="w">                </span><span class="ss">&quot;          %s EN10MB &#39;ip proto 47&#39;\n&#39;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">argv</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">dlt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcap_datalink_name_to_val</span><span class="p">(</span><span class="n">argv</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dlt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Unknown datalinktype: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcap_compile_nopcap</span><span class="p">(</span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="n">dlt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="o">[</span><span class="n">argc - 1</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">PCAP_NETMASK_UNKNOWN</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Compilation error\n&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="n">bf_len</span><span class="p">);</span>
<span class="w">    </span><span class="n">ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="n">bf_insns</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="n">bf_len</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ins</span><span class="p">,</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%u %u %u %u,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jt</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jf</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;%u %u %u %u\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jt</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">jf</span><span class="p">,</span><span class="w"> </span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">);</span>

<span class="w">    </span><span class="n">pcap_freecode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">program</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
<span class="n">EOF</span>
</code></pre></div></td></tr></table></div></p>
<p>Compile this with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>gcc nbpf_compile.c -o nbpf_compile -lpcap
</code></pre></div></td></tr></table></div></p>
<p>And generate the bytecode:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> ./nbpf_compile RAW &#39;tcp port 8080&#39;
23,48 0 0 0,84 0 0 240,21 0 6 96,48 0 0 6,21 0 17 6,40 0 0 40,21 14 0 8080,40 0 0 42,21 12 13 8080,48 0 0 0,84 0 0 240,21 0 10 64,48 0 0 9,21 0 8 6,40 0 0 6,69 6 0 8191,177 0 0 0,72 0 0 0,21 2 0 8080,72 0 0 2,21 0 1 8080,6 0 0 65535,6 0 0 0
</code></pre></div></td></tr></table></div></p>
<p>As earlier, we can test this with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> python3 -m http.server 8080 &gt;/dev/null 2&gt;&amp;1 &amp;
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
200
<span class="gh">#</span> iptables -I INPUT -m bpf --bytecode &quot;$(./nbpf_compile RAW &#39;tcp port 8080&#39;)&quot; -j REJECT
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
000
<span class="gh">#</span> iptables -L INPUT -nv --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1        2   120 REJECT     all  --  <span class="gs">*      *</span>       0.0.0.0/0            0.0.0.0/0           match bpf 48 0 0 0,84 0 0 240,21 0 6 96,48 0 0 6,21 0 17 6,40 0 0 40,21 14 0 8080,40 0 0 42,21 12 13 8080,48 0 0 0,84 0 0 240,21 0 10 64,48 0 0 9,21 0 8 6,40 0 0 6,69 6 0 8191,177 0 0 0,72 0 0 0,21 2 0 8080,72 0 0 2,21 0 1 8080,6 0 0 65535,6 0 0 0 reject-with icmp-port-unreachable
</code></pre></div></td></tr></table></div></p>
<h3 id="generating-bpf-bytecode-from-bpf-asm-instructions">Generating BPF bytecode from BPF asm instructions</h3>
<p>You can also choose the low level route and write your own BPF asm instructions and convert them into bytecode.</p>
<h4 id="compiling-helper-binaries">Compiling helper binaries</h4>
<p>First, you will need the <code class="highlight">bpf_asm</code> binary from the kernel source code. </p>
<p>Get the kernel source code on RHEL / CentOS:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span><span class="n">src</span>
<span class="n">cd</span><span class="w"> </span><span class="n">kernel</span><span class="o">/</span>
<span class="n">yumdownloader</span><span class="w"> </span><span class="o">--</span><span class="n">source</span><span class="w"> </span><span class="n">kernel</span>
<span class="n">cp</span><span class="w"> </span><span class="n">kernel</span><span class="o">-*.</span><span class="n">src</span><span class="o">.</span><span class="n">rpm</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">rpm2cpio</span><span class="w"> </span><span class="n">kernel</span><span class="o">-*.</span><span class="n">src</span><span class="o">.</span><span class="n">rpm</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cpio</span><span class="w"> </span><span class="o">-</span><span class="n">idmv</span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">xf</span><span class="w"> </span><span class="n">linux</span><span class="o">-*.</span><span class="n">tar</span><span class="o">.</span><span class="n">xz</span>
</code></pre></div></td></tr></table></div></p>
<p>Compile the BPF toolset:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="o">$</span><span class="p">(</span><span class="n">find</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">-</span><span class="n">path</span><span class="w"> </span><span class="s1">&#39;*tools/bpf&#39;</span><span class="p">)</span>
<span class="n">make</span><span class="w"> </span><span class="n">all</span>
<span class="n">cp</span><span class="w"> </span><span class="n">bpf_asm</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/.</span>
<span class="n">cp</span><span class="w"> </span><span class="n">bpf_dbg</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/.</span>
<span class="n">cp</span><span class="w"> </span><span class="n">bpf_jit_disasm</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/.</span>
<span class="n">cp</span><span class="w"> </span><span class="n">bpftool</span><span class="o">/</span><span class="n">bpftool</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/.</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="building-bytecode">Building bytecode</h4>
<p>Now, create the following bpf asm instructions:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> cat &lt;&lt;&#39;EOF&#39; &gt; test.bpf 
     ldh [22]
     jneq #0x1f90, lb_1
     ret #1

lb_1:
     ret #0
EOF
</code></pre></div></td></tr></table></div></p>
<p>And compile it to bytecode with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> bpf_asm test.bpf 
4,40 0 0 36,21 0 1 8080,6 0 0 1,6 0 0 0,
</code></pre></div></td></tr></table></div></p>
<p>As earlier, we can test this with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh">#</span> python3 -m http.server 8080 &gt;/dev/null 2&gt;&amp;1 &amp;
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
200
<span class="gh">#</span> iptables -I INPUT -m bpf --bytecode &quot;$(bpf_asm test.bpf)&quot; -j REJECT
<span class="gh">#</span> curl -s -o /dev/null -w &quot;%{http_code}&quot; 127.0.0.1:8080
000
<span class="gh">#</span> iptables -L INPUT -nv --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1        2   120 REJECT     all  --  <span class="gs">*      *</span>       0.0.0.0/0            0.0.0.0/0           match bpf 40 0 0 22,21 0 1 8080,6 0 0 1,6 0 0 0 reject-with icmp-port-unreachable
</code></pre></div></td></tr></table></div></p>
<p>For further details about the assembly language, see the <a href="https://www.kernel.org/doc/Documentation/networking/filter.txt" target="_blank">kernel documentation</a>.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 18, 2022</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.prune", "navigation.top", "navigation.path", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>