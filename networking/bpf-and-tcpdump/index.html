
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>BPF and tcpdump - Andreas Karis Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="red">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tcpdump-expressions-and-bpf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Andreas Karis Blog" class="md-header__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Andreas Karis Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BPF and tcpdump
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Andreas Karis Blog" class="md-nav__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Andreas Karis Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Ceph
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ceph" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Ceph
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph-manual-test/" class="md-nav__link">
        Ceph manual test with qemu
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Containers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        cgroups
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        Containers in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/list_docker_registry_containers/" class="md-nav__link">
        List container images in registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        namespaces
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        cgroups
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        Containers in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/java-idrac-issues/" class="md-nav__link">
        Java Idrac Issues
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/hugepages/" class="md-nav__link">
        Hugepages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/meson/" class="md-nav__link">
        meson
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        namespaces
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/old_java_version_with_xorgs_in_container/" class="md-nav__link">
        Old Java inside a container with xorgs
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        Networking
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../arp_and_the_neighbor_table/" class="md-nav__link">
        ARP and the Neighbor table
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          BPF and tcpdump
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        BPF and tcpdump
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcpdump-expressions-and-bpf" class="md-nav__link">
    tcpdump expressions and BPF
  </a>
  
    <nav class="md-nav" aria-label="tcpdump expressions and BPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcpdumps-inconsistent-bpf-expression-compiler" class="md-nav__link">
    tcpdump's inconsistent BPF expression compiler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source-code-analysis" class="md-nav__link">
    Source code analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-filter-expression-compiler" class="md-nav__link">
    Building a filter expression compiler
  </a>
  
    <nav class="md-nav" aria-label="Building a filter expression compiler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documentation" class="md-nav__link">
    Documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-dependencies" class="md-nav__link">
    Installing dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-code" class="md-nav__link">
    Creating the code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiling-the-code" class="md-nav__link">
    Compiling the code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-the-tool" class="md-nav__link">
    Using the tool
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-bpf" class="md-nav__link">
    Using BPF
  </a>
  
    <nav class="md-nav" aria-label="Using BPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compile-bpf-kernel-tools" class="md-nav__link">
    Compile BPF kernel tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sniffing-traffic-with-golang" class="md-nav__link">
    Sniffing traffic with golang
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../bonding_in_linux/" class="md-nav__link">
        Bonding in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../juniper_x520/" class="md-nav__link">
        Configure Juniper switch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../haproxy-and-h2c/" class="md-nav__link">
        haproxy and HTTP/2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../geneve_tunneling/" class="md-nav__link">
        Geneve tunneling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../netlink/" class="md-nav__link">
        Netlink
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovn-kind/" class="md-nav__link">
        OVN kind
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovn_standalone_on_fedora31/" class="md-nav__link">
        OVN standalone on Fedora 31
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovs_recirculation/" class="md-nav__link">
        OVS packet recirculation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovs-vxlan-tunnels-and-dscp/" class="md-nav__link">
        OVS VXLAN tunnels and DSCP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovs_with_gdb/" class="md-nav__link">
        OVS with GDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../wireguard/" class="md-nav__link">
        Wireguard
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        OpenShift
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OpenShift" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          OpenShift
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/alertmanager/" class="md-nav__link">
        AlertManager
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/cpu-manager-with-custom-machine-config-pool/" class="md-nav__link">
        CPU manager with custom MachineConfigPool
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/crio-conmon-runc/" class="md-nav__link">
        Crio vs conmon vs runc
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/etcd_perf/" class="md-nav__link">
        Etcd Performance tests
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_httpbin_tshark_sidecar/" class="md-nav__link">
        Httpbin tshark sidecar container
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kubernetes_cluster/" class="md-nav__link">
        Hints for installing kubernetes on Fedora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/HPA/" class="md-nav__link">
        Horizontal Pod Autoscaler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/how_rhcos_updates_work/" class="md-nav__link">
        How RHCOS updates work
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ocp4-infra-nodes-with-machineset-without-worker-label/" class="md-nav__link">
        Infra nodes with MachineSets without worker label
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ingresscontroller_router_sharding_ocp_on_osp/" class="md-nav__link">
        Ingress Controller Sharding OCP on OSP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/ingress-controller-sharding-on-separate-vip/" class="md-nav__link">
        Ingress Controller Sharding on separate VIP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_mirror_registry/" class="md-nav__link">
        Installing a cluster with a mirror registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/istio-1.6-on-ocp.4.x/" class="md-nav__link">
        Istio 1.6 on OpenShift 4.x
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kata/" class="md-nav__link">
        kata containers and the kata operatora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/kind-with-private-registry/" class="md-nav__link">
        Kind with private registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/mounting-container-image/" class="md-nav__link">
        Mount a container image
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/install_openshift_on_openstack/" class="md-nav__link">
        OpenShift on OpenStack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/private-registry/" class="md-nav__link">
        Private container registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/proxy-ocp-4.5/" class="md-nav__link">
        Proxy OCP 4.5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/scc/" class="md-nav__link">
        Security Context Constraints (SCC)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/fix-selinux-labels-coreos/" class="md-nav__link">
        SElinux labels fix
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/openshift_troubleshooting_etcd_state/" class="md-nav__link">
        Troubleshooting etcd state
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/useful-ocp-curl/" class="md-nav__link">
        Querying the OCP 4.x upgrades info API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openshift/troubleshooting_openshift_on_openstack_worker_creation/" class="md-nav__link">
        Troubleshooting OpenShift on OpenStack worker creation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        OpenStack
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OpenStack" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          OpenStack
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/reattach_to_running_deployment/" class="md-nav__link">
        Reattach to running deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/using_clouds_yaml/" class="md-nav__link">
        Using clouds.yaml
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        OperatorSDK
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OperatorSDK" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          OperatorSDK
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../operator-sdk/operator-sdk-reconciliation/" class="md-nav__link">
        Controller Reconciliation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>BPF and tcpdump</h1>
                
                <h2 id="tcpdump-expressions-and-bpf">tcpdump expressions and BPF</h2>
<h3 id="introduction">Introduction</h3>
<p>For a good introduction into tcpdump's BPF compiler, look at the following blog post, then come back here:</p>
<ul>
<li><a href="https://blog.cloudflare.com/bpf-the-forgotten-bytecode/">https://blog.cloudflare.com/bpf-the-forgotten-bytecode/</a></li>
</ul>
<h3 id="tcpdumps-inconsistent-bpf-expression-compiler">tcpdump's inconsistent BPF expression compiler</h3>
<p>Now that you have a good idea about this, let's look at how tcpdump compiles the following filter expression:</p>
<pre><code>icmp
</code></pre>

<p>This will be straight forward:</p>
<pre><code>[root@host ~]# tcpdump -i lo icmp -d
(000) ldh      [12]
(001) jeq      #0x800           jt 2    jf 5
(002) ldb      [23]
(003) jeq      #0x1             jt 4    jf 5
(004) ret      #262144
(005) ret      #0
</code></pre>

<p>We'd also expect this to be the same if we look at a file capture:</p>
<pre><code>[root@host ~]# timeout 1 tcpdump -i lo -w lo.pcap
dropped privs to tcpdump
tcpdump: listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
0 packets captured
6 packets received by filter
0 packets dropped by kernel
[root@host ~]# tcpdump -r lo.pcap icmp -d
reading from file lo.pcap, link-type EN10MB (Ethernet)
(000) ldh      [12]
(001) jeq      #0x800           jt 2    jf 5             # &lt;---- ethertype for IP
(002) ldb      [23]
(003) jeq      #0x1             jt 4    jf 5             # &lt;---- IP protocol number for ICMP
(004) ret      #262144
(005) ret      #0
</code></pre>

<p>So far, so good and straight forward. We look at byte 23 and check if the IP protocol number is 1. Before that, we check the ethernet header in byte 12 and make sure that we are using IP.</p>
<p>But what happens if we use this expression?</p>
<pre><code>vlan
</code></pre>

<p>We'd expect to look into byte 12 of the ethernet header and make sure that we have the ethertype for 802.1q there. So we'd want to see 0x8100 and if we look for Q-in-Q we'd look for 0x88A8 and for double tagging we'd also look for 0x9100:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/EtherType">https://en.wikipedia.org/wiki/EtherType</a></li>
</ul>
<p>And if we apply the filter to our previously captured file, this is precisely what happens:</p>
<pre><code>[root@host ~]# tcpdump -r lo.pcap vlan -d
reading from file lo.pcap, link-type EN10MB (Ethernet)
(000) ldh      [12]
(001) jeq      #0x8100          jt 4    jf 2
(002) jeq      #0x88a8          jt 4    jf 3
(003) jeq      #0x9100          jt 4    jf 5
(004) ret      #262144
(005) ret      #0
</code></pre>

<p>Now, let's look at a live capture from the loopback interface. We should expect the same expression:</p>
<pre><code>[root@host ~]# tcpdump -i lo vlan -d
(000) ldb      [-4048]
(001) jeq      #0x1             jt 6    jf 2
(002) ldh      [12]
(003) jeq      #0x8100          jt 6    jf 4
(004) jeq      #0x88a8          jt 6    jf 5
(005) jeq      #0x9100          jt 6    jf 7
(006) ret      #262144
(007) ret      #0
</code></pre>

<p>The expression is different now! Why is that? Well, the kernel has an internal optimization and will actually store VLAN information in a location with negative offset.</p>
<p>For example, let's look for VLAN 32 (0x20):</p>
<pre><code>[root@host ~]# tcpdump -r lo.pcap vlan 32 -d
reading from file lo.pcap, link-type EN10MB (Ethernet)
(000) ldh      [12]                                  # &lt;---- look for dot1q, etc. at byte 12
(001) jeq      #0x8100          jt 4    jf 2
(002) jeq      #0x88a8          jt 4    jf 3
(003) jeq      #0x9100          jt 4    jf 8
(004) ldh      [14]
(005) and      #0xfff                                # &lt;---- extract the last 12 bits from the field (VID)
(006) jeq      #0x20            jt 7    jf 8         # &lt;---- check for VLAN 32
(007) ret      #262144
(008) ret      #0
</code></pre>

<p>That, too, makes sense. But if we do a live capture, the logic becomes more complex:</p>
<pre><code>[root@host ~]# tcpdump -i lo vlan 32 -d
(000) ldb      [-4048]
(001) jeq      #0x1             jt 6    jf 2       # &lt;---- does the kernel special field report this as a VLAN?
(002) ldh      [12]                                # &lt;---- otherwise fallback and check the on-wire format as above
(003) jeq      #0x8100          jt 6    jf 4
(004) jeq      #0x88a8          jt 6    jf 5
(005) jeq      #0x9100          jt 6    jf 14
(006) ldb      [-4048]                             # &lt;---- does the kernel special field report this as a VLAN?
(007) jeq      #0x1             jt 8    jf 10
(008) ldb      [-4052]
(009) ja       11
(010) ldh      [14]
(011) and      #0xfff
(012) jeq      #0x20            jt 13   jf 14      # &lt;---- look for VLAN 32 as earlier
(013) ret      #262144
(014) ret      #0
</code></pre>

<h3 id="source-code-analysis">Source code analysis</h3>
<p>Let's look at how tcpdump (by means of libpcap) compiles its expressions into the appropriate BPF bytecode.</p>
<p>tcpdump will compile different types of BPF depending on if the optimization flag is set but also particularly depending on if we open a file for reading or if we run a live capture.</p>
<p>The <code>-r</code> parameter is read here:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1759">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L1759</a></li>
</ul>
<pre><code>        case 'r':
            RFileName = optarg;
            break;
</code></pre>

<p>Opening a file for reading:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2053">https://github.com/the-tcpdump-group/tcpdump/blob/8281c4ae6e7e01524d20dd69b2275d0ed7949216/tcpdump.c#L2053</a></li>
</ul>
<p>This is done here:</p>
<pre><code>        pd = pcap_open_offline_with_tstamp_precision(RFileName,
            ndo-&gt;ndo_tstamp_precision, ebuf);
</code></pre>

<p>(... TBD ...)</p>
<h3 id="building-a-filter-expression-compiler">Building a filter expression compiler</h3>
<h4 id="documentation">Documentation</h4>
<p>In order to build a filter expressioin compiler, we look at the source code:</p>
<ul>
<li><a href="https://github.com/the-tcpdump-group/tcpdump/blob/master/tcpdump.c#L2238">https://github.com/the-tcpdump-group/tcpdump/blob/master/tcpdump.c#L2238</a></li>
</ul>
<p>And at this documentation here:</p>
<ul>
<li><a href="https://www.tcpdump.org/pcap.html">https://www.tcpdump.org/pcap.html</a></li>
</ul>
<h4 id="installing-dependencies">Installing dependencies</h4>
<p>Install build dependencies:</p>
<pre><code>subscription-manager repos --enable=codeready-builder-for-rhel-8-x86_64-rpms 
yum install libpcap-devel -y
</code></pre>

<h4 id="creating-the-code">Creating the code</h4>
<p>Now, create the following code:</p>
<pre><code>cat &lt;&lt;'EOF' &gt; libpcap_expression_compiler.c
// From:
// https://github.com/the-tcpdump-group/tcpdump/blob/master/tcpdump.c#L2238
// https://www.tcpdump.org/pcap.html

// #include &lt;pcap.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pcap.h&gt;

/*
 * Concatenate all input arguments into a long string
 */
char * concat_args(int argc, char **argv) {
    char * arg_string;
    int len;

        for(int i=1; i&lt;argc; i++) {
            len += strlen(argv[i]);
        }
        arg_string = (char *)malloc(len+argc-1);

    for (int i=1; i &lt; argc; i++) {
        if(i != 1) {
            arg_string = strcat(arg_string, &quot; &quot;);
        }
        arg_string = strcat(arg_string, argv[i]);
    }

    return arg_string;
}

int main(int argc, char **argv) {
    pcap_t *handle;
    char dev[] = &quot;lo&quot;;
    char errbuf[PCAP_ERRBUF_SIZE];
    struct bpf_program fcode;
    bpf_u_int32 localnet = 0, netmask = 0;
    int Oflag = 1;

    char * filter_exp = concat_args(argc, argv);
    if(argc &lt;= 1) {
        fprintf(stderr, &quot;Empty filter expression\n&quot;);
        exit(1);
    }
    printf(&quot;Compiling expression '%s'\n\n&quot;, filter_exp);

    if (pcap_lookupnet(dev, &amp;localnet, &amp;netmask, errbuf) == -1) {
        fprintf(stderr, &quot;Can't get netmask for device %s\n&quot;, dev);
        localnet = 0;
        netmask = 0;
    }
    handle = pcap_open_live(dev, BUFSIZ, 1, 1000, errbuf);
    if (handle == NULL) {
        fprintf(stderr, &quot;Couldn't open device %s: %s\n&quot;, dev, errbuf);
        return(2);
    }
    if (pcap_compile(handle, &amp;fcode, filter_exp, Oflag, netmask) &lt; 0) {
        fprintf(stderr, &quot;Couldn't parse filter %s: %s\n&quot;, filter_exp, pcap_geterr(handle));
         return(2);
    }

    printf(&quot;*** Dump compiled packet-matching code (-d) ***\n\n&quot;);
    bpf_dump(&amp;fcode, 1);
    printf(&quot;\n*** Dump packet-matching code as a C program fragment (-dd) ***\n\n&quot;);
    bpf_dump(&amp;fcode, 2);
    printf(&quot;\n*** Dump packet-matching code as decimal numbers (-ddd) ***\n\n&quot;);
    bpf_dump(&amp;fcode, 3);

    pcap_close(handle);
    free(filter_exp);
    pcap_freecode(&amp;fcode);

    exit(0);
}
EOF
</code></pre>

<h4 id="compiling-the-code">Compiling the code</h4>
<p>And compile it:</p>
<pre><code>gcc libpcap_expression_compiler.c -o libpcap_expression_compiler -lpcap
</code></pre>

<h4 id="using-the-tool">Using the tool</h4>
<p>The tool will now produce the same output as tcpdump with the <code>-d</code>, <code>-dd</code> or <code>-ddd</code> flag set:</p>
<pre><code># ./libpcap_expression_compiler vlan 32
Compiling expression 'vlan 32'

*** Dump compiled packet-matching code (-d) ***

(000) ldb      [-4048]
(001) jeq      #0x1             jt 6    jf 2
(002) ldh      [12]
(003) jeq      #0x8100          jt 6    jf 4
(004) jeq      #0x88a8          jt 6    jf 5
(005) jeq      #0x9100          jt 6    jf 14
(006) ldb      [-4048]
(007) jeq      #0x1             jt 8    jf 10
(008) ldb      [-4052]
(009) ja       11
(010) ldh      [14]
(011) and      #0xfff
(012) jeq      #0x20            jt 13   jf 14
(013) ret      #8192
(014) ret      #0

*** Dump packet-matching code as a C program fragment (-dd) ***

{ 0x30, 0, 0, 0xfffff030 },
{ 0x15, 4, 0, 0x00000001 },
{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 2, 0, 0x00008100 },
{ 0x15, 1, 0, 0x000088a8 },
{ 0x15, 0, 8, 0x00009100 },
{ 0x30, 0, 0, 0xfffff030 },
{ 0x15, 0, 2, 0x00000001 },
{ 0x30, 0, 0, 0xfffff02c },
{ 0x5, 0, 0, 0x00000001 },
{ 0x28, 0, 0, 0x0000000e },
{ 0x54, 0, 0, 0x00000fff },
{ 0x15, 0, 1, 0x00000020 },
{ 0x6, 0, 0, 0x00002000 },
{ 0x6, 0, 0, 0x00000000 },

*** Dump packet-matching code as decimal numbers (-ddd) ***

15
48 0 0 4294963248
21 4 0 1
40 0 0 12
21 2 0 33024
21 1 0 34984
21 0 8 37120
48 0 0 4294963248
21 0 2 1
48 0 0 4294963244
5 0 0 1
40 0 0 14
84 0 0 4095
21 0 1 32
6 0 0 8192
6 0 0 0
</code></pre>

<h2 id="using-bpf">Using BPF</h2>
<ul>
<li><a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">https://www.kernel.org/doc/Documentation/networking/filter.txt</a></li>
<li><a href="https://github.com/torvalds/linux/tree/master/tools/bpf">https://github.com/torvalds/linux/tree/master/tools/bpf</a></li>
</ul>
<h3 id="compile-bpf-kernel-tools">Compile BPF kernel tools</h3>
<p>Install build dependencies:</p>
<pre><code>yum install '@Development Tools' -y
yum install gcc-toolset -y
yum install binutils-devel -y
 yum install readline-devel -y
yum install elfutils-libelf-devel -y
 yum install clang -y
yum install llvm -y
</code></pre>

<p>Get the kernel source code on RHEL / CentOS:</p>
<pre><code>mkdir -p kernel/src
cd kernel/
yumdownloader --source kernel
cp kernel-*.src.rpm src/ ; cd src ; rpm2cpio kernel-*.src.rpm | cpio -idmv
tar -xf linux-*.tar.xz
</code></pre>

<p>Compile the BPF toolset:</p>
<pre><code>cd kernel-*/tools/bpf
make all
cp bpf_asm /usr/local/bin/.
cp bpf_dbg /usr/local/bin/.
cp bpf_jit_disasm /usr/local/bin/.
cp bpftool/bpftool /usr/local/bin/.
</code></pre>

<p>(... TBD ...)</p>
<h2 id="sniffing-traffic-with-golang">Sniffing traffic with golang</h2>
<ul>
<li><a href="https://itnext.io/sniffing-creds-with-go-a-journey-with-libpcap-73bc3e74966">https://itnext.io/sniffing-creds-with-go-a-journey-with-libpcap-73bc3e74966</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../arp_and_the_neighbor_table/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              ARP and the Neighbor table
            </div>
          </div>
        </a>
      
      
        <a href="../bonding_in_linux/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Bonding in Linux
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>