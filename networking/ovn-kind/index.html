<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>OVN kind - Andreas Karis Blog</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Andreas Karis Blog</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Ceph <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ceph/ceph-manual-test/" class="dropdown-item">Ceph manual test with qemu</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Containers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../linux/cgroups/" class="dropdown-item">cgroups</a>
</li>
                                    
<li>
    <a href="../../linux/containers/" class="dropdown-item">Containers in Linux</a>
</li>
                                    
<li>
    <a href="../../openshift/list_docker_registry_containers/" class="dropdown-item">List container images in registry</a>
</li>
                                    
<li>
    <a href="../../linux/namespaces/" class="dropdown-item">namespaces</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Linux <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../linux/cgroups/" class="dropdown-item">cgroups</a>
</li>
                                    
<li>
    <a href="../../linux/containers/" class="dropdown-item">Containers in Linux</a>
</li>
                                    
<li>
    <a href="../../linux/hugepages/" class="dropdown-item">Hugepages</a>
</li>
                                    
<li>
    <a href="../../linux/meson/" class="dropdown-item">meson</a>
</li>
                                    
<li>
    <a href="../../linux/namespaces/" class="dropdown-item">namespaces</a>
</li>
                                    
<li>
    <a href="../../linux/old_java_version_with_xorgs_in_container/" class="dropdown-item">Old Java inside a container with xorgs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Networking <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../arp_and_the_neighbor_table/" class="dropdown-item">ARP and the Neighbor table</a>
</li>
                                    
<li>
    <a href="../bonding_in_linux/" class="dropdown-item">Bonding in Linux</a>
</li>
                                    
<li>
    <a href="../geneve_tunneling/" class="dropdown-item">Geneve tunneling</a>
</li>
                                    
<li>
    <a href="../juniper_x520/" class="dropdown-item">Configure Juniper switch</a>
</li>
                                    
<li>
    <a href="../netlink/" class="dropdown-item">Netlink</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">OVN kind</a>
</li>
                                    
<li>
    <a href="../ovn_standalone_on_fedora31/" class="dropdown-item">OVN standalone on Fedora 31</a>
</li>
                                    
<li>
    <a href="../ovs_recirculation/" class="dropdown-item">OVS packet recirculation</a>
</li>
                                    
<li>
    <a href="../ovs-vxlan-tunnels-and-dscp/" class="dropdown-item">OVS VXLAN tunnels and DSCP</a>
</li>
                                    
<li>
    <a href="../ovs_with_gdb/" class="dropdown-item">OVS with GDB</a>
</li>
                                    
<li>
    <a href="../sctp/" class="dropdown-item">SCTP</a>
</li>
                                    
<li>
    <a href="../wireguard/" class="dropdown-item">Wireguard</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">OpenShift <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../openshift/alertmanager/" class="dropdown-item">AlertManager</a>
</li>
                                    
<li>
    <a href="../../openshift/cpu-manager-with-custom-machine-config-pool/" class="dropdown-item">CPU manager with custom MachineConfigPool</a>
</li>
                                    
<li>
    <a href="../../openshift/crio-conmon-runc/" class="dropdown-item">Crio vs conmon vs runc</a>
</li>
                                    
<li>
    <a href="../../openshift/openshift_httpbin_tshark_sidecar/" class="dropdown-item">Httpbin tshark sidecar container</a>
</li>
                                    
<li>
    <a href="../../openshift/kubernetes_cluster/" class="dropdown-item">Hints for installing kubernetes on Fedora</a>
</li>
                                    
<li>
    <a href="../../openshift/ocp4-infra-nodes-with-machineset-without-worker-label/" class="dropdown-item">Infra nodes with MachineSets without worker label</a>
</li>
                                    
<li>
    <a href="../../openshift/ingresscontroller_router_sharding_ocp_on_osp/" class="dropdown-item">Ingress Controller Sharding OCP on OSP</a>
</li>
                                    
<li>
    <a href="../../openshift/ingress-controller-sharding-on-separate-vip/" class="dropdown-item">Ingress Controller Sharding on separate VIP</a>
</li>
                                    
<li>
    <a href="../../openshift/openshift_mirror_registry/" class="dropdown-item">Installing a cluster with a mirror registry</a>
</li>
                                    
<li>
    <a href="../../openshift/istio-1.6-on-ocp.4.x/" class="dropdown-item">Istio 1.6 on OpenShift 4.x</a>
</li>
                                    
<li>
    <a href="../../openshift/kata/" class="dropdown-item">kata containers and the kata operatora</a>
</li>
                                    
<li>
    <a href="../../openshift/proxy-ocp-4.5/" class="dropdown-item">Proxy OCP 4.5</a>
</li>
                                    
<li>
    <a href="../../openshift/scc/" class="dropdown-item">Security Context Constraints (SCC)</a>
</li>
                                    
<li>
    <a href="../../openshift/fix-selinux-labels-coreos/" class="dropdown-item">SElinux labels fix</a>
</li>
                                    
<li>
    <a href="../sctp/" class="dropdown-item">SCTP</a>
</li>
                                    
<li>
    <a href="../../openshift/openshift_troubleshooting_etcd_state/" class="dropdown-item">Troubleshooting etcd state</a>
</li>
                                    
<li>
    <a href="../../openshift/useful-ocp-curl/" class="dropdown-item">Querying the OCP 4.x upgrades info API</a>
</li>
                                    
<li>
    <a href="../../openshift/troubleshooting_openshift_on_openstack_worker_creation/" class="dropdown-item">Troubleshooting OpenShift on OpenStack worker creation</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">OpenStack <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../openstack/reattach_to_running_deployment/" class="dropdown-item">Reattach to running deployment</a>
</li>
                                    
<li>
    <a href="../../openstack/using_clouds_yaml/" class="dropdown-item">Using clouds.yaml</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../netlink/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ovn_standalone_on_fedora31/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ovn-kind-and-the" class="nav-link">OVN kind and the</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#sources" class="nav-link">Sources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ovn-kind-and-the">OVN kind and the</h1>
<h2 id="sources">Sources</h2>
<p>Based on:</p>
<ul>
<li>
<p><a href="https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/kind.md">https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/kind.md</a></p>
</li>
<li>
<p><a href="https://github.com/ovn-org/ovn-kubernetes">https://github.com/ovn-org/ovn-kubernetes</a></p>
</li>
</ul>
<p>And most instructions are from my colleagues Tim Rozet and Robin Cernin.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Spawn a RHEL 7.8 or above virtual machine and install:</p>
<pre><code>yum install docker -y
yum install python3 -y
yum install git -y
yum install python3-pip -y
python3 -m pip install j2cli
sudo update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1
curl -O https://golang.org/dl/go1.14.6.linux-amd64.tar.gz -L
tar -C /usr/local -xzf go1.14.6.linux-amd64.tar.gz
cat &lt;&lt;'EOF' | tee /etc/profile.d/go.sh
#!/bin/bash

export PATH=$PATH:/usr/local/go/bin
EOF
chmod +x /etc/profile.d/go.sh
source  /etc/profile.d/go.sh
</code></pre>

<p>Download kind:</p>
<pre><code>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.8.1/kind-linux-amd64
chmod +x ./kind
</code></pre>

<blockquote>
<p>For further details, see https://kind.sigs.k8s.io/docs/user/quick-start/</p>
</blockquote>
<p>Download ovn-kubernetes:</p>
<pre><code>git clone https://github.com/ovn-org/ovn-kubernetes
cd ovn-kubernetes/contrib/
</code></pre>

<p>Now, run:</p>
<pre><code>./kind.sh -ho
</code></pre>

<p>Wait until it finishes.</p>
<p>Now, go to the home folder and generate kubeconfig:</p>
<pre><code>cd ~
kind get kubeconfig --name ovn &gt; .kube/config
</code></pre>

<p>Verify:</p>
<pre><code> kubectl  get nodes
NAME                STATUS   ROLES    AGE   VERSION
ovn-control-plane   Ready    master   15m   v1.18.2
ovn-worker          Ready    &lt;none&gt;   14m   v1.18.2
ovn-worker2         Ready    &lt;none&gt;   14m   v1.18.2
</code></pre>

<p>Get your Worker node IPs:</p>
<pre><code># kubectl  get nodes -o wide
NAME                STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION                 CONTAINER-RUNTIME
ovn-control-plane   Ready    master   15m   v1.18.2   172.18.0.4    &lt;none&gt;        Ubuntu 20.04 LTS   4.18.0-193.13.2.el8_2.x86_64   containerd://1.3.3-14-g449e9269
ovn-worker          Ready    &lt;none&gt;   15m   v1.18.2   172.18.0.3    &lt;none&gt;        Ubuntu 20.04 LTS   4.18.0-193.13.2.el8_2.x86_64   containerd://1.3.3-14-g449e9269
ovn-worker2         Ready    &lt;none&gt;   15m   v1.18.2   172.18.0.2    &lt;none&gt;        Ubuntu 20.04 LTS   4.18.0-193.13.2.el8_2.x86_64   containerd://1.3.3-14-g449e9269
</code></pre>

<p>Get the worker pod subnets:</p>
<pre><code>[root@kind ~]# kubectl get nodes | tail -n +2 | awk '{print $1}' | while read node; do echo === $node === ; kubectl describe node $node | grep PodCIDR ; done
=== ovn-control-plane ===
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
=== ovn-worker ===
PodCIDR:                      10.244.1.0/24
PodCIDRs:                     10.244.1.0/24
=== ovn-worker2 ===
PodCIDR:                      10.244.2.0/24
PodCIDRs:                     10.244.2.0/24
</code></pre>

<p>Create CentOS to act as GW:</p>
<pre><code>docker run --name gw -d --privileged --network kind -it centos /bin/bash
</code></pre>

<p>Now connecto to the GW node:</p>
<pre><code>docker exec -it gw /bin/bash
</code></pre>

<p>If your worker node IPs and pod subnets are different from what was listed above, make sure to adjust the following.
It's important to route traffic for the node's pod subnet via the node's internal IP.</p>
<pre><code>cat &lt;&lt;'EOF' | tee vxlan.sh
#!/bin/bash

echo &quot;VIP&quot;
ip add a 9.0.0.1 dev lo

echo &quot;ovn-workers&quot;
# https://joejulian.name/post/how-to-configure-linux-vxlans-with-multiple-unicast-endpoints/
ip link add vxlan0 type vxlan dev eth0 id 4097 dstport 4789       
bridge fdb append to 00:00:00:00:00:00 dst 172.18.0.3 dev vxlan0
bridge fdb append to 00:00:00:00:00:00 dst 172.18.0.2 dev vxlan0
ip route add 10.244.0.0/16 dev vxlan0
EOF
chmod +x vxlan.sh
./vxlan.sh
</code></pre>

<p>Now create a namespace with annotations like:</p>
<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: exgw2
  annotations:
    k8s.ovn.org/hybrid-overlay-external-gw: 9.0.0.1
    k8s.ovn.org/hybrid-overlay-vtep: 172.18.0.5 #replace this with your simulated  ip
</code></pre>

<p>Execute:</p>
<pre><code>kubectl apply -f file.yaml
</code></pre>

<p>Now create pods on each worker node in the namespace:</p>
<pre><code>cat &lt;&lt;'EOF' | oc apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: dnsutils
  namespace: exgw2
spec:
  containers:
  - name: dnsutils01
    image: gcr.io/kubernetes-e2e-test-images/dnsutils:1.3
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
  nodeName: ovn-worker
---
apiVersion: v1
kind: Pod
metadata:
  name: dnsutils02
  namespace: exgw2
spec:
  containers:
  - name: dnsutils
    image: gcr.io/kubernetes-e2e-test-images/dnsutils:1.3
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
  nodeName: ovn-worker2
EOF
</code></pre>

<p>Execute:</p>
<pre><code>[root@kind ~]# kubectl  get pods -n exgw2 -o wide
NAME         READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES
dnsutils     1/1     Running   0          20m   10.244.0.7   ovn-worker    &lt;none&gt;           &lt;none&gt;
dnsutils02   1/1     Running   0          20m   10.244.2.6   ovn-worker2   &lt;none&gt;           &lt;none&gt;
</code></pre>

<p>Verify from the pods:</p>
<pre><code>[root@kind ~]# kubectl exec -it dnsutils02 /bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.
/ # ping 9.0.0.1
PING 9.0.0.1 (9.0.0.1): 56 data bytes
64 bytes from 9.0.0.1: seq=0 ttl=64 time=0.998 ms
^C
--- 9.0.0.1 ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 0.998/0.998/0.998 ms
/ # 
</code></pre>

<pre><code>[root@kind ~]# kubectl exec -it dnsutils /bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.
/ # ping 9.0.0.1
PING 9.0.0.1 (9.0.0.1): 56 data bytes
64 bytes from 9.0.0.1: seq=0 ttl=64 time=1.686 ms
64 bytes from 9.0.0.1: seq=1 ttl=64 time=0.667 ms
^C
--- 9.0.0.1 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.667/1.176/1.686 ms
/ # 
</code></pre>

<p>Verify the HybridOverlay is enabled in NS:</p>
<pre><code># kubectl get ns exgw2 -o yaml
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    k8s.ovn.org/hybrid-overlay-external-gw: 9.0.0.1
    k8s.ovn.org/hybrid-overlay-vtep: 172.18.0.5
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
