
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>Ingress Controller Sharding on separate VIP - Andreas Karis Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="red">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ingress-controller-sharding-on-separate-vip" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Andreas Karis Blog" class="md-header__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Andreas Karis Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ingress Controller Sharding on separate VIP
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Andreas Karis Blog" class="md-nav__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Andreas Karis Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Ceph
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ceph" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Ceph
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph-manual-test/" class="md-nav__link">
        Ceph manual test with qemu
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Containers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        cgroups
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        Containers in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../list_docker_registry_containers/" class="md-nav__link">
        List container images in registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        namespaces
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        cgroups
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        Containers in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/hugepages/" class="md-nav__link">
        Hugepages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/ipxe-boot-environment/" class="md-nav__link">
        iPXE boot environment on Fedora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/java-idrac-issues/" class="md-nav__link">
        Java Idrac Issues
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/meson/" class="md-nav__link">
        meson
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        namespaces
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/old_java_version_with_xorgs_in_container/" class="md-nav__link">
        Old Java inside a container with xorgs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/get-process-cgroup-info-and-limits/" class="md-nav__link">
        Retrieving process cgroup resource usage and limit info
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/libvirt-uefi-without-secureboot/" class="md-nav__link">
        RHEL Booting a virtual machine with UEFI but without secure boot
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/setting-journalctl-limits/" class="md-nav__link">
        Setting journalctl limits
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Networking
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/arp_and_the_neighbor_table/" class="md-nav__link">
        ARP and the Neighbor table
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/bpf-and-tcpdump/" class="md-nav__link">
        BPF and tcpdump
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/bonding_in_linux/" class="md-nav__link">
        Bonding in Linux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/juniper_x520/" class="md-nav__link">
        Configure Juniper switch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/haproxy-and-h2c/" class="md-nav__link">
        haproxy and HTTP/2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/install-openvswitch-on-rocky/" class="md-nav__link">
        Install Open vSwitch on Rocky Linux 8
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/geneve_tunneling/" class="md-nav__link">
        Geneve tunneling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/netlink/" class="md-nav__link">
        Netlink
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovn_standalone_on_fedora31/" class="md-nav__link">
        OVN standalone on Fedora 31
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs_recirculation/" class="md-nav__link">
        OVS packet recirculation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs-vxlan-tunnels-and-dscp/" class="md-nav__link">
        OVS VXLAN tunnels and DSCP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs_with_gdb/" class="md-nav__link">
        OVS with GDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/wireguard/" class="md-nav__link">
        Wireguard
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      <label class="md-nav__link" for="__nav_6">
        OpenShift
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OpenShift" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          OpenShift
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../alertmanager/" class="md-nav__link">
        AlertManager
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cpu-manager-with-custom-machine-config-pool/" class="md-nav__link">
        CPU manager with custom MachineConfigPool
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../crio-conmon-runc/" class="md-nav__link">
        Crio vs conmon vs runc
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../etcd_perf/" class="md-nav__link">
        Etcd Performance tests
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../get-vs-list-api-calls/" class="md-nav__link">
        Get vs List API Calls
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_httpbin_tshark_sidecar/" class="md-nav__link">
        Httpbin tshark sidecar container
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        Hints for installing kubernetes on Fedora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../HPA/" class="md-nav__link">
        Horizontal Pod Autoscaler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../how_rhcos_updates_work/" class="md-nav__link">
        How RHCOS updates work
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ocp4-infra-nodes-with-machineset-without-worker-label/" class="md-nav__link">
        Infra nodes with MachineSets without worker label
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingresscontroller_router_sharding_ocp_on_osp/" class="md-nav__link">
        Ingress Controller Sharding OCP on OSP
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Ingress Controller Sharding on separate VIP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Ingress Controller Sharding on separate VIP
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-scale-out-by-2-more-worker-nodes" class="md-nav__link">
    Step 1: Scale out by 2 more worker nodes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-add-additional-interface-to-additional-nodes" class="md-nav__link">
    Step 2: Add additional interface to additional nodes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-new-role-and-assign-new-nodes-to-the-role" class="md-nav__link">
    Step 3: create new role and assign new nodes to the role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-configure-keepalived-template-for-the-staging-node" class="md-nav__link">
    Step 4: Configure keepalived template for the staging node
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-configure-an-ingress-use-ingress-controller-sharding" class="md-nav__link">
    Step 5: Configure an Ingress, use Ingress controller sharding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-expose-route" class="md-nav__link">
    Step 6: Expose route
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-security-hardening" class="md-nav__link">
    Step 7: Security hardening
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-troubleshooting" class="md-nav__link">
    Step 8: Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_mirror_registry/" class="md-nav__link">
        Installing a cluster with a mirror registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../istio-1.6-on-ocp.4.x/" class="md-nav__link">
        Istio 1.6 on OpenShift 4.x
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../kata/" class="md-nav__link">
        kata containers and the kata operatora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovn-kind-hybrid-overlay/" class="md-nav__link">
        Kind with OVN Kubernetes Hybrid Overlay
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../kind-with-private-registry/" class="md-nav__link">
        Kind with private registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../mounting-container-image/" class="md-nav__link">
        Mount a container image
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/install_openshift_on_openstack/" class="md-nav__link">
        OpenShift on OpenStack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../private-registry/" class="md-nav__link">
        Private container registry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../proxy-ocp-4.5/" class="md-nav__link">
        Proxy OCP 4.5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../scc/" class="md-nav__link">
        Security Context Constraints (SCC)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../fix-selinux-labels-coreos/" class="md-nav__link">
        SElinux labels fix
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/sctp/" class="md-nav__link">
        SCTP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_troubleshooting_etcd_state/" class="md-nav__link">
        Troubleshooting etcd state
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../useful-ocp-commands/" class="md-nav__link">
        Useful commands for OpenShift
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting_openshift_on_openstack_worker_creation/" class="md-nav__link">
        Troubleshooting OpenShift on OpenStack worker creation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        OpenStack
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OpenStack" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          OpenStack
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/reattach_to_running_deployment/" class="md-nav__link">
        Reattach to running deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/using_clouds_yaml/" class="md-nav__link">
        Using clouds.yaml
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        OperatorSDK
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OperatorSDK" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          OperatorSDK
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../operator-sdk/operator-sdk-reconciliation/" class="md-nav__link">
        Controller Reconciliation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="ingress-controller-sharding-on-separate-vip">Ingress Controller Sharding on separate VIP</h1>
<p>It is important to know that each node can only host one ingress router with <code>HostNetwork</code> networking. You will need a specific role for each INGRESS type and different INGRESS types cannot be hosted on the same worker node. This is due to the particularities of the <code>HostNetwork</code> network type.</p>
<p>The following example uses the OpenStack IPI.</p>
<h2 id="step-1-scale-out-by-2-more-worker-nodes">Step 1: Scale out by 2 more worker nodes</h2>
<p>Scale out the worker role. This step might have to be improved.</p>
<pre><code>[cloud-user@akaris-jump-server cluster-logging]$ oc scale -n openshift-machine-api --replicas=5 machineset akaris-osc-6klvk-worker
machineset.machine.openshift.io/akaris-osc-6klvk-worker scaled
[cloud-user@akaris-jump-server cluster-logging]$ 
</code></pre>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc get nodes
NAME                            STATUS   ROLES    AGE     VERSION
akaris-osc-6klvk-master-0       Ready    master   5h18m   v1.18.3+012b3ec
akaris-osc-6klvk-master-1       Ready    master   5h18m   v1.18.3+012b3ec
akaris-osc-6klvk-master-2       Ready    master   5h19m   v1.18.3+012b3ec
akaris-osc-6klvk-worker-g4q6z   Ready    worker   5h4m    v1.18.3+012b3ec
akaris-osc-6klvk-worker-hp2hz   Ready    worker   2m12s   v1.18.3+012b3ec
akaris-osc-6klvk-worker-l726s   Ready    worker   5h1m    v1.18.3+012b3ec
akaris-osc-6klvk-worker-lp2df   Ready    worker   5h6m    v1.18.3+012b3ec
akaris-osc-6klvk-worker-zhs67   Ready    worker   2m57s   v1.18.3+012b3ec
</code></pre>
<h2 id="step-2-add-additional-interface-to-additional-nodes">Step 2: Add additional interface to additional nodes</h2>
<p>This step will be executed within the underlying infrastructure provider. In this example case, OpenShift is hosted on top of OpenStack.</p>
<p>Make sure that the subnet runs a DHCP server:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ openstack subnet set --dhcp 41c073c0-5b6a-4639-9023-115ce3d0e378
[cloud-user@akaris-jump-server openshift]$ openstack subnet show 41c073c0-5b6a-4639-9023-115ce3d0e378
+-------------------+--------------------------------------+
| Field             | Value                                |
+-------------------+--------------------------------------+
| allocation_pools  | 172.31.254.2-172.31.254.254          |
| cidr              | 172.31.254.0/24                      |
| created_at        | 2020-01-15T17:13:39Z                 |
| description       |                                      |
| dns_nameservers   |                                      |
| enable_dhcp       | True                                 |
| gateway_ip        | 172.31.254.1                         |
| host_routes       |                                      |
| id                | 41c073c0-5b6a-4639-9023-115ce3d0e378 |
| ip_version        | 4                                    |
| ipv6_address_mode | None                                 |
| ipv6_ra_mode      | None                                 |
| name              | akaris-backend-subnet                |
| network_id        | aa68c208-b6c9-402e-b508-1b9d82f3baa4 |
| prefix_length     | None                                 |
| project_id        | ea78dddee3e240c7af1779b417c64618     |
| revision_number   | 1                                    |
| segment_id        | None                                 |
| service_types     |                                      |
| subnetpool_id     | None                                 |
| tags              |                                      |
| updated_at        | 2020-08-11T15:19:17Z                 |
+-------------------+--------------------------------------+
</code></pre>
<p>And create a router that can host floating IPs:</p>
<pre><code>openstack router create akaris-backend
openstack router set --external-gateway 5cd089f9-8ed2-46bc-8ea7-4e1cdb5262ba akaris-backend
openstack router add subnet akaris-backend akaris-backend-subnet
</code></pre>
<pre><code>[cloud-user@akaris-jump-server openshift]$ openstack port create --network aa68c208-b6c9-402e-b508-1b9d82f3baa4 akaris-osc-6klvk-worker-hp2hz-akaris-backend
+-----------------------+------------------------------------------------------------------------------+
| Field                 | Value                                                                        |
+-----------------------+------------------------------------------------------------------------------+
| admin_state_up        | UP                                                                           |
| allowed_address_pairs |                                                                              |
| binding_host_id       | None                                                                         |
| binding_profile       | None                                                                         |
| binding_vif_details   | None                                                                         |
| binding_vif_type      | None                                                                         |
| binding_vnic_type     | normal                                                                       |
| created_at            | 2020-08-11T14:47:17Z                                                         |
| data_plane_status     | None                                                                         |
| description           |                                                                              |
| device_id             |                                                                              |
| device_owner          |                                                                              |
| dns_assignment        | None                                                                         |
| dns_name              | None                                                                         |
| extra_dhcp_opts       |                                                                              |
| fixed_ips             | ip_address='172.31.254.48', subnet_id='41c073c0-5b6a-4639-9023-115ce3d0e378' |
| id                    | 8e737c31-0450-40d0-a5e0-54871a735428                                         |
| ip_address            | None                                                                         |
| mac_address           | fa:16:3e:07:66:12                                                            |
| name                  | akaris-osc-6klvk-worker-hp2hz-akaris-backend                                 |
| network_id            | aa68c208-b6c9-402e-b508-1b9d82f3baa4                                         |
| option_name           | None                                                                         |
| option_value          | None                                                                         |
| port_security_enabled | True                                                                         |
| project_id            | ea78dddee3e240c7af1779b417c64618                                             |
| qos_policy_id         | None                                                                         |
| revision_number       | 6                                                                            |
| security_group_ids    | ae5a722f-aeea-4acd-8260-a04f5dceb624                                         |
| status                | DOWN                                                                         |
| subnet_id             | None                                                                         |
| tags                  |                                                                              |
| trunk_details         | None                                                                         |
| updated_at            | 2020-08-11T14:47:17Z                                                         |
+-----------------------+------------------------------------------------------------------------------+
[cloud-user@akaris-jump-server openshift]$ openstack port create --network aa68c208-b6c9-402e-b508-1b9d82f3baa4 akaris-osc-6klvk-worker-zhs67-akaris-backend
+-----------------------+-------------------------------------------------------------------------------+
| Field                 | Value                                                                         |
+-----------------------+-------------------------------------------------------------------------------+
| admin_state_up        | UP                                                                            |
| allowed_address_pairs |                                                                               |
| binding_host_id       | None                                                                          |
| binding_profile       | None                                                                          |
| binding_vif_details   | None                                                                          |
| binding_vif_type      | None                                                                          |
| binding_vnic_type     | normal                                                                        |
| created_at            | 2020-08-11T14:47:40Z                                                          |
| data_plane_status     | None                                                                          |
| description           |                                                                               |
| device_id             |                                                                               |
| device_owner          |                                                                               |
| dns_assignment        | None                                                                          |
| dns_name              | None                                                                          |
| extra_dhcp_opts       |                                                                               |
| fixed_ips             | ip_address='172.31.254.207', subnet_id='41c073c0-5b6a-4639-9023-115ce3d0e378' |
| id                    | c82401f3-fa76-449e-ba16-75fe4b0f5583                                          |
| ip_address            | None                                                                          |
| mac_address           | fa:16:3e:66:d2:28                                                             |
| name                  | akaris-osc-6klvk-worker-zhs67-akaris-backend                                  |
| network_id            | aa68c208-b6c9-402e-b508-1b9d82f3baa4                                          |
| option_name           | None                                                                          |
| option_value          | None                                                                          |
| port_security_enabled | True                                                                          |
| project_id            | ea78dddee3e240c7af1779b417c64618                                              |
| qos_policy_id         | None                                                                          |
| revision_number       | 6                                                                             |
| security_group_ids    | ae5a722f-aeea-4acd-8260-a04f5dceb624                                          |
| status                | DOWN                                                                          |
| subnet_id             | None                                                                          |
| tags                  |                                                                               |
| trunk_details         | None                                                                          |
| updated_at            | 2020-08-11T14:47:40Z                                                          |
+-----------------------+-------------------------------------------------------------------------------+
[cloud-user@akaris-jump-server openshift]$ openstack port create --network aa68c208-b6c9-402e-b508-1b9d82f3baa4 vip-akaris-backend
+-----------------------+-------------------------------------------------------------------------------+
| Field                 | Value                                                                         |
+-----------------------+-------------------------------------------------------------------------------+
| admin_state_up        | UP                                                                            |
| allowed_address_pairs |                                                                               |
| binding_host_id       | None                                                                          |
| binding_profile       | None                                                                          |
| binding_vif_details   | None                                                                          |
| binding_vif_type      | None                                                                          |
| binding_vnic_type     | normal                                                                        |
| created_at            | 2020-08-11T18:32:53Z                                                          |
| data_plane_status     | None                                                                          |
| description           |                                                                               |
| device_id             |                                                                               |
| device_owner          |                                                                               |
| dns_assignment        | None                                                                          |
| dns_name              | None                                                                          |
| extra_dhcp_opts       |                                                                               |
| fixed_ips             | ip_address='172.31.254.118', subnet_id='41c073c0-5b6a-4639-9023-115ce3d0e378' |
| id                    | 4d0b32f5-203b-4e2b-b92b-b25f349b1d83                                          |
| ip_address            | None                                                                          |
| mac_address           | fa:16:3e:0d:3e:cd                                                             |
| name                  | vip-akaris-backend                                                            |
| network_id            | aa68c208-b6c9-402e-b508-1b9d82f3baa4                                          |
| option_name           | None                                                                          |
| option_value          | None                                                                          |
| port_security_enabled | True                                                                          |
| project_id            | ea78dddee3e240c7af1779b417c64618                                              |
| qos_policy_id         | None                                                                          |
| revision_number       | 6                                                                             |
| security_group_ids    | ae5a722f-aeea-4acd-8260-a04f5dceb624                                          |
| status                | DOWN                                                                          |
| subnet_id             | None                                                                          |
| tags                  |                                                                               |
| trunk_details         | None                                                                          |
| updated_at            | 2020-08-11T18:32:53Z                                                          |
+-----------------------+-------------------------------------------------------------------------------+
[cloud-user@akaris-jump-server openshift]$ openstack server add port akaris-osc-6klvk-worker-hp2hz akaris-osc-6klvk-worker-hp2hz-akaris-backend
[cloud-user@akaris-jump-server openshift]$ openstack server add port akaris-osc-6klvk-worker-zhs67 akaris-osc-6klvk-worker-zhs67-akaris-backend
[cloud-user@akaris-jump-server openshift]$ openstack floating ip set --port akaris-osc-6klvk-worker-hp2hz-akaris-backend 10.0.92.194
[cloud-user@akaris-jump-server openshift]$ openstack floating ip set --port akaris-osc-6klvk-worker-zhs67-akaris-backend 10.0.92.205
[cloud-user@akaris-jump-server openshift]$ openstack floating ip set --port vip-akaris-backend 10.0.89.89
</code></pre>
<p>After this, the floating IPs look like this in OpenStack:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ openstack floating ip list | grep 172.31.254
| dd055cc4-af00-4dbd-8e4a-94fac680299d | 10.0.89.89          | 172.31.254.118   | 4d0b32f5-203b-4e2b-b92b-b25f349b1d83 | 5cd089f9-8ed2-46bc-8ea7-4e1cdb5262ba | ea78dddee3e240c7af1779b417c64618 |
| e586c5c8-1cd4-4bd5-adb7-790e895b5af8 | 10.0.92.194         | 172.31.254.48    | 8e737c31-0450-40d0-a5e0-54871a735428 | 5cd089f9-8ed2-46bc-8ea7-4e1cdb5262ba | ea78dddee3e240c7af1779b417c64618 |
| f7e082f1-7880-4f07-8a05-3fdb0585eb32 | 10.0.92.205         | 172.31.254.207   | c82401f3-fa76-449e-ba16-75fe4b0f5583 | 5cd089f9-8ed2-46bc-8ea7-4e1cdb5262ba | ea78dddee3e240c7af1779b417c64618 |
</code></pre>
<p>Last but not least, disable port security for these ports so that VRRP can work with these OpenStack ports:</p>
<pre><code>for port in akaris-osc-6klvk-worker-hp2hz-akaris-backend akaris-osc-6klvk-worker-zhs67-akaris-backend vip-akaris-backend ; do 
    echo === $port ===
    openstack port set --no-security-group $port
    openstack port set --disable-port-security $port
done
</code></pre>
<p>The VRRP floating IP is: 
   IP 172.31.254.118
   MAC address: fa:16:3e:0d:3e:cd
   VIP: 10.0.89.89</p>
<p>Verify that the port was added to the workers:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc debug node/akaris-osc-6klvk-worker-hp2hz
Starting pod/akaris-osc-6klvk-worker-hp2hz-debug ...
To use host binaries, run `chroot /host`
Pod IP: 192.168.1.160
If you don't see a command prompt, try pressing enter.
sh-4.2# chroot /host
sh-4.4# toolbox
Trying to pull registry.redhat.io/rhel8/support-tools...
Getting image source signatures
Copying blob 77c58f19bd6e done  
Copying blob 47db82df7f3f done  
Copying blob cdc5441bd52d done  
Copying config 5ef2aab094 done  
Writing manifest to image destination
Storing signatures
5ef2aab094514cc5561fa94b0bb52d75379ecf8a36355e891017f3982bac278c
Spawning a container 'toolbox-' with image 'registry.redhat.io/rhel8/support-tools'
Detected RUN label in the container image. Using that as the default...
command: podman run -it --name toolbox- --privileged --ipc=host --net=host --pid=host -e HOST=/host -e NAME=toolbox- -e IMAGE=registry.redhat.io/rhel8/support-tools:latest -v /run:/run -v /var/log:/var/log -v /etc/machine-id:/etc/machine-id -v /etc/localtime:/etc/localtime -v /:/host registry.redhat.io/rhel8/support-tools:latest
[root@akaris-osc-6klvk-worker-hp2hz /]# yum install iproute -y
(...)
Installed:
  iproute-5.3.0-1.el8.x86_64                                 libmnl-1.0.4-6.el8.x86_64                                

Complete!
[root@akaris-osc-6klvk-worker-hp2hz /]# dmesg | tail
[  745.078322] pci 0000:00:06.0: BAR 0: assigned [io  0x1000-0x103f]
[  745.080319] virtio-pci 0000:00:06.0: enabling device (0000 -&gt; 0003)
[  745.100662] PCI Interrupt Link [LNKB] enabled at IRQ 11
[  745.109702] virtio_net virtio3 ens6: renamed from eth0
[  745.156833] IPv6: ADDRCONF(NETDEV_UP): ens6: link is not ready
[  745.159290] IPv6: ADDRCONF(NETDEV_UP): ens6: link is not ready
[  745.165677] IPv6: ADDRCONF(NETDEV_UP): ens6: link is not ready
[  745.172694] IPv6: ADDRCONF(NETDEV_UP): ens6: link is not ready
[  746.143079] IPv6: ADDRCONF(NETDEV_CHANGE): ens6: link becomes ready
[  861.279527] SELinux: mount invalid.  Same superblock, different security settings for (dev mqueue, type mqueue)
[root@akaris-osc-6klvk-worker-hp2hz /]# ip link ls dev ens6
10: ens6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether fa:16:3e:07:66:12 brd ff:ff:ff:ff:ff:ff
</code></pre>
<p>Repeat the same on the other node:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc debug node/akaris-osc-6klvk-worker-zhs67
(...)
</code></pre>
<h2 id="step-3-create-new-role-and-assign-new-nodes-to-the-role">Step 3: create new role and assign new nodes to the role</h2>
<p>Follow <a href="https://www.redhat.com/en/blog/openshift-container-platform-4-how-does-machine-config-pool-work">https://www.redhat.com/en/blog/openshift-container-platform-4-how-does-machine-config-pool-work with modifications</a>.</p>
<p>Run this via a script that's triggered by a systemd unit file:</p>
<pre><code>cat &lt;&lt;'EOF' | oc apply -f -
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: staging
spec:
  machineConfigSelector:
    matchExpressions:
      - {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,staging]}
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/staging: &quot;&quot;
  paused: false
EOF

cat &lt;&lt;'FOE' &gt; network-script.sh
#!/bin/bash

cat &lt;&lt;'EOF' &gt; /etc/sysconfig/network-scripts/ifcfg-ens6
NAME=&quot;System ens6&quot;
BOOTPROTO=dhcp
DEFROUTE=no
IPV6INIT=no
DEVICE=ens6
ONBOOT=yes
EOF

# none of the following will work given that we're using DHCP
# cat &lt;&lt;'EOF' &gt; /etc/sysconfig/network-scripts/rule-ens6
# from 172.31.254.0/24 lookup 5000
# EOF

# cat &lt;&lt;'EOF' &gt; /etc/sysconfig/network-scripts/route-ens6
# default via 172.31.254.1 table 5000
# EOF

# the following will not work either
# ip rule add from 172.31.254.0/24 lookup 5000
# ip route add default via 172.31.254.1 table 5000

cat &lt;&lt;'EOF' &gt; /etc/NetworkManager/dispatcher.d/ifup-local
#!/bin/sh

interface=&quot;$1&quot;
status=&quot;$2&quot;

if [ &quot;$interface&quot; == &quot;ens6&quot; ] &amp;&amp; [ &quot;$status&quot; == &quot;up&quot; ]; then
  logger &quot;Interface $interface $status - setting ip rule and ip route&quot;
  ip rule add from 172.31.254.0/24 lookup 5000
  ip route add default via 172.31.254.1 table 5000
fi
EOF
chmod +x /etc/NetworkManager/dispatcher.d/ifup-local
FOE

cat &lt;&lt;EOF | oc apply -f -
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  creationTimestamp: null
  labels:
    machineconfiguration.openshift.io/role: staging
  name: 01-staging-additional-interface
spec:
  config:
    ignition:
      version: 2.2.0
    storage:
      files:
      - contents:
          source: data:;base64,$(cat network-script.sh | base64 -w 0)
        path: /usr/local/bin/network-script.sh
        filesystem: root
        mode: 0755
    systemd:
      units:
      - contents: &quot;[Unit]\\nDescription=Configure network\\nAfter=ignition-firstboot-complete.service\\nBefore=nodeip-configuration.service kubelet.service crio.service\\n\\n[Service]\\nType=oneshot\\nExecStart=/usr/local/bin/network-script.sh\\n\\n[Install]\\nWantedBy=multi-user.target&quot;
        enabled: true
        name: network-script.service
EOF

rm -f network-script.sh
</code></pre>
<p>Label the nodes as staging:</p>
<pre><code>oc label node akaris-osc-6klvk-worker-hp2hz node-role.kubernetes.io/worker- node-role.kubernetes.io/staging=
oc label node akaris-osc-6klvk-worker-zhs67 node-role.kubernetes.io/worker- node-role.kubernetes.io/staging=
</code></pre>
<p>The nodes will now reboot with the new setting, so wait:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc get nodes
NAME                            STATUS                        ROLES     AGE     VERSION
akaris-osc-6klvk-master-0       Ready                         master    5h48m   v1.18.3+012b3ec
akaris-osc-6klvk-master-1       Ready                         master    5h48m   v1.18.3+012b3ec
akaris-osc-6klvk-master-2       Ready                         master    5h49m   v1.18.3+012b3ec
akaris-osc-6klvk-worker-g4q6z   Ready                         worker    5h34m   v1.18.3+012b3ec
akaris-osc-6klvk-worker-hp2hz   Ready                         staging   32m     v1.18.3+012b3ec
akaris-osc-6klvk-worker-l726s   Ready                         worker    5h31m   v1.18.3+012b3ec
akaris-osc-6klvk-worker-lp2df   Ready                         worker    5h36m   v1.18.3+012b3ec
akaris-osc-6klvk-worker-zhs67   NotReady,SchedulingDisabled   staging   32m     v1.18.3+012b3ec
[cloud-user@akaris-jump-server openshift]$ 
</code></pre>
<p>Make sure that the interface was created:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc debug node/akaris-osc-6klvk-worker-zhs67
Starting pod/akaris-osc-6klvk-worker-zhs67-debug ...
To use host binaries, run `chroot /host`
Pod IP: 192.168.2.48
If you don't see a command prompt, try pressing enter.
sh-4.4# cat /etc/sysconfig/network-scripts/ifcfg-ens6 
NAME=&quot;System ens6&quot;
BOOTPROTO=dhcp
DEFROUTE=no
IPV6INIT=no
DEVICE=ens6
ONBOOT=yes
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
ETHTOOL_OPTS=&quot;-K ens6 tx-checksum-ip-generic off&quot;
IPV4_FAILURE_FATAL=no
UUID=9325ba04-7907-b4a4-1414-177267ba3519
sh-4.2# chroot /host
sh-4.4# ip a ls dev ens6
3: ens6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc fq_codel state UP group default qlen 1000
    link/ether fa:16:3e:66:d2:28 brd ff:ff:ff:ff:ff:ff
    inet 172.31.254.207/24 brd 172.31.254.255 scope global dynamic noprefixroute ens6
       valid_lft 86276sec preferred_lft 86276sec
    inet6 fe80::f816:3eff:fe66:d228/64 scope link 
       valid_lft forever preferred_lft forever
sh-4.4# ip route ls table 5000
default via 172.31.254.1 dev ens6 
sh-4.4# ip rule ls | grep 5000
32765:  from 172.31.254.0/24 lookup 5000
</code></pre>
<p>Run the same verification on the other worker.</p>
<p>Ping both floating IPs and make sure that policy routing works:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ ping 10.0.92.194
PING 10.0.92.194 (10.0.92.194) 56(84) bytes of data.
64 bytes from 10.0.92.194: icmp_seq=1 ttl=62 time=13.8 ms
^C
--- 10.0.92.194 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 13.897/13.897/13.897/0.000 ms
[cloud-user@akaris-jump-server openshift]$ ping 10.0.92.205
PING 10.0.92.205 (10.0.92.205) 56(84) bytes of data.
64 bytes from 10.0.92.205: icmp_seq=1 ttl=62 time=1.24 ms
^C
--- 10.0.92.205 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 1.242/1.242/1.242/0.000 ms
</code></pre>
<h2 id="step-4-configure-keepalived-template-for-the-staging-node">Step 4: Configure keepalived template for the staging node</h2>
<pre><code>cat &lt;&lt;'EOF' &gt; keepalived.conf.tmpl
# TODO: Improve this check. The port is assumed to be alive.
# Need to assess what is the ramification if the port is not there.
vrrp_script chk_ingress {
    script &quot;/usr/bin/curl -o /dev/null -kLfs http://0:1936/healthz&quot;
    interval 1
    weight 50
}
vrrp_instance staging_INGRESS {
    state BACKUP
    interface ens6
    virtual_router_id 100
    priority 40
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass staging_vip
    }
    virtual_ipaddress {
        172.31.254.118/24
    }
    track_script {
        chk_ingress
    }
}
EOF

cat &lt;&lt;EOF | oc apply -f -
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: staging
  name: 99-staging-keepalived-vip
spec:
  config:
    ignition:
      config: {}
      security:
        tls: {}
      timeouts: {}
      version: 2.2.0
    networkd: {}
    passwd: {}
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,$(cat keepalived.conf.tmpl | base64 -w0)
          verification: {}
        filesystem: root
        mode: 420
        path: /etc/kubernetes/static-pod-resources/keepalived/keepalived.conf.tmpl
    systemd: {}
EOF

rm -f  keepalived.conf.tmpl
</code></pre>
<p>Verify:</p>
<pre><code>[root@akaris-osc-6klvk-worker-zhs67 ~]# cat /etc/keepalived/keepalived.conf 
# TODO: Improve this check. The port is assumed to be alive.
# Need to assess what is the ramification if the port is not there.
vrrp_script chk_ingress {
    script &quot;/usr/bin/curl -o /dev/null -kLfs http://0:1936/healthz&quot;
    interval 1
    weight 50
}
vrrp_instance staging_INGRESS {
    state BACKUP
    interface ens6
    virtual_router_id 100
    priority 40
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass staging_vip
    }
    virtual_ipaddress {
        172.31.254.118/24
    }
    track_script {
        chk_ingress
    }
}
[root@akaris-osc-6klvk-worker-zhs67 ~]# ip a | gre^C
[root@akaris-osc-6klvk-worker-zhs67 ~]# ip a ls dev ens6
3: ens6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc fq_codel state UP group default qlen 1000
    link/ether fa:16:3e:66:d2:28 brd ff:ff:ff:ff:ff:ff
    inet 172.31.254.207/24 brd 172.31.254.255 scope global dynamic noprefixroute ens6
       valid_lft 86337sec preferred_lft 86337sec
    inet 172.31.254.118/24 scope global secondary ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe66:d228/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre>
<p>And ping the VIP:</p>
<pre><code>[cloud-user@akaris-jump-server ~]$ ping 10.0.89.89
PING 10.0.89.89 (10.0.89.89) 56(84) bytes of data.
64 bytes from 10.0.89.89: icmp_seq=1 ttl=62 time=15.7 ms
^C
--- 10.0.89.89 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 15.791/15.791/15.791/0.000 ms
[cloud-user@akaris-jump-server ~]$ 
</code></pre>
<p>And SSH into the VIP:</p>
<pre><code>[cloud-user@akaris-jump-server ~]$ ssh core@10.0.89.89
The authenticity of host '10.0.89.89 (10.0.89.89)' can't be established.
ECDSA key fingerprint is SHA256:XB+FYE3vAxFZNI4HakM5WJkHmf74iMdFgI8x+dLx03A.
ECDSA key fingerprint is MD5:a2:54:c1:52:ee:05:67:52:7c:2a:a9:b8:35:a9:a5:ee.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.0.89.89' (ECDSA) to the list of known hosts.
Red Hat Enterprise Linux CoreOS 45.82.202007240629-0
  Part of OpenShift 4.5, RHCOS is a Kubernetes native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.5/architecture/architecture-rhcos.html

---
Last login: Tue Aug 11 19:14:19 2020 from 10.0.88.55
[core@akaris-osc-6klvk-worker-zhs67 ~]$ 
</code></pre>
<h2 id="step-5-configure-an-ingress-use-ingress-controller-sharding">Step 5: Configure an Ingress, use Ingress controller sharding</h2>
<p>Use:
<a href="https://docs.openshift.com/container-platform/4.5/networking/ingress-operator.html#nw-ingress-sharding_configuring-ingress">https://docs.openshift.com/container-platform/4.5/networking/ingress-operator.html#nw-ingress-sharding_configuring-ingress</a></p>
<p>For example, the following Ingress route should work and be served by the 2 <code>staging</code> workers:</p>
<pre><code>10.0.89.99 test.staging.akaris-osc....
</code></pre>
<p>Configure the default IngressController and have it run only on <code>worker</code> nodes - you can also exclude namespaces which shall not be served by the default IngressController:</p>
<pre><code>cat &lt;&lt;'EOF' &gt; patch.yaml
spec:
  replicas: 2
#  namespaceSelector:
#    matchExpressions:
#    - key: type
#      operator: NotIn
#      values:
#      - test1
#      - test2
  nodePlacement:
    nodeSelector:
      matchLabels:
        node-role.kubernetes.io/worker: &quot;&quot;
EOF
oc patch -n openshift-ingress-operator ingresscontroller default --type=&quot;merge&quot; -p &quot;$(cat patch.yaml)&quot;
rm -f patch.yaml
</code></pre>
<p>Configure the staging IngressController and have it run only on <code>sharded</code> nodes:</p>
<pre><code>cat &lt;&lt;'EOF' | oc apply -f -
apiVersion: v1
items:
- apiVersion: operator.openshift.io/v1
  kind: IngressController
  metadata:
    name: staging
    namespace: openshift-ingress-operator
  spec:
    replicas: 2
    domain: staging.akaris-osc....
    nodePlacement:
      nodeSelector:
        matchLabels:
          node-role.kubernetes.io/staging: &quot;&quot;
# --- either ---
#    routeSelector:
#      matchLabels:
#        type: staging
# --- or ---
#    namespaceSelector:
#      matchLabels:
#        type: test1
    endpointPublishingStrategy:
      type: HostNetwork
  status: {}
kind: List
metadata:
  resourceVersion: &quot;&quot;
  selfLink: &quot;&quot;
EOF
</code></pre>
<p>Verify generation and modification of the IngressController and OpenShift router pods:</p>
<pre><code>[cloud-user@akaris-jump-server openshift]$ oc get nodes
NAME                            STATUS   ROLES     AGE   VERSION
akaris-osc-6klvk-master-0       Ready    master    24h   v1.18.3+012b3ec
akaris-osc-6klvk-master-1       Ready    master    24h   v1.18.3+012b3ec
akaris-osc-6klvk-master-2       Ready    master    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-g4q6z   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-hp2hz   Ready    staging   19h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-l726s   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-lp2df   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-zhs67   Ready    staging   19h   v1.18.3+012b3ec
[cloud-user@akaris-jump-server openshift]$ oc get ingresscontroller -n openshift-ingress-operator
NAME      AGE
default   24h
staging   13m
[cloud-user@akaris-jump-server openshift]$ oc get pods -n openshift-ingress -o wide
NAME                              READY   STATUS    RESTARTS   AGE    IP              NODE                            NOMINATED NODE   READINESS GATES
router-default-7fd7bdd4fc-jf55h   1/1     Running   0          2m5s   192.168.0.114   akaris-osc-6klvk-worker-lp2df   &lt;none&gt;           &lt;none&gt;
router-default-7fd7bdd4fc-mc572   1/1     Running   0          106s   192.168.0.251   akaris-osc-6klvk-worker-l726s   &lt;none&gt;           &lt;none&gt;
router-staging-86c864549c-7stx8   1/1     Running   0          14m    192.168.1.160   akaris-osc-6klvk-worker-hp2hz   &lt;none&gt;           &lt;none&gt;
router-staging-86c864549c-nkz28   1/1     Running   0          14m    192.168.2.48    akaris-osc-6klvk-worker-zhs67   &lt;none&gt;           &lt;none&gt;
</code></pre>
<h2 id="step-6-expose-route">Step 6: Expose route</h2>
<pre><code>oc new-project test
oc adm policy add-scc-to-user anyuid -z default
</code></pre>
<pre><code>cat &lt;&lt;'EOF' &gt; httpbin-ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: httpbin-ingress
  annotations:
    kubernetes.io/ingress.allow-http: &quot;true&quot;
spec:
  rules:
  - host: httpbin-ingress.staging.akaris-osc....
    http:
      paths:
      - path: /
        backend:
          serviceName: httpbin-service
          servicePort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: httpbin-service
  labels:
    app: httpbin-deployment
spec:
  selector:
    app: httpbin-pod
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin-deployment
  labels:
    app: httpbin-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin-pod
  template:
    metadata:
      labels:
        app: httpbin-pod
    spec:
      containers:
      - name: tshark
        image: danielguerra/alpine-tshark 
        command:
          - &quot;tshark&quot; 
          - &quot;-i&quot; 
          - &quot;eth0&quot; 
          - &quot;-Y&quot; 
          - &quot;http&quot; 
          - &quot;-V&quot;  
          - &quot;dst&quot; 
          - &quot;port&quot;
          - &quot;80&quot;
      - name: httpbin
        image: kennethreitz/httpbin
        imagePullPolicy: Always
        command:
        - &quot;gunicorn&quot;
        - &quot;-b&quot;
        - &quot;0.0.0.0:80&quot;
        - &quot;httpbin:app&quot;
        - &quot;-k&quot;
        - &quot;gevent&quot;
        - &quot;--capture-output&quot;
        - &quot;--error-logfile&quot;
        - &quot;-&quot;
        - &quot;--access-logfile&quot;
        - &quot;-&quot;
        - &quot;--access-logformat&quot;
        - &quot;'%(h)s %(t)s %(r)s %(s)s Host: %({Host}i)s} Header-i: %({Header}i)s Header-o: %({Header}o)s'&quot;
EOF
oc apply -f httpbin-ingress.yaml
</code></pre>
<pre><code>[cloud-user@akaris-jump-server ~]$ oc get routes 
NAME                    HOST/PORT                                                                                 PATH   SERVICES          PORT    TERMINATION   WILDCARD
httpbin-ingress-z9tgf   httpbin-ingress.staging.akaris-osc.... ... 1 more   /      httpbin-service   &lt;all&gt;                 None
[cloud-user@akaris-jump-server ~]$ curl httpbin-ingress.staging.akaris-osc....
{
  &quot;args&quot;: {}, 
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;, 
    &quot;Forwarded&quot;: &quot;for=10.0.88.55;host=httpbin-ingress.staging.akaris-osc....;proto=http&quot;, 
    &quot;Host&quot;: &quot;httpbin-ingress.staging.akaris-osc....&quot;, 
    &quot;User-Agent&quot;: &quot;curl/7.29.0&quot;, 
    &quot;X-Forwarded-Host&quot;: &quot;httpbin-ingress.staging.akaris-osc....&quot;
  }, 
  &quot;origin&quot;: &quot;10.0.88.55&quot;, 
  &quot;url&quot;: &quot;http://httpbin-ingress.staging.akaris-osc..../get&quot;
}
</code></pre>
<h2 id="step-7-security-hardening">Step 7: Security hardening</h2>
<p>This is out of scope of this PoC, but note that at the moment, the default Ingress can still handle all domains and thus if the client configures its resolver appropriately, can reach the application via the default VIP.</p>
<p>For example, take this mapping:</p>
<pre><code>10.0.88.28 *.apps.akaris-osc....
10.0.89.89 *.staging.akaris-osc....
</code></pre>
<p>Then one can still use the other ingress router by modifying the client resolver:</p>
<pre><code>[cloud-user@akaris-jump-server ~]$ curl --resolve httpbin-ingress.staging.akaris-osc..../get:80:10.0.88.28 httpbin-ingress.staging.akaris-osc..../get
{
  &quot;args&quot;: {}, 
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;, 
    &quot;Forwarded&quot;: &quot;for=10.0.88.55;host=httpbin-ingress.staging.akaris-osc....;proto=http&quot;, 
    &quot;Host&quot;: &quot;httpbin-ingress.staging.akaris-osc...., 
    &quot;User-Agent&quot;: &quot;curl/7.29.0&quot;, 
    &quot;X-Forwarded-Host&quot;: &quot;httpbin-ingress.staging.akaris-osc...&quot;
  }, 
  &quot;origin&quot;: &quot;10.0.88.55&quot;, 
  &quot;url&quot;: &quot;http://httpbin-ingress.staging.akaris-osc..../get&quot;
}
[cloud-user@akaris-jump-server ~]$ curl --resolve httpbin-ingress.staging.akaris-osc..../get:80:10.0.89.89 httpbin-ingress.staging.akaris-osc.../get
{
  &quot;args&quot;: {}, 
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;, 
    &quot;Forwarded&quot;: &quot;for=10.0.88.55;host=httpbin-ingress.staging.akaris-osc....;proto=http&quot;, 
    &quot;Host&quot;: &quot;httpbin-ingress.staging.akaris-osc...&quot;, 
    &quot;User-Agent&quot;: &quot;curl/7.29.0&quot;, 
    &quot;X-Forwarded-Host&quot;: &quot;httpbin-ingress.staging.akaris-osc...&quot;
  }, 
  &quot;origin&quot;: &quot;10.0.88.55&quot;, 
  &quot;url&quot;: &quot;http://httpbin-ingress.staging.akaris-osc.../get&quot;
}
</code></pre>
<p>And the same goes for the other way around:</p>
<pre><code>[cloud-user@akaris-jump-server ~]$ curl --resolve nginx-deployment-application.apps.akaris-osc....:80:10.0.88.28 nginx-deployment-application.apps.akaris-osc....
Nginx A
[cloud-user@akaris-jump-server ~]$ curl --resolve nginx-deployment-application.apps.akaris-osc....:80:10.0.89.89 nginx-deployment-application.apps.akaris-osc....
Nginx A
</code></pre>
<p>Read the documentation about IngressController sharding for further details.</p>
<h2 id="step-8-troubleshooting">Step 8: Troubleshooting</h2>
<p>Again, a bit outside of the scope of this PoC - the debug pods for my <code>staging</code> nodes stopped working overnight. This would need some further troubleshooting:</p>
<pre><code>[cloud-user@akaris-jump-server ~]$ oc get nodes
NAME                            STATUS   ROLES     AGE   VERSION
akaris-osc-6klvk-master-0       Ready    master    25h   v1.18.3+012b3ec
akaris-osc-6klvk-master-1       Ready    master    25h   v1.18.3+012b3ec
akaris-osc-6klvk-master-2       Ready    master    25h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-g4q6z   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-hp2hz   Ready    staging   19h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-l726s   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-lp2df   Ready    worker    24h   v1.18.3+012b3ec
akaris-osc-6klvk-worker-zhs67   Ready    staging   19h   v1.18.3+012b3ec
</code></pre>
<pre><code>[cloud-user@akaris-jump-server ~]$ oc debug node/akaris-osc-6klvk-worker-zhs67
Starting pod/akaris-osc-6klvk-worker-zhs67-debug ...
To use host binaries, run `chroot /host`
Pod IP: 192.168.2.48
If you don't see a command prompt, try pressing enter.

Removing debug pod ...
Error from server: error dialing backend: remote error: tls: internal error
[cloud-user@akaris-jump-server ~]$ 
</code></pre>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 15, 2020</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../ingresscontroller_router_sharding_ocp_on_osp/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Ingress Controller Sharding OCP on OSP
            </div>
          </div>
        </a>
      
      
        <a href="../openshift_mirror_registry/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Installing a cluster with a mirror registry
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>