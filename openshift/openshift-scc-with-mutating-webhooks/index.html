
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Andreas Karis' blog about anything Kubernetes, OpenShift, Linux and Networking">
      
      
      
        <link rel="canonical" href="https://andreaskaris.github.io/blog/openshift/openshift-scc-with-mutating-webhooks/">
      
      
        <link rel="prev" href="../scc/">
      
      
        <link rel="next" href="../fix-selinux-labels-coreos/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>SCCs and mutating webhooks - a lesson learned - Andreas Karis Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="RSS feed of created content" href="https://andreaskaris.github.io/blog/feed_rss_created.xml">
  <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="https://andreaskaris.github.io/blog/feed_rss_updated.xml">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Andreas Karis Blog" class="md-header__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Andreas Karis Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SCCs and mutating webhooks - a lesson learned
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ceph/" class="md-tabs__link">
          
  
    
  
  Ceph

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../linux/" class="md-tabs__link">
          
  
    
  
  Linux

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../networking/" class="md-tabs__link">
          
  
    
  
  Networking

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  OpenShift and Kubernetes

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../openstack/" class="md-tabs__link">
          
  
    
  
  OpenStack

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../coding/" class="md-tabs__link">
          
  
    
  
  Coding

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
  
    
    <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
          


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Andreas Karis Blog" class="md-nav__button md-logo" aria-label="Andreas Karis Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Andreas Karis Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../ceph/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ceph
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Ceph
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph-manual-test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph manual test with qemu
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../linux/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cgroups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/containers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Containers in Linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/hugepages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hugepages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/ipxe-boot-environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    iPXE boot environment on Fedora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/java-idrac-issues/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java Idrac Issues
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/meson/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meson
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/namespaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    namespaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/old_java_version_with_xorgs_in_container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Old Java inside a container with xorgs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/protect-lenovo-battery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protect Lenovo laptop battery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/org-gnome-shell-overrides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workaround for org.gnome.shell.overrides not installed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/get-process-cgroup-info-and-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Retrieving process cgroup resource usage and limit info
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/libvirt-uefi-without-secureboot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RHEL Booting a virtual machine with UEFI but without secure boot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/setting-journalctl-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting journalctl limits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/cgroups_cpu_quota/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using cgroups for CFS bandwidth control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/udev-ethtool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    udev rules to apply ethtool settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/selinux-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SELinux Cheat Sheet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../networking/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Networking
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Networking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/accept-source-routing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accept Source Routing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/arp_and_the_neighbor_table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ARP and the Neighbor table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/bpf-and-tcpdump/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BPF and tcpdump
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/bonding_in_linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonding in Linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/juniper_x520/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configure Juniper switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovn-interconnection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hands-on with OVN Interconnection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/haproxy-and-h2c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    haproxy and HTTP/2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/install-openvswitch-on-rocky/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install Open vSwitch on Rocky Linux 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/geneve_tunneling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Geneve tunneling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/netlink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Netlink
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/netlink-address-fields/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Netlink and MAC addresses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovn_standalone_on_fedora/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVN standalone on Fedora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs_recirculation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVS packet recirculation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs-vxlan-tunnels-and-dscp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVS VXLAN tunnels and DSCP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/ovs_with_gdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVS with GDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/packet-tracing-with-ovn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Packet tracing with OVN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/sctp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SCTP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/useful-commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/wireguard/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wireguard
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OpenShift and Kubernetes
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            OpenShift and Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../alertmanager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AlertManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analyzing-cni/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analyzing CNI calls
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ocp-custom-release-image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building custom release images for OpenShift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpu-manager-with-custom-machine-config-pool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU manager with custom MachineConfigPool
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpu-isolation-in-openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU isolation in Red Hat OpenShift Container Platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../crio-conmon-runc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Crio vs conmon vs runc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dedicated-service-monitors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DedicatedServiceMonitors in OpenShift Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../etcd_perf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Etcd Performance tests
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-vs-list-api-calls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get vs List API Calls
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_httpbin_tshark_sidecar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Httpbin tshark sidecar container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hints for installing kubernetes on Fedora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../HPA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Horizontal Pod Autoscaler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_rhcos_updates_work/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How RHCOS updates work
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubelet-filesystems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How kubelet monitors filesystems
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ocp4-infra-nodes-with-machineset-without-worker-label/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infra nodes with MachineSets without worker label
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingresscontroller_router_sharding_ocp_on_osp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ingress Controller Sharding OCP on OSP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingress-controller-sharding-on-separate-vip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ingress Controller Sharding on separate VIP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_mirror_registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing a cluster with a mirror registry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../istio-1.6-on-ocp.4.x/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Istio 1.6 on OpenShift 4.x
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kata containers and the kata operatora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kernel-ml-on-openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kernel-ml on OpenShift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ovn-kind-hybrid-overlay/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kind with OVN Kubernetes Hybrid Overlay
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kind-with-private-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kind with private registry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../list_docker_registry_containers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    List container images in registry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mounting-container-image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mount a container image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/install_openshift_on_openstack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenShift on OpenStack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openshift-with-multipath/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenShift with iSCSI multipath
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../patch-service-loadbalancer-ingress-ip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Patch status.loadBalancer.ingress IP manually
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../private-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Private container registry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxy-ocp-4.5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxy OCP 4.5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rpm-ostree-failed-to-find-image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rpm-ostreed failed to find image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../seccomp-defaults-ocp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Seccomp defaults in Red Hat OpenShift Container Platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security Context Constraints (SCC)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    SCCs and mutating webhooks - a lesson learned
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fix-selinux-labels-coreos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SElinux labels fix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/sctp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SCTP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openshift_troubleshooting_etcd_state/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting etcd state
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../useful-ocp-commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful commands for OpenShift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../useful-ocp-sdn-commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful commands for OpenShift SDN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting_openshift_on_openstack_worker_creation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting OpenShift on OpenStack worker creation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../openstack/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OpenStack
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            OpenStack
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/reattach_to_running_deployment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reattach to running deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openstack/using_clouds_yaml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using clouds.yaml
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../coding/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Coding
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Coding
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/operator-sdk-reconciliation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Controller Reconciliation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/vimrc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    My vimrc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../coding/golang-ip-conversion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golang IP address conversion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
        </div>
      </div>
    </div>
  
  
    
    <!--
    <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner">
          

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
        </div>
      </div>
    </div>
    -->
  

          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p><img alt="title" src="https://user-images.githubusercontent.com/3291433/220175185-f58bf274-e886-45ef-ab32-92b6cd3f1739.png" /></p>
<h1 id="sccs-and-mutating-webhooks-or-how-to-learn-about-admission-plugin-reinvocation-the-hard-way">SCCs and mutating webhooks - or how to learn about admission plugin reinvocation the hard way</h1>
<p>Author: Andreas Karis</p>
<p>Recently, a partner of ours observed a strange behavior in their OpenShift cluster. For a specific application, this
partner needs the pod to run with the UID that was configured by the application container image:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>application/Dockerfile<span class="w"> </span>
FROM<span class="w"> </span><span class="o">(</span>...<span class="o">)</span>
RUN<span class="w"> </span>useradd<span class="w"> </span>-u<span class="w"> </span><span class="m">1001</span><span class="w"> </span>exampleuser
USER<span class="w"> </span><span class="m">1001</span>
<span class="o">(</span>...<span class="o">)</span>
</code></pre></div></td></tr></table></div></p>
<p>When their application pods run, the <code class="highlight"><span class="na">.securityContext.runAsUser</span></code> field should not be set:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>application-pod<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.containers[?(@.name==&quot;application-container&quot;)].securityContext.runAsUser}&#39;</span>
$
</code></pre></div></td></tr></table></div></p>
<p>And the container should run with the user that was configured by the container image:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>application-pod<span class="w"> </span>--<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span>
</code></pre></div></td></tr></table></div></p>
<p>In order to achieve this, the partner relies on the <code class="highlight">RunAsAny</code> <code class="highlight">RUNASUSER</code> strategy provided by either the
<code class="highlight">anyuid</code> or the <code class="highlight">privileged</code> SCC:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>scc<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;NAME|^anyuid|privileged&#39;</span>
NAME<span class="w">                              </span>PRIV<span class="w">    </span>CAPS<span class="w">         </span>SELINUX<span class="w">     </span>RUNASUSER<span class="w">          </span>FSGROUP<span class="w">     </span>SUPGROUP<span class="w">    </span>PRIORITY<span class="w">     </span>READONLYROOTFS<span class="w">   </span>VOLUMES
anyuid<span class="w">                            </span><span class="nb">false</span><span class="w">   </span>&lt;no<span class="w"> </span>value&gt;<span class="w">   </span>MustRunAs<span class="w">   </span>RunAsAny<span class="w">           </span>RunAsAny<span class="w">    </span>RunAsAny<span class="w">    </span><span class="m">10</span><span class="w">           </span><span class="nb">false</span><span class="w">            </span><span class="o">[</span><span class="s2">&quot;configMap&quot;</span>,<span class="s2">&quot;downwardAPI&quot;</span>,<span class="s2">&quot;emptyDir&quot;</span>,<span class="s2">&quot;persistentVolumeClaim&quot;</span>,<span class="s2">&quot;projected&quot;</span>,<span class="s2">&quot;secret&quot;</span><span class="o">]</span>
privileged<span class="w">                        </span><span class="nb">true</span><span class="w">    </span><span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span><span class="w">        </span>RunAsAny<span class="w">    </span>RunAsAny<span class="w">           </span>RunAsAny<span class="w">    </span>RunAsAny<span class="w">    </span>&lt;no<span class="w"> </span>value&gt;<span class="w">   </span><span class="nb">false</span><span class="w">            </span><span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span>
</code></pre></div></td></tr></table></div></p>
<p>This partner is using a 3rd party Istio operator. Contrary to OpenShift ServiceMesh, upstream Istio requires elevated
privileges when injecting its sidecars to the application pods. </p>
<p>When this partner followed the Istio documentation and bound the <code class="highlight">anyuid</code> SCC to the namespace, the application pod's
non-istio containers would keep their configured <code class="highlight">securityContext.runAsUser</code>, as expected:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-scc-to-group<span class="w"> </span>anyuid<span class="w"> </span>system:serviceaccounts:istio-test
</code></pre></div></td></tr></table></div></p>
<p>On the other hand, when the partner bound the <code class="highlight">privileged</code> SCC to the namespace, the application pod could still spawn,
but the non-istio containers would show a <code class="highlight">securityContext.runAsUser</code>. Due to this, the pods crash looped, as the
container image's application could not run with OpenShfit's enforced <code class="highlight">runAsUser</code> UID.</p>
<p>Let's look at an example setup that simulates the partner's configuration. We install upstream Istio according to
the upsteam documentation:</p>
<ul>
<li><a href="https://istio.io/latest/docs/setup/getting-started/#download">https://istio.io/latest/docs/setup/getting-started/#download</a></li>
<li><a href="https://istio.io/latest/docs/setup/platform-setup/openshift/">https://istio.io/latest/docs/setup/platform-setup/openshift/</a></li>
</ul>
<p>We then create a test namespace for our application:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>new-project<span class="w"> </span>istio-test
$<span class="w"> </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | oc -n istio-test create -f -</span>
<span class="s">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="s">kind: NetworkAttachmentDefinition</span>
<span class="s">metadata:</span>
<span class="s">  name: istio-cni</span>
<span class="s">EOF</span>
$<span class="w"> </span>oc<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>istio-test<span class="w"> </span>istio-injection<span class="o">=</span>enabled
</code></pre></div></td></tr></table></div></p>
<p>We bind the <code class="highlight">anyuid</code> SCC to the ServiceAccount:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-scc-to-group<span class="w"> </span>anyuid<span class="w"> </span>system:serviceaccounts:istio-test
</code></pre></div></td></tr></table></div></p>
<p>And apply the following application:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39; &gt; fedora-test-sidecar-inject.yaml</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  labels:</span>
<span class="s">    app: fedora-test-sidecar-inject</span>
<span class="s">  name: fedora-test-sidecar-inject</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      deployment: fedora-test-sidecar-inject</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        deployment: fedora-test-sidecar-inject</span>
<span class="s">      annotations:</span>
<span class="s">        sidecar.istio.io/inject: &#39;true&#39;</span>
<span class="s">        sidecar.istio.io/proxyCPU: 50m</span>
<span class="s">        sidecar.istio.io/proxyCPULimit: 2000m</span>
<span class="s">        sidecar.istio.io/proxyMemory: 200Mi</span>
<span class="s">        sidecar.istio.io/proxyMemoryLimit: 1Gi</span>
<span class="s">        proxy.istio.io/config: &#39;{ &quot;terminationDrainDuration&quot;: 30s, &quot;holdApplicationUntilProxyStarts&quot;: true }&#39;</span>
<span class="s">    spec:</span>
<span class="s">      containers:</span>
<span class="s">      - image: quay.io/akaris/fedora-test:uid</span>
<span class="s">        imagePullPolicy: IfNotPresent</span>
<span class="s">        name: fedora-test-sidecar-inject</span>
<span class="s">EOF</span>
$<span class="w"> </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>fedora-test-sidecar-inject.yaml
</code></pre></div></td></tr></table></div></p>
<p>As you can see below, only the <code class="highlight">istio-proxy</code> has the <code class="highlight">securityContext.runAsUser</code> field set, whereas the
<code class="highlight">fedora-test-sidecar-inject</code> container does not and thus the container image's UID is honored:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s2">&quot;NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc,CONTAINERNAME:.spec.containers[*].name,RUNASUSER:.spec.containers[*].securityContext.runAsUser&quot;</span>
NAME<span class="w">                                         </span>SCC<span class="w">          </span>CONTAINERNAME<span class="w">                            </span>RUNASUSER
fedora-test-sidecar-inject-d75986bbd-pbqbx<span class="w">   </span>anyuid<span class="w">       </span>istio-proxy,fedora-test-sidecar-inject<span class="w">   </span><span class="m">1337</span>
$<span class="w"> </span>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>fedora-test-sidecar-inject-d75986bbd-pbqbx<span class="w"> </span>--<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span>
</code></pre></div></td></tr></table></div></p>
<p>But when we redeploy the application with the <code class="highlight">privileged</code> SCC, something interesting happens:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>fedora-test-sidecar-inject.yaml
$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>remove-scc-from-group<span class="w"> </span>anyuid<span class="w"> </span>system:serviceaccounts:istio-test
$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-scc-to-group<span class="w"> </span>privileged<span class="w"> </span>system:serviceaccounts:istio-test
$<span class="w"> </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>fedora-test-sidecar-inject.yaml
</code></pre></div></td></tr></table></div></p>
<p>Note how the pod is bound to the <code class="highlight">privileged</code> SCC, but the application container is now forced to run as a specific
user ID:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s2">&quot;NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc,CONTAINERNAME:.spec.containers[*].name,RUNASUSER:.spec.containers[*].securityContext.runAsUser&quot;</span>
NAME<span class="w">                                         </span>SCC<span class="w">          </span>CONTAINERNAME<span class="w">                            </span>RUNASUSER
fedora-test-sidecar-inject-d75986bbd-8j6vt<span class="w">   </span>privileged<span class="w">   </span>istio-proxy,fedora-test-sidecar-inject<span class="w">   </span><span class="m">1337</span>,1000780000
$<span class="w"> </span>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>fedora-test-sidecar-inject-d75986bbd-8j6vt<span class="w"> </span>--<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">1000780000</span><span class="o">(</span><span class="m">1000780000</span><span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">0</span><span class="o">(</span>root<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">0</span><span class="o">(</span>root<span class="o">)</span>,1000780000
</code></pre></div></td></tr></table></div></p>
<p>How is this possible? Both the <code class="highlight">privileged</code> SCC as well as the <code class="highlight">anyuid</code> SCC set <code class="highlight">RUNASUSER</code> to <code class="highlight">RunAsAny</code>, yet the two
SCCs seemingly behave differently. Why would the <code class="highlight">privileged</code> SCC inject <code class="highlight">securityContext.runAsUser</code> into the pods'
containers? Well, Istio uses mutating admission webhooks to achieve sidecar injection. And as it turns out, the
interaction between SCCs and mutating pod admission controllers can be quite complex.</p>
<p>In order to figure out what is going on, let's start by refreshing our memory about SCCs. Then, we will deploy our own
little mutating webhook and create a reproducer environment.</p>
<h3 id="scc-basics">SCC basics</h3>
<h4 id="scc-prioritization">SCC prioritization</h4>
<p>It is important to understand OCP SCC prioritization: In OCP,  we can apply multiple SCCs to a ServiceAccount.
The default SCC for any serviceAccount is always <code class="highlight">restricted</code>, even if you did not bind it explicitly to the
ServiceAccount. The matching goes by priority first, then most restrictive SCC policy, then by name.</p>
<p>This means that even when you assign the <code class="highlight">privileged</code> SCC to the default ServiceAccount of your namespace, there will
always be an implicit <code class="highlight">restricted</code> SCC with the same priority as the <code class="highlight">privileged</code> SCC that OpenShift can fall back to:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>oc adm policy add-scc-to-user privileged -z default
</code></pre></div></td></tr></table></div></p>
<p>So even when you bind your ServiceAccount to the <code class="highlight">privileged</code> SCC, the pod may actually use the <code class="highlight">restricted</code> SCC, simply
because the pod is happy running in a more restrictive context.</p>
<p>Note that the <code class="highlight">anyuid</code> SCC has a higher SCC priority, and thus it will always win against the <code class="highlight">restricted</code> SCC.</p>
<p>For further details, see the <a href="https://docs.openshift.com/container-platform/4.10/authentication/managing-security-context-constraints.html#scc-prioritization_configuring-internal-oauth">OpenShift documentation</a>.</p>
<p>When deploying a pod, you can check which SCC it is actually running with using the following command:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>oc get pods -o custom-columns=&quot;NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc&quot;
</code></pre></div></td></tr></table></div></p>
<h4 id="scc-runasuser-strategies">SCC runAsUser strategies</h4>
<p>There are 4 SCC <code class="highlight">runAsUser</code> strategies, <code class="highlight">MustRunAs</code>, <code class="highlight">MustRunAsNonRoot</code>, <code class="highlight">MustRunAsRange</code> and <code class="highlight">RunAsAny</code>.
Further details can be found in the <a href="https://docs.openshift.com/container-platform/4.10/authentication/managing-security-context-constraints.html#authorization-SCC-strategies_configuring-internal-oauth">OpenShift documentation</a>:</p>
<ul>
<li>MustRunAs - Requires a runAsUser to be configured. Uses the configured runAsUser as the default. Validates against the configured runAsUser.</li>
<li>MustRunAsNonRoot - Requires that the pod be submitted with a non-zero runAsUser or have the USER directive defined in the image. No default provided.</li>
<li>MustRunAsRange - Requires minimum and maximum values to be defined if not using pre-allocated values. Uses the minimum as the default. Validates against the entire allowable range.</li>
<li>RunAsAny - No default provided. Allows any runAsUser to be specified.</li>
</ul>
<p>Neither <code class="highlight">MustRunAsNonRoot</code> nor <code class="highlight">RunAsAny</code> will create a <code class="highlight">securityContext.runAsUser</code> setting on the pod/container, and
thus both will respect the container image's provided UID. <code class="highlight">MustRunAsNonRoot</code> however requires a numeric UID to be
set inside the container image, though.</p>
<p><code class="highlight">MustRunAsRange</code> will enforce a UID from the project's range, and <code class="highlight">MustRunAs</code> explicitly requires that the admin provide
a UID. So for both of these, <code class="highlight">securityContext.runAsUser</code> will be explicitly set on the pod, one way or another.</p>
<p>Therefore, in theory, when you inspect a pod and it shows as being matched by an SCC with a <code class="highlight">runAsUser</code> strategy of
<code class="highlight">RunAsAny</code>, then OpenShift should never modify <code class="highlight">securityContext.runAsUser</code>. An example of such an SCC is the
<code class="highlight">privileged</code> SCC. On the other hand, if the SCC that matches the pod is <code class="highlight">MustRunAsRange</code>, then a default value will be
chosen if <code class="highlight">securityContext.runAsUser</code> was not set.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>scc<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;NAME|privileged|restricted&#39;</span>
NAME<span class="w">                              </span>PRIV<span class="w">    </span>CAPS<span class="w">         </span>SELINUX<span class="w">     </span>RUNASUSER<span class="w">          </span>FSGROUP<span class="w">     </span>SUPGROUP<span class="w">    </span>PRIORITY<span class="w">     </span>READONLYROOTFS<span class="w">   </span>VOLUMES
privileged<span class="w">                        </span><span class="nb">true</span><span class="w">    </span><span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span><span class="w">        </span>RunAsAny<span class="w">    </span>RunAsAny<span class="w">           </span>RunAsAny<span class="w">    </span>RunAsAny<span class="w">    </span>&lt;no<span class="w"> </span>value&gt;<span class="w">   </span><span class="nb">false</span><span class="w">            </span><span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span>
restricted<span class="w">                        </span><span class="nb">false</span><span class="w">   </span>&lt;no<span class="w"> </span>value&gt;<span class="w">   </span>MustRunAs<span class="w">   </span>MustRunAsRange<span class="w">     </span>MustRunAs<span class="w">   </span>RunAsAny<span class="w">    </span>&lt;no<span class="w"> </span>value&gt;<span class="w">   </span><span class="nb">false</span><span class="w">            </span><span class="o">[</span><span class="s2">&quot;configMap&quot;</span>,<span class="s2">&quot;downwardAPI&quot;</span>,<span class="s2">&quot;emptyDir&quot;</span>,<span class="s2">&quot;persistentVolumeClaim&quot;</span>,<span class="s2">&quot;projected&quot;</span>,<span class="s2">&quot;secret&quot;</span><span class="o">]</span>
</code></pre></div></td></tr></table></div></p>
<p>For the curious, the relevant OpenShift code lives in the <a href="https://github.com/openshift/apiserver-library-go">apiserver-library-go</a>
repository.
First of all, the SCC admission controller will only ever inject <code class="highlight">securityContext.runAsUser</code> if the field is unset.
Otherwise, it will keep the currently set value. On the other hand, the code in <code class="highlight"><span class="k">user</span><span class="o">/</span><span class="n">runasany</span><span class="p">.</span><span class="k">go</span></code>s <code class="highlight">Generate()</code> will
always return <code class="highlight">nil</code>, and thus result in a no-op. </p>
<ul>
<li>Generate() is called here, but only if securityContext.runAsUser is unset for the pod or container:
<a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/provider.go#L159">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/provider.go#L159</a></li>
<li>RunAsAny UID Generate() returns <code class="highlight">nil</code> and no change will be made to the pod definition:
<a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/runasany.go#L22">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/runasany.go#L22</a></li>
<li>Compare that to the MustRunAsRange UID Generate() which will return the first UID from the project's range:
<a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/mustrunasrange.go#L37">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/mustrunasrange.go#L37</a></li>
</ul>
<h3 id="putting-scc-prioritization-and-scc-runasuser-strategies-together">Putting SCC prioritization and SCC runAsUser strategies together</h3>
<p>As mentioned earlier, given that the <code class="highlight">privileged</code> and <code class="highlight">restricted</code> SCC both have the same priority, a pod that does
not need any privileges from the <code class="highlight">privileged</code> SCC will automatically fall back to using the <code class="highlight">restricted</code> SCC. This is
because the <code class="highlight">restricted</code> SCC is the most restrictive SCC that matches the pod.
When that happens, the pod will be subject to the <code class="highlight">restricted</code> SCC's <code class="highlight">MustRunAsRange</code> <code class="highlight">runAsUser</code> strategy, and thus a
default UID will be set in <code class="highlight">securityContext.runAsUser</code> if the field was unset at pod creation time. OpenShift's chosen
UID might then conflict with the container image's requirements to run with a specific UID.</p>
<p>The below examples use image <code class="highlight">quay.io/akaris/fedora-test:uid</code> which was generated with the following Dockerfile:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>Dockerfile<span class="w"> </span>
FROM<span class="w"> </span>registry.fedoraproject.org/fedora:latest
RUN<span class="w"> </span>useradd<span class="w"> </span>-u<span class="w"> </span><span class="m">1001</span><span class="w"> </span>exampleuser
USER<span class="w"> </span><span class="m">1001</span>
RUN<span class="w"> </span>whoami
COPY<span class="w"> </span>script.sh<span class="w"> </span>/script.sh
CMD<span class="w"> </span><span class="o">[</span><span class="s2">&quot;/bin/bash&quot;</span>,<span class="w"> </span><span class="s2">&quot;/script.sh&quot;</span><span class="o">]</span>
</code></pre></div></td></tr></table></div></p>
<blockquote>
<p>You can find the repository with the Dockerfile and script here <a href="https://github.com/andreaskaris/fedora-test">https://github.com/andreaskaris/fedora-test</a>.</p>
</blockquote>
<p>For all examples, the namespace's default ServiceAccount is bound to the <code class="highlight">privileged</code> SCC:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-scc-to-user<span class="w"> </span>privileged<span class="w"> </span>-z<span class="w"> </span>default
clusterrole.rbac.authorization.k8s.io/system:openshift:scc:privileged<span class="w"> </span>added:<span class="w"> </span><span class="s2">&quot;default&quot;</span>
</code></pre></div></td></tr></table></div></p>
<p>The following is the deployment definition for a pod that will be assigned the <code class="highlight">restricted</code> SCC. Note that the pod
requires minimal privileges and thus upon creation will be mapped to the <code class="highlight">restricted</code> SCC even though the ServiceAccount
is bound to the <code class="highlight">privileged</code> SCC:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>fedora-test.yaml
apiVersion:<span class="w"> </span>apps/v1
kind:<span class="w"> </span>Deployment
metadata:
<span class="w">  </span>labels:
<span class="w">    </span>app:<span class="w"> </span>fedora-test
<span class="w">  </span>name:<span class="w"> </span>fedora-test
spec:
<span class="w">  </span>replicas:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>selector:
<span class="w">    </span>matchLabels:
<span class="w">      </span>deployment:<span class="w"> </span>fedora-test
<span class="w">  </span>template:
<span class="w">    </span>metadata:
<span class="w">      </span>labels:
<span class="w">        </span>deployment:<span class="w"> </span>fedora-test
<span class="w">    </span>spec:
<span class="w">      </span>containers:
<span class="w">      </span>-<span class="w"> </span>image:<span class="w"> </span>quay.io/akaris/fedora-test:uid
<span class="w">        </span>imagePullPolicy:<span class="w"> </span>IfNotPresent
<span class="w">        </span>name:<span class="w"> </span>fedora-test
</code></pre></div></td></tr></table></div></p>
<p>The following is the deployment definition for a pod which will be assigned the <code class="highlight">privileged</code> SCC. The pod's
<code class="highlight">securityContext</code> adds some capabilities and thus does not fit into the restrictions that are imposed by the
<code class="highlight">restrictive</code> SCC:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>fedora-test-with-capabilities.yaml
apiVersion:<span class="w"> </span>apps/v1
kind:<span class="w"> </span>Deployment
metadata:
<span class="w">  </span>labels:
<span class="w">    </span>app:<span class="w"> </span>fedora-test-with-capabilities
<span class="w">  </span>name:<span class="w"> </span>fedora-test-with-capabilities
spec:
<span class="w">  </span>replicas:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>selector:
<span class="w">    </span>matchLabels:
<span class="w">      </span>deployment:<span class="w"> </span>fedora-test-with-capabilities
<span class="w">  </span>template:
<span class="w">    </span>metadata:
<span class="w">      </span>labels:
<span class="w">        </span>deployment:<span class="w"> </span>fedora-test-with-capabilities
<span class="w">    </span>spec:
<span class="w">      </span>containers:
<span class="w">      </span>-<span class="w"> </span>image:<span class="w"> </span>quay.io/akaris/fedora-test:uid
<span class="w">        </span>imagePullPolicy:<span class="w"> </span>IfNotPresent
<span class="w">        </span>name:<span class="w"> </span>fedora-test-with-capabilities
<span class="w">        </span>securityContext:
<span class="w">          </span>capabilities:
<span class="w">            </span>add:
<span class="w">              </span>-<span class="w"> </span>SETFCAP
<span class="w">              </span>-<span class="w"> </span>CAP_NET_RAW
<span class="w">              </span>-<span class="w"> </span>CAP_NET_ADMIN
</code></pre></div></td></tr></table></div></p>
<p>When applying both of these deployments, OpenShift will evaluate both the <code class="highlight">restricted</code> and the <code class="highlight">privileged</code> SCC. As
both have the same priority, the most restrictive SCC that allows the pod to spawn wins. If the <code class="highlight">restrictive</code> SCC
matches the pod, then the <code class="highlight">securityContext.runAsUser</code> field will be written by OpenShift, as well:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>fedora-test.yaml
deployment.apps/fedora-test<span class="w"> </span>created
$<span class="w"> </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>fedora-test-with-capabilities.yaml
deployment.apps/fedora-test-with-capabilities<span class="w"> </span>created
$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s2">&quot;NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc,RUNASUSER:.spec.containers[*].securityContext.runAsUser&quot;</span>
NAME<span class="w">                                             </span>SCC<span class="w">          </span>RUNASUSER
fedora-test-59985b9667-bg8kk<span class="w">                     </span>restricted<span class="w">   </span><span class="m">1000770000</span>
fedora-test-with-capabilities-5f667b698d-ppc5f<span class="w">   </span>privileged<span class="w">   </span>&lt;none&gt;
$<span class="w"> </span>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>fedora-test-59985b9667-bg8kk<span class="w"> </span>--<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">1000770000</span><span class="o">(</span><span class="m">1000770000</span><span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">0</span><span class="o">(</span>root<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">0</span><span class="o">(</span>root<span class="o">)</span>,1000770000
$<span class="w"> </span>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>fedora-test-with-capabilities-5f667b698d-ppc5f<span class="w"> </span>--<span class="w"> </span>id
<span class="nv">uid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">1001</span><span class="o">(</span>exampleuser<span class="o">)</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="mutating-webhooks">Mutating webhooks</h3>
<p>Mutating webhooks are part of Kubernetes' <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">Dynamic Admission Control</a>.
A simple mutating admission webhook that we are going to use for some of the following examples can be found
<a href="https://github.com/andreaskaris/webhook">in this github repository</a>. The mutating webhook examines the annotations of
any pod upon creation. If the pod has an annotation <code class="highlight">webhook/capabilities:</code> with a list of capabilities
<code class="highlight">[&quot;SETFCAP&quot;,&quot;CAP_NET_RAW&quot;,&quot;CAP_NET_ADMIN&quot;]</code> then the mutating webhook will copy these capabilities into
<code class="highlight">securityContext.capabilities.add</code> of all containers:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">Deployment</span>
<span class="o">(...)</span>
<span class="n">spec</span><span class="o">:</span>
<span class="o">(...)</span>
<span class="w">  </span><span class="n">template</span><span class="o">:</span>
<span class="w">    </span><span class="n">metadata</span><span class="o">:</span>
<span class="w">      </span><span class="o">(...)</span>
<span class="w">      </span><span class="n">annotations</span><span class="o">:</span>
<span class="w">        </span><span class="n">webhook</span><span class="o">/</span><span class="n">capabilities</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;[&quot;SETFCAP&quot;,&quot;CAP_NET_RAW&quot;,&quot;CAP_NET_ADMIN&quot;]&#39;</span>
<span class="w">    </span><span class="n">spec</span><span class="o">:</span>
<span class="w">      </span><span class="n">containers</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="na">io</span><span class="sr">/akaris/</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">:</span><span class="n">uid</span>
<span class="w">        </span><span class="n">imagePullPolicy</span><span class="o">:</span><span class="w"> </span><span class="n">IfNotPresent</span>
<span class="w">        </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">capabilities</span>
<span class="o">(...)</span>
</code></pre></div></td></tr></table></div></p>
<p>A pod from the deployment above will be rewritten by the mutating webhook to:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code>(...)
  spec:
    containers:
    <span class="k">-</span> image: quay.io/akaris/fedora-test:uid
      imagePullPolicy: IfNotPresent
      name: fedora-test-with-capabilities
      securityContext:
        capabilities:
          add:
          <span class="k">-</span> &quot;SETFCAP&quot;
          <span class="k">-</span> &quot;CAP_NET_RAW&quot;
          <span class="k">-</span> &quot;CAP_NET_ADMIN&quot;
(...)
</code></pre></div></td></tr></table></div></p>
<h3 id="putting-scc-prioritization-scc-runasuser-strategies-and-mutating-webhooks-together">Putting SCC prioritization, SCC runAsUser strategies and mutating webhooks together</h3>
<p>As a prerequisite for this section, we deployed the aforementioned mutating webhook.</p>
<p>With the mutating webhook in place, let's create the following deployment:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>fedora-test-with-annotation.yaml
apiVersion:<span class="w"> </span>apps/v1
kind:<span class="w"> </span>Deployment
metadata:
<span class="w">  </span>labels:
<span class="w">    </span>app:<span class="w"> </span>fedora-test-with-annotation
<span class="w">  </span>name:<span class="w"> </span>fedora-test-with-annotation
spec:
<span class="w">  </span>replicas:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>selector:
<span class="w">    </span>matchLabels:
<span class="w">      </span>deployment:<span class="w"> </span>fedora-test-with-annotation
<span class="w">  </span>template:
<span class="w">    </span>metadata:
<span class="w">      </span>labels:
<span class="w">        </span>deployment:<span class="w"> </span>fedora-test-with-annotation
<span class="w">      </span>annotations:
<span class="w">        </span>webhook/capabilities:<span class="w"> </span><span class="s1">&#39;[&quot;SETFCAP&quot;,&quot;CAP_NET_RAW&quot;,&quot;CAP_NET_ADMIN&quot;]&#39;</span>
<span class="w">    </span>spec:
<span class="w">      </span>containers:
<span class="w">      </span>-<span class="w"> </span>image:<span class="w"> </span>quay.io/akaris/fedora-test:uid
<span class="w">        </span>imagePullPolicy:<span class="w"> </span>IfNotPresent
<span class="w">        </span>name:<span class="w"> </span>fedora-test-with-annotation
</code></pre></div></td></tr></table></div></p>
<p>As you can see, it does not define any <code class="highlight">add</code> capabilities, but the webhook will actually inject them for us into the
container as soon as we create the deployment:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>webhook<span class="w"> </span>-l<span class="w"> </span><span class="nv">deployment</span><span class="o">=</span>webhook
<span class="o">(</span>...<span class="o">)</span>
<span class="o">{</span><span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;info&quot;</span>,<span class="s2">&quot;ts&quot;</span>:<span class="s2">&quot;2023-02-13T21:01:59Z&quot;</span>,<span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Inspecting pod&quot;</span>,<span class="s2">&quot;namespace&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;ownerReferences&quot;</span>:<span class="o">[{</span><span class="s2">&quot;apiVersion&quot;</span>:<span class="s2">&quot;apps/v1&quot;</span>,<span class="s2">&quot;kind&quot;</span>:<span class="s2">&quot;ReplicaSet&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;fedora-test-with-annotation-6745dd89bf&quot;</span>,<span class="s2">&quot;uid&quot;</span>:<span class="s2">&quot;3fc7311a-f380-4a3f-92b6-d43b2fb31da6&quot;</span>,<span class="s2">&quot;controller&quot;</span>:true,<span class="s2">&quot;blockOwnerDeletion&quot;</span>:true<span class="o">}]</span>,<span class="s2">&quot;labels&quot;</span>:<span class="o">{</span><span class="s2">&quot;deployment&quot;</span>:<span class="s2">&quot;fedora-test-with-annotation&quot;</span>,<span class="s2">&quot;pod-template-hash&quot;</span>:<span class="s2">&quot;6745dd89bf&quot;</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;info&quot;</span>,<span class="s2">&quot;ts&quot;</span>:<span class="s2">&quot;2023-02-13T21:01:59Z&quot;</span>,<span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Adding capabilities to pod&quot;</span>,<span class="s2">&quot;capabilities&quot;</span>:<span class="s2">&quot;SETFCAP&quot;</span><span class="o">}</span>
<span class="o">{</span><span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;info&quot;</span>,<span class="s2">&quot;ts&quot;</span>:<span class="s2">&quot;2023-02-13T21:01:59Z&quot;</span>,<span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Adding capabilities to pod&quot;</span>,<span class="s2">&quot;capabilities&quot;</span>:<span class="s2">&quot;CAP_NET_RAW&quot;</span><span class="o">}</span>
<span class="o">{</span><span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;info&quot;</span>,<span class="s2">&quot;ts&quot;</span>:<span class="s2">&quot;2023-02-13T21:01:59Z&quot;</span>,<span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Adding capabilities to pod&quot;</span>,<span class="s2">&quot;capabilities&quot;</span>:<span class="s2">&quot;CAP_NET_ADMIN&quot;</span><span class="o">}</span>
<span class="o">(</span>...<span class="o">)</span>
</code></pre></div></td></tr></table></div></p>
<p>After applying the deployment, we can see that the mutating webhook injected the capabilities that we requested:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
<span class="o">(...)</span>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span><span class="o">-</span><span class="mi">6745</span><span class="n">dd89bf</span><span class="o">-</span><span class="n">t6kdf</span>
<span class="w">  </span><span class="kd">namespace</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>
<span class="o">(...)</span>
<span class="n">spec</span><span class="o">:</span>
<span class="w">  </span><span class="n">containers</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="na">io</span><span class="sr">/akaris/</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">:</span><span class="n">uid</span>
<span class="w">    </span><span class="n">imagePullPolicy</span><span class="o">:</span><span class="w"> </span><span class="n">IfNotPresent</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span>
<span class="w">    </span><span class="n">resources</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span>
<span class="w">    </span><span class="n">securityContext</span><span class="o">:</span>
<span class="w">      </span><span class="n">capabilities</span><span class="o">:</span>
<span class="w">        </span><span class="n">add</span><span class="o">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SETFCAP</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">CAP_NET_RAW</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">CAP_NET_ADMIN</span>
<span class="o">(...)</span>
</code></pre></div></td></tr></table></div></p>
<p>Surprisingly, the new pod matches the <code class="highlight">privileged</code> SCC, but it was also forced to run as a specific user ID:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s2">&quot;NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc,RUNASUSER:.spec.containers[*].securityContext.runAsUser&quot;</span>
NAME<span class="w">                                             </span>SCC<span class="w">          </span>RUNASUSER
fedora-test-59985b9667-bg8kk<span class="w">                     </span>restricted<span class="w">   </span><span class="m">1000770000</span>
fedora-test-with-annotation-6745dd89bf-t6kdf<span class="w">     </span>privileged<span class="w">   </span><span class="m">1000770000</span>
fedora-test-with-capabilities-5f667b698d-tbz4t<span class="w">   </span>privileged<span class="w">   </span>&lt;none&gt;
</code></pre></div></td></tr></table></div></p>
<p>This seemingly contradicts what we said earlier about the <code class="highlight">privileged</code> SCC: it should not manipulate
<code class="highlight">securityContext.runAsUser</code>.</p>
<h3 id="formulating-a-hypothesis">Formulating a hypothesis</h3>
<p>Our hypothesis: when the pod is created, it first matches the <code class="highlight">restricted</code> SCC which mutates the pod's containers and
adds <code class="highlight">securityContext.runAsUser: &lt;ID from project range&gt;</code>. Then, the mutating webhook injects the new capabilities
into the pod's containers. After the pod was modified during the webhook mutation stage, the built-in SCC mutating
admission plugin is rerun. The pod now must be assigned the <code class="highlight">privileged</code> SCC as it cannot run with the more
restrictive set of rules from the <code class="highlight">restricted</code> SCC. Thus, the SCC admission plugin updates the pod's SCC accordingly.
This also explains why we do not see the same symptoms when we use the <code class="highlight">anyuid</code> SCC - the <code class="highlight">anyuid</code> SCC always wins
against the <code class="highlight">restricted</code> SCC due to its higher priority, and thus the pod will be assigned the <code class="highlight">anyuid</code> SCC from the
very beginning.</p>
<p>Our hypothesis is backed by <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#reinvocation-policy">the Kubernetes documentation</a>:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nx">To</span><span class="w"> </span><span class="nx">allow</span><span class="w"> </span><span class="nx">mutating</span><span class="w"> </span><span class="nx">admission</span><span class="w"> </span><span class="nx">plugins</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="k">observe</span><span class="w"> </span><span class="nx">changes</span><span class="w"> </span><span class="nx">made</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="nx">plugins</span><span class="p">,</span><span class="w"> </span><span class="nx">built</span><span class="o">-</span><span class="k">in</span><span class="w"> </span><span class="nx">mutating</span><span class="w"> </span><span class="nx">admission</span><span class="w"> </span><span class="nx">plugins</span><span class="w"> </span><span class="nx">are</span>
<span class="nx">re</span><span class="o">-</span><span class="nx">run</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">mutating</span><span class="w"> </span><span class="nx">webhook</span><span class="w"> </span><span class="nx">modifies</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">object</span><span class="w"> </span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<p>The following diagram is a simplified view of the aforementioned process:</p>
<p><img alt="mutating-admission-control-reinvocation" src="https://user-images.githubusercontent.com/3291433/220171917-34083458-b36f-4b08-b1e7-827df540fd0f.png" /></p>
<h3 id="proving-our-hypothesis">Proving our hypothesis</h3>
<p>Unfortunately, we cannot simply <a href="https://access.redhat.com/solutions/3909751">configure TraceAll logging</a> for the
<code class="highlight">kube-apiserver</code>, as the logs are too coarse even with <code class="highlight">TraceAll</code> enabled.</p>
<p>Instead, we will build a custom OpenShift <code class="highlight">kube-apiserver</code> with debug flags enabled and deploy it in a Single Node
OpenShift (SNO) test cluster. By using SNO, we can focus on a single instance of the <code class="highlight">kube-apiserver</code> during our
analysis.</p>
<p>We will then use the delve (<code class="highlight">dlv</code>) debugger to analyze the <code class="highlight">kube-apiserver</code> process.</p>
<p>Of course, none of this should be done on a production cluster. Connecting a debugger to the <code class="highlight">kube-apiserver</code> will
pause the API server when hitting breakpoints, and it can also cause it to crash and/or be restarted. Only ever run
the following steps on a disposable setup.</p>
<h4 id="building-a-custom-kube-apiserver-for-debugging">Building a custom kube-apiserver for debugging</h4>
<p>First, we must clone <a href="https://github.com/openshift/kubernetes">https://github.com/openshift/kubernetes</a>.
We then checkout the target branch of our cluster, in this case OpenShift 4.10:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>git checkout origin/release-4.10 -b debug-4.10
</code></pre></div></td></tr></table></div></p>
<p>We then modify the <code class="highlight">Dockerfile</code> and instruct the image build process to build an API server with debug flags enabled:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>diff
diff<span class="w"> </span>--git<span class="w"> </span>a/openshift-hack/images/hyperkube/Dockerfile.rhel<span class="w"> </span>b/openshift-hack/images/hyperkube/Dockerfile.rhel
index<span class="w"> </span>4e9d88a343f..5df544b7c21<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/openshift-hack/images/hyperkube/Dockerfile.rhel
+++<span class="w"> </span>b/openshift-hack/images/hyperkube/Dockerfile.rhel
@@<span class="w"> </span>-1,7<span class="w"> </span>+1,7<span class="w"> </span>@@
<span class="w"> </span>FROM<span class="w"> </span>registry.ci.openshift.org/ocp/builder:rhel-8-golang-1.17-openshift-4.10<span class="w"> </span>AS<span class="w"> </span>builder
<span class="w"> </span>WORKDIR<span class="w"> </span>/go/src/k8s.io/kubernetes
<span class="w"> </span>COPY<span class="w"> </span>.<span class="w"> </span>.
-RUN<span class="w"> </span>make<span class="w"> </span><span class="nv">WHAT</span><span class="o">=</span><span class="s1">&#39;cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/watch-termination&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
+RUN<span class="w"> </span>make<span class="w"> </span><span class="nv">GOLDFLAGS</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="nv">WHAT</span><span class="o">=</span><span class="s1">&#39;cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/watch-termination&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>cp<span class="w"> </span>openshift-hack/images/hyperkube/hyperkube<span class="w"> </span>/tmp/build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>cp<span class="w"> </span>/go/src/k8s.io/kubernetes/_output/local/bin/linux/<span class="k">$(</span>go<span class="w"> </span>env<span class="w"> </span>GOARCH<span class="k">)</span>/<span class="o">{</span>kube-apiserver,kube-controller-manager,kube-scheduler,kubelet,watch-termination<span class="o">}</span><span class="w"> </span><span class="se">\</span>
</code></pre></div></td></tr></table></div></p>
<p>We then build and push the image to a public container registry:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>podman build -t quay.io/akaris/hyperkube:debug-4.10 -f openshift-hack/images/hyperkube/Dockerfile.rhel .
podman push quay.io/akaris/hyperkube:debug-4.10
</code></pre></div></td></tr></table></div></p>
<p>We create two bash helper functions to simplify image deployment:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code>custom_kao<span class="w"> </span>()
{
<span class="w">    </span>KUBEAPI_IMAGE=$1;
<span class="w">    </span>update_kao;
<span class="w">    </span>oc<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>openshift-kube-apiserver-operator<span class="w"> </span>kube-apiserver-operator<span class="w"> </span>--replicas=0;
<span class="w">    </span>oc<span class="w"> </span>patch<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>openshift-kube-apiserver-operator<span class="w"> </span>kube-apiserver-operator<span class="w"> </span>-p<span class="w"> </span>&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;kube-apiserver-operator&quot;,&quot;env&quot;:[{&quot;name&quot;:&quot;IMAGE&quot;,&quot;value&quot;:&quot;&#39;<span class="cp">${</span><span class="n">KUBEAPI_IMAGE</span><span class="cp">}</span>&#39;&quot;}]}]}}}}&#39;;
<span class="w">    </span>oc<span class="w"> </span>describe<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>openshift-kube-apiserver-operator<span class="w"> </span>kube-apiserver-operator<span class="w"> </span>|<span class="w"> </span>grep<span class="w"> </span>--color=auto<span class="w"> </span>IMAGE;
<span class="w">    </span>sleep<span class="w"> </span>10;
<span class="w">    </span>oc<span class="w"> </span>scale<span class="w"> </span>-n<span class="w"> </span>openshift-network-operator<span class="w"> </span>deployment.apps/network-operator<span class="w"> </span>--replicas=1;
<span class="w">    </span>oc<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>openshift-kube-apiserver-operator<span class="w"> </span>kube-apiserver-operator<span class="w"> </span>--replicas=1
}
update_kao<span class="w"> </span>()
{
<span class="w">    </span>oc<span class="w"> </span>patch<span class="w"> </span>clusterversion<span class="w"> </span>version<span class="w"> </span>--type<span class="w"> </span>json<span class="w"> </span>-p<span class="w"> </span>&#39;[{&quot;op&quot;:&quot;add&quot;,&quot;path&quot;:&quot;/spec/overrides&quot;,&quot;value&quot;:[{&quot;kind&quot;:&quot;Deployment&quot;,&quot;group&quot;:&quot;apps&quot;,&quot;name&quot;:&quot;kube-apiserver-operator&quot;,&quot;namespace&quot;:&quot;openshift-kube-apiserver-operator&quot;,&quot;unmanaged&quot;:true}]}]&#39;
}
</code></pre></div></td></tr></table></div></p>
<p>Last but not least, we instruct OpenShift to deploy the <code class="highlight">kube-apiserver</code> with our custom image:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>custom_kao quay.io/akaris/hyperkube:debug-4.10
</code></pre></div></td></tr></table></div></p>
<p>Then, we wait for the <code class="highlight">kube-apiserver</code> to deploy with our image:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">oc</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">pods</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">openshift</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">apiserver</span><span class="o">=</span><span class="bp">true</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">yaml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">debug</span><span class="o">-</span><span class="mf">4.10</span>
<span class="w">      </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">akaris</span><span class="o">/</span><span class="n">hyperkube</span><span class="p">:</span><span class="n">debug</span><span class="o">-</span><span class="mf">4.10</span>
<span class="w">      </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">akaris</span><span class="o">/</span><span class="n">hyperkube</span><span class="p">:</span><span class="n">debug</span><span class="o">-</span><span class="mf">4.10</span>
<span class="w">      </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">akaris</span><span class="o">/</span><span class="n">hyperkube</span><span class="p">:</span><span class="n">debug</span><span class="o">-</span><span class="mf">4.10</span>
<span class="w">      </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">akaris</span><span class="o">/</span><span class="n">hyperkube</span><span class="p">:</span><span class="n">debug</span><span class="o">-</span><span class="mf">4.10</span>
<span class="o">$</span><span class="w"> </span><span class="n">oc</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">pods</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">openshift</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">apiserver</span><span class="o">=</span><span class="bp">true</span>
<span class="n">NAME</span><span class="w">                                   </span><span class="n">READY</span><span class="w">   </span><span class="n">STATUS</span><span class="w">    </span><span class="n">RESTARTS</span><span class="w">   </span><span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">sno</span><span class="o">.</span><span class="n">workload</span><span class="o">.</span><span class="n">bos2</span><span class="o">.</span><span class="n">lab</span><span class="w">   </span><span class="mi">5</span><span class="o">/</span><span class="mi">5</span><span class="w">     </span><span class="n">Running</span><span class="w">   </span><span class="mi">0</span><span class="w">          </span><span class="mi">55</span><span class="n">s</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="building-and-running-a-dlv-container-image-for-debugging">Building and running a dlv container image for debugging</h4>
<p>We are going to use a <a href="https://github.com/andreaskaris/dlv-container">custom container image</a> to run the <code class="highlight">dlv</code> golang
debugger. Because <code class="highlight">dlv</code> will pause the <code class="highlight">kube-apiserver</code>, we cannot use <code class="highlight">oc debug/node</code>. Instead, we will run the image
directly on the node with podman.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span><span class="nv">NODEIP</span><span class="o">=</span><span class="m">192</span>.168.18.22
$<span class="w"> </span>ssh<span class="w"> </span>core@<span class="si">${</span><span class="nv">NODEIP</span><span class="si">}</span>
$<span class="w"> </span>sudo<span class="w"> </span>-i
<span class="c1"># NODEIP=192.168.18.22</span>
<span class="c1"># podman run \</span>
<span class="w">    </span>--privileged<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--pid<span class="o">=</span>host<span class="w"> </span>--ipc<span class="o">=</span>host<span class="w"> </span>--network<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rm<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>quay.io/akaris/dlv-container:1.20.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dlv<span class="w"> </span>attach<span class="w"> </span>--headless<span class="w"> </span>--accept-multiclient<span class="w"> </span>--continue<span class="w"> </span>--listen<span class="w"> </span><span class="si">${</span><span class="nv">NODEIP</span><span class="si">}</span>:12345<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>kube-apiserver<span class="k">)</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p>The above command will start <code class="highlight">dlv</code> in headless mode. It will listen on <code class="highlight"><span class="cp">${</span><span class="n">NODEIP</span><span class="cp">}</span>:12345</code>. In the next step, we will
connect to the <code class="highlight">dlv</code> headless server with <code class="highlight"><span class="nv">dlv</span><span class="w"> </span><span class="k">connect</span></code>.</p>
<h4 id="identifying-interesting-code-sections">Identifying interesting code sections</h4>
<p>For the SCC <code class="highlight">RUNASUSER</code> strategies, we are interested in code from the <code class="highlight"><span class="nx">apiserver</span><span class="o">-</span><span class="kn">library</span></code>.</p>
<p>For example, the <code class="highlight">runAsAny</code> strategy is defined here:</p>
<ul>
<li><a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/runasany.go#L22">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/user/runasany.go#L22</a></li>
</ul>
<p>We can follow up the stack until we get to the <code class="highlight">security.openshift.io/SecurityContextConstraint</code> admission plugin:</p>
<ul>
<li><a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/provider.go#L159">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/provider.go#L159</a></li>
<li><a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/matcher.go#L117">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccmatching/matcher.go#L117</a></li>
<li><a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccadmission/admission.go#L259">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccadmission/admission.go#L259</a></li>
<li><a href="https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccadmission/admission.go#L94">https://github.com/openshift/apiserver-library-go/blob/release-4.10/pkg/securitycontextconstraints/sccadmission/admission.go#L94</a></li>
</ul>
<p>The code that interests us most is in <code class="highlight"><span class="n">admission</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">94</span></code>. Function <code class="highlight">computeSecurityContext</code> is the entrypoint for
SCC admission and mutation. We will insert a breakpoint here for further analysis:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="n">Admit</span><span class="w"> </span><span class="n">determines</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">admitted</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">requested</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="n">context</span>
<span class="o">//</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">SCCs</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//</span><span class="w"> </span><span class="mf">1.</span><span class="w">  </span><span class="n">Find</span><span class="w"> </span><span class="n">SCCs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="mf">2.</span><span class="w">  </span><span class="n">Find</span><span class="w"> </span><span class="n">SCCs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">SA</span><span class="o">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">retrieving</span><span class="w"> </span><span class="n">SA</span><span class="w"> </span><span class="n">SCCs</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">fatal</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="mf">3.</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">duplicates</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">SA</span><span class="w"> </span><span class="n">SCCs</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="mf">4.</span><span class="w">  </span><span class="n">Create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">providers</span><span class="p">,</span><span class="w"> </span><span class="n">includes</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">allocated</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">necessary</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="mf">5.</span><span class="w">  </span><span class="n">Try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">SCC</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">providers</span><span class="o">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">admit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pod</span>
<span class="o">//</span><span class="w">     </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">validated</span><span class="w"> </span><span class="n">SCC</span><span class="o">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t find any reject the pod and give all errors from the</span>
<span class="o">//</span><span class="w">     </span><span class="n">failed</span><span class="w"> </span><span class="n">attempts</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">On</span><span class="w"> </span><span class="n">updates</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BeforeUpdate</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">zeroes</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">status</span><span class="o">.</span><span class="w">  </span><span class="n">That</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">that</span>
<span class="o">//</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="n">privileged</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">removed</span><span class="o">.</span><span class="w">  </span><span class="n">That</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">hold</span><span class="w"> </span><span class="n">until</span>
<span class="o">//</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="n">old</span><span class="o">/</span><span class="n">new</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="ow">in</span><span class="o">.</span>
<span class="k">func</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="n">constraint</span><span class="p">)</span><span class="w"> </span><span class="n">Admit</span><span class="p">(</span><span class="n">ctx</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">admission</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">admission</span><span class="o">.</span><span class="n">ObjectInterfaces</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ignore</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">shouldIgnore</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nil</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pod</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">GetObject</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">coreapi</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">TODO</span><span class="p">(</span><span class="n">liggitt</span><span class="p">):</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="n">mutation</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">initializing</span><span class="w"> </span><span class="n">updates</span><span class="err">?</span>
<span class="w">    </span><span class="n">specMutationAllowed</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">GetOperation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">admission</span><span class="o">.</span><span class="n">Create</span>

<span class="w">    </span><span class="n">allowedPod</span><span class="p">,</span><span class="w"> </span><span class="n">sccName</span><span class="p">,</span><span class="w"> </span><span class="n">validationErrs</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">computeSecurityContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">pod</span><span class="p">,</span><span class="w"> </span><span class="n">specMutationAllowed</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<p>The documentation about <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#reinvocation-policy">Reinvocation policy</a>
points us to <a href="https://issue.k8s.io/64333">https://issue.k8s.io/64333</a>. The <a href="https://github.com/kubernetes/kubernetes/pull/78080/commits">PR 78080</a>
addressed the issue. The code that interests us here is in
<a href="https://github.com/openshift/kubernetes/blob/release-4.10/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/mutating/dispatcher.go#L169">https://github.com/openshift/kubernetes/blob/release-4.10/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/mutating/dispatcher.go#L169</a> and it's worth setting another tracepoint at this location,
too:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nv">changed</span><span class="w"> </span>{
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="nv">Patch</span><span class="w"> </span><span class="nv">had</span><span class="w"> </span><span class="nv">changed</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">object</span>.<span class="w"> </span><span class="nv">Prepare</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">reinvoke</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">previous</span><span class="w"> </span><span class="nv">webhooks</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">eligible</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">re</span><span class="o">-</span><span class="nv">invocation</span>.
<span class="w">            </span><span class="nv">webhookReinvokeCtx</span>.<span class="nv">RequireReinvokingPreviouslyInvokedPlugins</span><span class="ss">()</span>
<span class="w">            </span><span class="nv">reinvokeCtx</span>.<span class="nv">SetShouldReinvoke</span><span class="ss">()</span>
<span class="w">        </span>}
</code></pre></div></td></tr></table></div></p>
<blockquote>
<p>The above code implements <code class="highlight"><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">mutating</span><span class="w"> </span><span class="nv">admission</span><span class="w"> </span><span class="nv">plugins</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">re</span><span class="o">-</span><span class="nv">run</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">mutating</span><span class="w"> </span><span class="nv">webhook</span><span class="w"> </span><span class="nv">modifies</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">object</span></code>.</p>
</blockquote>
<h4 id="using-dlv-to-analyze-the-kube-apiserver">Using dlv to analyze the kube-apiserver</h4>
<p>Next, connect to the headless <code class="highlight">dlv</code> server, set a breakpoint at <code class="highlight"><span class="n">admission</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">94</span></code>, and print the relevant pod variables
whenever we get to the breakpoint:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">cat</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dlv</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">terminal</span><span class="o">-</span><span class="n">interactive</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">18.22</span><span class="p">:</span><span class="mi">12345</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;break pkg/securitycontextconstraints/sccadmission/admission.go:94&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;c&quot;</span>
<span class="k">while</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span><span class="w"> </span><span class="n">do</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;print pod.ObjectMeta.GenerateName&quot;</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;print pod.ObjectMeta.Annotations&quot;</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;print pod.Spec.Containers[0].SecurityContext&quot;</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;print specMutationAllowed&quot;</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;c&quot;</span>
<span class="n">done</span>
<span class="n">EOF</span>
</code></pre></div></td></tr></table></div></p>
<p>Now, let's create our deployment which triggers the webhook:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>oc apply -f fedora-test-with-annotation.yaml
</code></pre></div></td></tr></table></div></p>
<p>As you can see, admission plugin <code class="highlight">security.openshift.io/SecurityContextConstraint</code> mutates the pod twice. We can see
that the pod's security context is <code class="highlight">restricted</code> after the first mutation, but before the second mutation.
At this point in time, <code class="highlight">securityContext.runAsUser</code> is already injected into the pod's container definition:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">SCC</span><span class="w"> </span><span class="n">mutation</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">)</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.(</span><span class="o">*</span><span class="k">constraint</span><span class="p">).</span><span class="n">Admit</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="o">/</span><span class="n">admission</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">94</span><span class="w"> </span><span class="p">(</span><span class="n">hits</span><span class="w"> </span><span class="n">goroutine</span><span class="p">(</span><span class="mi">2230542</span><span class="p">)</span><span class="err">:</span><span class="mi">1</span><span class="w"> </span><span class="nl">total</span><span class="p">:</span><span class="mi">14</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nl">PC</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3998490</span><span class="p">)</span>
<span class="nl">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">optimized</span><span class="w"> </span><span class="k">function</span>
<span class="ss">&quot;fedora-test-with-annotation-6745dd89bf-&quot;</span>
<span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="w"> </span><span class="o">[</span>
<span class="n">    &quot;webhook/capabilities&quot;: &quot;[\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">]</span>
<span class="ss">*k8s.io/kubernetes/pkg/apis/core.SecurityContext nil</span>
<span class="ss">true</span>

<span class="ss">(... before second SCC mutation ...)</span>
<span class="ss">&gt; k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission.(*constraint).Admit() /go/src/k8s.io/kubernetes/_output/local/go/src/k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission/admission.go:94 (hits goroutine(2230672):1 total:15) (PC: 0x3998490)</span>
<span class="ss">Warning: debugging optimized function</span>
<span class="ss">&quot;</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span><span class="o">-</span><span class="mi">6745</span><span class="n">dd89bf</span><span class="o">-</span><span class="ss">&quot;</span>
<span class="ss">map[string]string [</span>
<span class="ss">    &quot;</span><span class="n">openshift</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">scc</span><span class="ss">&quot;: &quot;</span><span class="n">restricted</span><span class="ss">&quot;,      # &lt;-------- set by first SCC mutation</span>
<span class="ss">    &quot;</span><span class="n">webhook</span><span class="o">/</span><span class="n">capabilities</span><span class="ss">&quot;: &quot;</span><span class="o">[</span><span class="n">\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">]</span>
<span class="ss">*k8s.io/kubernetes/pkg/apis/core.SecurityContext {</span>
<span class="ss">    Capabilities: *k8s.io/kubernetes/pkg/apis/core.Capabilities {</span>
<span class="ss">        Add: []k8s.io/kubernetes/pkg/apis/core.Capability len: 3, cap: 4, [</span>
<span class="ss">            &quot;</span><span class="n">SETFCAP</span><span class="ss">&quot;,</span>
<span class="ss">            &quot;</span><span class="n">CAP_NET_RAW</span><span class="ss">&quot;,</span>
<span class="ss">            &quot;</span><span class="n">CAP_NET_ADMIN</span><span class="ss">&quot;,</span>
<span class="ss">        ],</span>
<span class="ss">        Drop: []k8s.io/kubernetes/pkg/apis/core.Capability len: 4, cap: 4, [&quot;</span><span class="k">KILL</span><span class="ss">&quot;,&quot;</span><span class="n">MKNOD</span><span class="ss">&quot;,&quot;</span><span class="n">SETGID</span><span class="ss">&quot;,&quot;</span><span class="n">SETUID</span><span class="err">&quot;]</span><span class="p">,</span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">Privileged</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">SELinuxOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SELinuxOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">WindowsOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">WindowsSecurityContextOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">RunAsUser</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="mi">1000770000</span><span class="p">,</span><span class="w">               </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;--------</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">SCC</span><span class="w"> </span><span class="n">mutation</span>
<span class="w">    </span><span class="nl">RunAsGroup</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">int64</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">RunAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">ReadOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">AllowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">ProcMount</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">ProcMountType</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">SeccompProfile</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SeccompProfile</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="err">}</span>
<span class="k">true</span>
</code></pre></div></td></tr></table></div></p>
<p>And we can see that the security context is elevated to <code class="highlight">privileged</code> after the second SCC mutation.
The third invocation of function <code class="highlight">computeSecurityContext</code> is purely for validation purposes and does not mutate the
object:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="k">second</span><span class="w"> </span><span class="n">SCC</span><span class="w"> </span><span class="n">mutation</span><span class="p">,</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">)</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.(</span><span class="o">*</span><span class="k">constraint</span><span class="p">).</span><span class="n">Admit</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="o">/</span><span class="n">admission</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">94</span><span class="w"> </span><span class="p">(</span><span class="n">hits</span><span class="w"> </span><span class="n">goroutine</span><span class="p">(</span><span class="mi">2232623</span><span class="p">)</span><span class="err">:</span><span class="mi">1</span><span class="w"> </span><span class="nl">total</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nl">PC</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3998490</span><span class="p">)</span>
<span class="nl">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">optimized</span><span class="w"> </span><span class="k">function</span>
<span class="ss">&quot;fedora-test-with-annotation-6745dd89bf-&quot;</span>
<span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="w"> </span><span class="o">[</span>
<span class="n">    &quot;k8s.ovn.org/pod-networks&quot;: &quot;{\&quot;default\&quot;:{\&quot;ip_addresses\&quot;:[\&quot;10.128.0.63/23\&quot;,\&quot;fd01:0:0:1::3e/64\&quot;</span><span class="o">]</span><span class="p">,</span><span class="err">\</span><span class="ss">&quot;mac_address\&quot;</span><span class="err">:\</span><span class="ss">&quot;0a:58:0a:80:00:3f\&quot;</span><span class="p">,</span><span class="err">\</span><span class="ss">&quot;gateway_ips\&quot;</span><span class="err">:</span><span class="o">[</span><span class="n">\&quot;10.128.0.1\&quot;,\&quot;fd01:0:0:1::1\&quot;</span><span class="o">]</span><span class="err">}}</span><span class="ss">&quot;,</span>
<span class="ss">    &quot;</span><span class="n">openshift</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">scc</span><span class="ss">&quot;: &quot;</span><span class="n">privileged</span><span class="ss">&quot;,      # &lt;----------- second mutation set the SCC to privileged</span>
<span class="ss">    &quot;</span><span class="n">webhook</span><span class="o">/</span><span class="n">capabilities</span><span class="ss">&quot;: &quot;</span><span class="o">[</span><span class="n">\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">]</span>
<span class="ss">*k8s.io/kubernetes/pkg/apis/core.SecurityContext {</span>
<span class="ss">    Capabilities: *k8s.io/kubernetes/pkg/apis/core.Capabilities {</span>
<span class="ss">        Add: []k8s.io/kubernetes/pkg/apis/core.Capability len: 3, cap: 4, [</span>
<span class="ss">            &quot;</span><span class="n">SETFCAP</span><span class="ss">&quot;,</span>
<span class="ss">            &quot;</span><span class="n">CAP_NET_RAW</span><span class="ss">&quot;,</span>
<span class="ss">            &quot;</span><span class="n">CAP_NET_ADMIN</span><span class="ss">&quot;,</span>
<span class="ss">        ],</span>
<span class="ss">        Drop: []k8s.io/kubernetes/pkg/apis/core.Capability len: 4, cap: 4, [&quot;</span><span class="k">KILL</span><span class="ss">&quot;,&quot;</span><span class="n">MKNOD</span><span class="ss">&quot;,&quot;</span><span class="n">SETGID</span><span class="ss">&quot;,&quot;</span><span class="n">SETUID</span><span class="err">&quot;]</span><span class="p">,</span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">Privileged</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">SELinuxOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SELinuxOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">WindowsOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">WindowsSecurityContextOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">RunAsUser</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="mi">1000770000</span><span class="p">,</span>
<span class="w">    </span><span class="nl">RunAsGroup</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">int64</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">RunAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">ReadOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">AllowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">ProcMount</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">ProcMountType</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">    </span><span class="nl">SeccompProfile</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SeccompProfile</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="err">}</span>
<span class="k">false</span>
</code></pre></div></td></tr></table></div></p>
<p>Another way to look at this is by tracing both <code class="highlight"><span class="n">admission</span><span class="p">.</span><span class="k">go</span></code> and the webhooks' <code class="highlight"><span class="n">dispatcher</span><span class="p">.</span><span class="k">go</span></code>. Kill all <code class="highlight">dlv</code> connect
sessions, then kill and restart the <code class="highlight">dlv</code> headless container (this may also cause the kube-apiserver to restart). After
you restarted the <code class="highlight">dlv</code> headless pod, connect to it with:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">cat</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dlv</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">terminal</span><span class="o">-</span><span class="n">interactive</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">18.22</span><span class="p">:</span><span class="mi">12345</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;trace pkg/securitycontextconstraints/sccadmission/admission.go:94&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 1 print pod.ObjectMeta.GenerateName&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 1 print pod.ObjectMeta.Annotations&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 1 print pod.Spec.Containers[0].SecurityContext&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 1 print specMutationAllowed&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;trace apiserver/pkg/admission/plugin/webhook/mutating/dispatcher.go:169&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 2 print invocation.Webhook.uid&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 2 print invocation.Kind&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;on 2 print changed&quot;</span>
<span class="n">echo</span><span class="w"> </span><span class="s2">&quot;c&quot;</span>
<span class="n">EOF</span>
</code></pre></div></td></tr></table></div></p>
<p>You can clearly see here that after our custom webhook is invoked, the pod changed and <code class="highlight">reinvokeCtx.SetShouldReinvoke()</code>
is called. This will trigger the <code class="highlight">reinvoker</code> to call the built-in mutating admission controllers to run again:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="n">goroutine</span><span class="p">(</span><span class="mi">343475</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.(</span><span class="o">*</span><span class="k">constraint</span><span class="p">).</span><span class="n">Admit</span><span class="p">((</span><span class="ss">&quot;*k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission.constraint&quot;</span><span class="p">)(</span><span class="mh">0xc000e42840</span><span class="p">),</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Context</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">.</span><span class="n">valueCtx</span><span class="p">)</span><span class="w"> </span><span class="mh">0xbeef000000000008</span><span class="p">,</span><span class="w"> </span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">apiserver</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">admission</span><span class="p">.</span><span class="n">Attributes</span><span class="p">(</span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">apiserver</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">admission</span><span class="p">.</span><span class="n">attributesRecord</span><span class="p">)</span><span class="w"> </span><span class="mh">0xbeef000000000108</span><span class="p">)</span>
<span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">ObjectMeta</span><span class="p">.</span><span class="nl">GenerateName</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;fedora-test-with-annotation-6745dd89bf-&quot;</span>
<span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">ObjectMeta</span><span class="p">.</span><span class="nl">Annotations</span><span class="p">:</span><span class="w"> </span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="w"> </span><span class="o">[</span>
<span class="n">        &quot;webhook/capabilities&quot;: &quot;[\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">    ]</span>
<span class="ss">    pod.Spec.Containers[0].SecurityContext: *k8s.io/kubernetes/pkg/apis/core.SecurityContext nil</span>
<span class="ss">    specMutationAllowed: true</span>

<span class="ss">&gt; goroutine(343495): k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission/plugin/webhook/mutating.(*mutatingDispatcher).Dispatch((&quot;</span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">apiserver</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">admission</span><span class="o">/</span><span class="n">plugin</span><span class="o">/</span><span class="n">webhook</span><span class="o">/</span><span class="n">mutating</span><span class="p">.</span><span class="n">mutatingDispatcher</span><span class="ss">&quot;)(0xc000db0020), context.Context(*context.valueCtx) 0xbeef000000000008, k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.Attributes(*k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.attributesRecord) 0xbeef000000000108, k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.ObjectInterfaces(*k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/endpoints/handlers.RequestScope) 0xbeef000000000208, (unreadable read out of bounds))</span>
<span class="ss">    data.uid: &quot;</span><span class="n">webhook</span><span class="o">/</span><span class="n">webhook</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="mi">0</span><span class="ss">&quot;</span>
<span class="ss">    invocation.Kind: k8s.io/kubernetes/vendor/k8s.io/apimachinery/pkg/runtime/schema.GroupVersionKind {Group: &quot;&quot;, Version: &quot;</span><span class="n">v1</span><span class="ss">&quot;, Kind: &quot;</span><span class="n">Pod</span><span class="ss">&quot;}</span>
<span class="ss">    changed: true</span>

<span class="ss">&gt; goroutine(343556): k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission.(*constraint).Admit((&quot;</span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.</span><span class="k">constraint</span><span class="ss">&quot;)(0xc000e42840), context.Context(*context.valueCtx) 0xbeef000000000008, k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.Attributes(*k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.attributesRecord) 0xbeef000000000108)</span>
<span class="ss">    pod.ObjectMeta.GenerateName: &quot;</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span><span class="o">-</span><span class="mi">6745</span><span class="n">dd89bf</span><span class="o">-</span><span class="ss">&quot;</span>
<span class="ss">    pod.ObjectMeta.Annotations: map[string]string [</span>
<span class="ss">        &quot;</span><span class="n">openshift</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">scc</span><span class="ss">&quot;: &quot;</span><span class="n">restricted</span><span class="ss">&quot;,</span>
<span class="ss">        &quot;</span><span class="n">webhook</span><span class="o">/</span><span class="n">capabilities</span><span class="ss">&quot;: &quot;</span><span class="o">[</span><span class="n">\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">    ]</span>
<span class="ss">    pod.Spec.Containers[0].SecurityContext: *k8s.io/kubernetes/pkg/apis/core.SecurityContext {</span>
<span class="ss">        Capabilities: *k8s.io/kubernetes/pkg/apis/core.Capabilities {</span>
<span class="ss">            Add: []k8s.io/kubernetes/pkg/apis/core.Capability len: 3, cap: 4, [</span>
<span class="ss">                &quot;</span><span class="n">SETFCAP</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_RAW</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_ADMIN</span><span class="ss">&quot;,</span>
<span class="ss">            ],</span>
<span class="ss">            Drop: []k8s.io/kubernetes/pkg/apis/core.Capability len: 4, cap: 4, [&quot;</span><span class="k">KILL</span><span class="ss">&quot;,&quot;</span><span class="n">MKNOD</span><span class="ss">&quot;,&quot;</span><span class="n">SETGID</span><span class="ss">&quot;,&quot;</span><span class="n">SETUID</span><span class="ss">&quot;],},</span>
<span class="ss">        Privileged: *bool nil,</span>
<span class="ss">        SELinuxOptions: *k8s.io/kubernetes/pkg/apis/core.SELinuxOptions nil,</span>
<span class="ss">        WindowsOptions: *k8s.io/kubernetes/pkg/apis/core.WindowsSecurityContextOptions nil,</span>
<span class="ss">        RunAsUser: *1000770000,</span>
<span class="ss">        RunAsGroup: *int64 nil,</span>
<span class="ss">        RunAsNonRoot: *bool nil,</span>
<span class="ss">        ReadOnlyRootFilesystem: *bool nil,</span>
<span class="ss">        AllowPrivilegeEscalation: *bool nil,</span>
<span class="ss">        ProcMount: *k8s.io/kubernetes/pkg/apis/core.ProcMountType nil,</span>
<span class="ss">        SeccompProfile: *k8s.io/kubernetes/pkg/apis/core.SeccompProfile nil,}</span>
<span class="ss">    specMutationAllowed: true</span>

<span class="ss">&gt; goroutine(344347): k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission.(*constraint).Admit((&quot;</span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.</span><span class="k">constraint</span><span class="ss">&quot;)(0xc000e42840), context.Context(*context.valueCtx) 0xbeef000000000008, k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.Attributes(*k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.attributesRecord) 0xbeef000000000108)</span>
<span class="ss">    pod.ObjectMeta.GenerateName: &quot;</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span><span class="o">-</span><span class="mi">6745</span><span class="n">dd89bf</span><span class="o">-</span><span class="ss">&quot;</span>
<span class="ss">    pod.ObjectMeta.Annotations: map[string]string [</span>
<span class="ss">        &quot;</span><span class="n">k8s</span><span class="p">.</span><span class="n">ovn</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">pod</span><span class="o">-</span><span class="n">networks</span><span class="ss">&quot;: &quot;</span><span class="err">{\</span><span class="ss">&quot;default\&quot;</span><span class="err">:{\</span><span class="ss">&quot;ip_addresses\&quot;</span><span class="err">:</span><span class="o">[</span><span class="n">\&quot;10.128.0.197/23\&quot;,\&quot;fd01:0:0:1::c2/64...+83 more&quot;,</span>
<span class="n">        &quot;openshift.io/scc&quot;: &quot;privileged&quot;,</span>
<span class="n">        &quot;webhook/capabilities&quot;: &quot;[\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">    ]</span>
<span class="ss">    pod.Spec.Containers[0].SecurityContext: *k8s.io/kubernetes/pkg/apis/core.SecurityContext {</span>
<span class="ss">        Capabilities: *k8s.io/kubernetes/pkg/apis/core.Capabilities {</span>
<span class="ss">            Add: []k8s.io/kubernetes/pkg/apis/core.Capability len: 3, cap: 4, [</span>
<span class="ss">                &quot;</span><span class="n">SETFCAP</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_RAW</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_ADMIN</span><span class="ss">&quot;,</span>
<span class="ss">            ],</span>
<span class="ss">            Drop: []k8s.io/kubernetes/pkg/apis/core.Capability len: 4, cap: 4, [&quot;</span><span class="k">KILL</span><span class="ss">&quot;,&quot;</span><span class="n">MKNOD</span><span class="ss">&quot;,&quot;</span><span class="n">SETGID</span><span class="ss">&quot;,&quot;</span><span class="n">SETUID</span><span class="ss">&quot;],},</span>
<span class="ss">        Privileged: *bool nil,</span>
<span class="ss">        SELinuxOptions: *k8s.io/kubernetes/pkg/apis/core.SELinuxOptions nil,</span>
<span class="ss">        WindowsOptions: *k8s.io/kubernetes/pkg/apis/core.WindowsSecurityContextOptions nil,</span>
<span class="ss">        RunAsUser: *1000770000,</span>
<span class="ss">        RunAsGroup: *int64 nil,</span>
<span class="ss">        RunAsNonRoot: *bool nil,</span>
<span class="ss">        ReadOnlyRootFilesystem: *bool nil,</span>
<span class="ss">        AllowPrivilegeEscalation: *bool nil,</span>
<span class="ss">        ProcMount: *k8s.io/kubernetes/pkg/apis/core.ProcMountType nil,</span>
<span class="ss">        SeccompProfile: *k8s.io/kubernetes/pkg/apis/core.SeccompProfile nil,}</span>
<span class="ss">    specMutationAllowed: false</span>
<span class="ss">&gt; goroutine(344875): k8s.io/kubernetes/vendor/github.com/openshift/apiserver-library-go/pkg/securitycontextconstraints/sccadmission.(*constraint).Admit((&quot;</span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">openshift</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">securitycontextconstraints</span><span class="o">/</span><span class="n">sccadmission</span><span class="p">.</span><span class="k">constraint</span><span class="ss">&quot;)(0xc000e42840), context.Context(*context.valueCtx) 0xbeef000000000008, k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.Attributes(*k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/admission.attributesRecord) 0xbeef000000000108)</span>
<span class="ss">    pod.ObjectMeta.GenerateName: &quot;</span><span class="n">fedora</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">annotation</span><span class="o">-</span><span class="mi">6745</span><span class="n">dd89bf</span><span class="o">-</span><span class="ss">&quot;</span>
<span class="ss">    pod.ObjectMeta.Annotations: map[string]string [</span>
<span class="ss">        &quot;</span><span class="n">k8s</span><span class="p">.</span><span class="n">ovn</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">pod</span><span class="o">-</span><span class="n">networks</span><span class="ss">&quot;: &quot;</span><span class="err">{\</span><span class="ss">&quot;default\&quot;</span><span class="err">:{\</span><span class="ss">&quot;ip_addresses\&quot;</span><span class="err">:</span><span class="o">[</span><span class="n">\&quot;10.128.0.197/23\&quot;,\&quot;fd01:0:0:1::c2/64...+83 more&quot;,</span>
<span class="n">        &quot;openshift.io/scc&quot;: &quot;privileged&quot;,</span>
<span class="n">        &quot;webhook/capabilities&quot;: &quot;[\&quot;SETFCAP\&quot;,\&quot;CAP_NET_RAW\&quot;,\&quot;CAP_NET_ADMIN\&quot;</span><span class="o">]</span><span class="ss">&quot;,</span>
<span class="ss">    ]</span>
<span class="ss">    pod.Spec.Containers[0].SecurityContext: *k8s.io/kubernetes/pkg/apis/core.SecurityContext {</span>
<span class="ss">        Capabilities: *k8s.io/kubernetes/pkg/apis/core.Capabilities {</span>
<span class="ss">            Add: []k8s.io/kubernetes/pkg/apis/core.Capability len: 3, cap: 4, [</span>
<span class="ss">                &quot;</span><span class="n">SETFCAP</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_RAW</span><span class="ss">&quot;,</span>
<span class="ss">                &quot;</span><span class="n">CAP_NET_ADMIN</span><span class="ss">&quot;,</span>
<span class="ss">            ],</span>
<span class="ss">            Drop: []k8s.io/kubernetes/pkg/apis/core.Capability len: 4, cap: 4, [&quot;</span><span class="k">KILL</span><span class="ss">&quot;,&quot;</span><span class="n">MKNOD</span><span class="ss">&quot;,&quot;</span><span class="n">SETGID</span><span class="ss">&quot;,&quot;</span><span class="n">SETUID</span><span class="err">&quot;]</span><span class="p">,</span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="nl">Privileged</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">SELinuxOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SELinuxOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">WindowsOptions</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">WindowsSecurityContextOptions</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">RunAsUser</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="mi">1000770000</span><span class="p">,</span>
<span class="w">        </span><span class="nl">RunAsGroup</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">int64</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">RunAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">ReadOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">AllowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">bool</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">ProcMount</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">ProcMountType</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span>
<span class="w">        </span><span class="nl">SeccompProfile</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="n">SeccompProfile</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="err">}</span>
<span class="w">    </span><span class="nl">specMutationAllowed</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="conclusion">Conclusion</h3>
<p>In conclusion, when our pod was created, it did not need to run with the <code class="highlight">privileged</code> SCC. Both the <code class="highlight">restricted</code> and the
<code class="highlight">privileged</code> SCC have the same priority. Due to OpenShift's SCC matching rules, the pod was first matched by the
<code class="highlight">restricted</code> SCC. The <code class="highlight">restricted</code> SCC mutated the pod's containers and added <code class="highlight">securityContext.runAsUser: &lt;ID from project range&gt;</code>.</p>
<p>Now, Istio's mutating admission controller injected its containers into the pod. Because the Istio webhook modified the
pod, Kubernetes triggers a reinvocation of all built-in mutating admission controllers.</p>
<p>Istio's containers require the pod to run with the <code class="highlight">privileged</code> SCC, so when the SCC mutating admission controller ran
a second time, it now assigned the <code class="highlight">privileged</code> SCC to the pod.</p>
<p>The pod therefore showed up with the <code class="highlight">privileged</code> SCC when inspecting it with <code class="highlight">oc get pods</code>, but its containers were also
assigned a <code class="highlight">securityContext.runAsUser</code> field that was actually mutated by the <code class="highlight">restricted</code> SCC which had been applied
during a previous run of the SCC mutating admission plugin.</p>
<p><img alt="mutating-admission-control-reinvocation-2" src="https://user-images.githubusercontent.com/3291433/220173073-e798a901-b420-4831-9358-272af86deffc.png" /></p>
<p>In reality, the entire process can be even more complex. <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#reinvocation-policy">Mutating webhooks can specify a reinvocationPolicy of IfNeeded</a>. This way, mutating webhooks can be reinvocated as well.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 20, 2023</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.prune", "navigation.top", "navigation.path", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>