<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Security Context Constraints (SCC) - Andreas Karis Blog</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Andreas Karis Blog</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Ceph <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ceph/ceph-manual-test/" class="dropdown-item">Ceph manual test with qemu</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Linux <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../linux/cgroups/" class="dropdown-item">cgroups</a>
</li>
                                    
<li>
    <a href="../../linux/containers/" class="dropdown-item">Containers in Linux</a>
</li>
                                    
<li>
    <a href="../../linux/hugepages/" class="dropdown-item">Hugepages</a>
</li>
                                    
<li>
    <a href="../../linux/meson/" class="dropdown-item">meson</a>
</li>
                                    
<li>
    <a href="../../linux/namespaces/" class="dropdown-item">namespaces</a>
</li>
                                    
<li>
    <a href="../../linux/old_java_version_with_xorgs_in_container/" class="dropdown-item">Old Java inside a container with xorgs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Networking <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../networking/arp_and_the_neighbor_table/" class="dropdown-item">ARP and the Neighbor table</a>
</li>
                                    
<li>
    <a href="../../networking/bonding_in_linux/" class="dropdown-item">Bonding in Linux</a>
</li>
                                    
<li>
    <a href="../../networking/geneve_tunneling/" class="dropdown-item">Geneve tunneling</a>
</li>
                                    
<li>
    <a href="../../networking/netlink/" class="dropdown-item">Netlink</a>
</li>
                                    
<li>
    <a href="../../networking/ovn-kind/" class="dropdown-item">OVN kind</a>
</li>
                                    
<li>
    <a href="../../networking/ovn_standalone_on_fedora31/" class="dropdown-item">OVN standalone on Fedora 31</a>
</li>
                                    
<li>
    <a href="../../networking/ovs_recirculation/" class="dropdown-item">OVS packet recirculation</a>
</li>
                                    
<li>
    <a href="../../networking/ovs-vxlan-tunnels-and-dscp/" class="dropdown-item">OVS VXLAN tunnels and DSCP</a>
</li>
                                    
<li>
    <a href="../../networking/ovs_with_gdb/" class="dropdown-item">OVS with GDB</a>
</li>
                                    
<li>
    <a href="../../networking/sctp/" class="dropdown-item">SCTP</a>
</li>
                                    
<li>
    <a href="../../networking/wireguard/" class="dropdown-item">Wireguard</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">OpenShift <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../alertmanager/" class="dropdown-item">AlertManager</a>
</li>
                                    
<li>
    <a href="../cpu-manager-with-custom-machine-config-pool/" class="dropdown-item">CPU manager with custom MachineConfigPool</a>
</li>
                                    
<li>
    <a href="../crio-conmon-runc/" class="dropdown-item">Crio vs conmon vs runc</a>
</li>
                                    
<li>
    <a href="../openshift_httpbin_tshark_sidecar/" class="dropdown-item">Httpbin tshark sidecar container</a>
</li>
                                    
<li>
    <a href="../ocp4-infra-nodes-with-machineset-without-worker-label/" class="dropdown-item">Infra nodes with MachineSets without worker label</a>
</li>
                                    
<li>
    <a href="../ingresscontroller_router_sharding_ocp_on_osp/" class="dropdown-item">Ingress Controller Sharding OCP on OSP</a>
</li>
                                    
<li>
    <a href="../kata/" class="dropdown-item">kata containers and the kata operatora</a>
</li>
                                    
<li>
    <a href="../proxy-ocp-4.5/" class="dropdown-item">Proxy OCP 4.5</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Security Context Constraints (SCC)</a>
</li>
                                    
<li>
    <a href="../../networking/sctp/" class="dropdown-item">SCTP</a>
</li>
                                    
<li>
    <a href="../openshift_troubleshooting_etcd_state/" class="dropdown-item">Troubleshooting etcd state</a>
</li>
                                    
<li>
    <a href="../useful-ocp-curl/" class="dropdown-item">Querying the OCP 4.x upgrades info API</a>
</li>
                                    
<li>
    <a href="../troubleshooting_openshift_on_openstack_worker_creation/" class="dropdown-item">Troubleshooting OpenShift on OpenStack worker creation</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">OpenStack <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../openstack/reattach_to_running_deployment/" class="dropdown-item">Reattach to running deployment</a>
</li>
                                    
<li>
    <a href="../../openstack/using_clouds_yaml/" class="dropdown-item">Using clouds.yaml</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../proxy-ocp-4.5/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../networking/sctp/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#how-security-context-constraints-sccs-work-in-openshift" class="nav-link">How Security Context Constraints (SCCs) work in OpenShift</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#impact-of-the-default-restricted-scc" class="nav-link">Impact of the default restricted SCC</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#fixing-failed-validation-of-security-context-constraints" class="nav-link">Fixing failed validation of security context constraints</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#scc-matching-and-priority" class="nav-link">SCC matching and priority</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#resources" class="nav-link">Resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="how-security-context-constraints-sccs-work-in-openshift">How Security Context Constraints (SCCs) work in OpenShift</h1>
<p>How SCCs work in OpenShift by example. The following tests were run in Red Hat OpenShift Platform 3.11. Depending on the version in use, the cluster's behavior may be slightly different.</p>
<h2 id="impact-of-the-default-restricted-scc">Impact of the default restricted SCC</h2>
<p>The following example spawns a statefulset with a pod as user 65000. This user falls not into the <code>supplemental-groups</code> of the project and can hence not be used by the <code>restricted</code> SCC. The deployment will fail:</p>
<pre><code>$ oc describe project test  | grep scc
            openshift.io/sa.scc.mcs=s0:c10,c0
            openshift.io/sa.scc.supplemental-groups=1000090000/10000
            openshift.io/sa.scc.uid-range=1000090000/10000
</code></pre>

<p>Storage class is a local provisioner with 4 100MB local mounts, set up with <a href="https://github.com/andreaskaris/kubernetes/tree/master/localvolume">https://github.com/andreaskaris/kubernetes/tree/master/localvolume</a>:</p>
<pre><code>$ oc get storageclass
NAME              PROVISIONER                    AGE
local-loopbacks   kubernetes.io/no-provisioner   3d
$ oc get pv
NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS      REASON    AGE
local-pv-18dc9ec0   92Mi       RWO            Delete           Available             local-loopbacks             36s
local-pv-89b778f1   92Mi       RWO            Delete           Available             local-loopbacks             19m
local-pv-9e67e7d6   92Mi       RWO            Delete           Available             local-loopbacks             28m
local-pv-b6a7cd37   92Mi       RWO            Delete           Available             local-loopbacks             3d
</code></pre>

<p><code>statefulset.yaml</code>:</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: &quot;test&quot;
spec:
  clusterIP: None
  # the list of ports that are exposed by this service
  ports:
    - name: http
      port: 80
  # will route traffic to pods having labels matching this selector
  selector:
    name: &quot;test&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test
spec:
  selector:
    matchLabels:
       app: test
  serviceName: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      securityContext:
        runAsUser: 65000
      containers:
        - image: gcr.io/google_containers/busybox
          command:
            - &quot;/bin/sh&quot;
            - &quot;-c&quot;
            - &quot;while true; do date; sleep 1; done&quot;
          name: busybox
          volumeMounts:
            - name: vol
              mountPath: /mnt
  volumeClaimTemplates:
    - metadata:
        name: vol
      spec:
        accessModes: [&quot;ReadWriteOnce&quot;]
        storageClassName: local-loopbacks
        resources:
          requests:
            storage: 90Mi
</code></pre>

<pre><code>$ oc apply -f statefulset.yaml
</code></pre>

<p>OpenShift's admission controller will complain that the range is not correct:</p>
<pre><code>$ oc get pods
No resources found.
$ oc describe statefulset test | tail
  StorageClass:  local-loopbacks
  Labels:        &lt;none&gt;
  Annotations:   &lt;none&gt;
  Capacity:      90Mi
  Access Modes:  [ReadWriteOnce]
Events:
  Type     Reason            Age                 From                    Message
  ----     ------            ----                ----                    -------
  Normal   SuccessfulCreate  40s                 statefulset-controller  create Claim vol-test-0 Pod test-0 in StatefulSet test success
  Warning  FailedCreate      19s (x14 over 40s)  statefulset-controller  create Pod test-0 in StatefulSet test failed error: pods &quot;test-0&quot; is forbidden: unable to validate against any security context constraint: [spec.containers[0].securityContext.securityContext.runAsUser: Invalid value: 65000: must be in the ranges: [1000090000, 1000099999]]
</code></pre>

<h2 id="fixing-failed-validation-of-security-context-constraints">Fixing failed validation of security context constraints</h2>
<p>There are 3 solutions to this. Either:</p>
<ul>
<li>create a new SCC (or modify the restricted policy which is not recommended) or </li>
<li>modify the runAsUser field to run the pod as a user inside range <code>1000090000, 1000099999</code> or </li>
<li>change the namespace's <code>openshift.io/sa.scc.uid-range</code>.</li>
</ul>
<h3 id="resetting-the-lab">Resetting the lab</h3>
<p>First, delete the statefulSet, PVC, etc. Continue once all is deleted:</p>
<pre><code>$ oc get statefulset
No resources found.
$ oc get pods
No resources found.
$ oc get pvc
No resources found.
</code></pre>

<h3 id="changing-the-namespaces-openshiftiosasccuid-range">Changing the namespace's openshift.io/sa.scc.uid-range</h3>
<p>Let's change the namespace's <code>uid-range</code>:</p>
<pre><code>$ oc edit namespace test
namespace/test edited
$ oc describe project test  | grep scc
            openshift.io/sa.scc.mcs=s0:c10,c0
            openshift.io/sa.scc.supplemental-groups=1000090000/10000
            openshift.io/sa.scc.uid-range=65000/1000
</code></pre>

<pre><code>$ oc apply -f statefulset.yaml
service/test created
statefulset.apps/test created
</code></pre>

<pre><code>$ oc get statefulset
NAME      DESIRED   CURRENT   AGE
test      1         1         24s
$ oc get pods
NAME      READY     STATUS    RESTARTS   AGE
test-0    1/1       Running   0          26s
$ oc get pvc
NAME         STATUS    VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS      AGE
vol-test-0   Bound     local-pv-9e67e7d6   92Mi       RWO            local-loopbacks   30s
</code></pre>

<p>The pod was assigned to the restricted SCC:</p>
<pre><code>$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted
</code></pre>

<p>This is because the restricted SCC is the default. If other SCCs were assigned to the default serviceaccount of the project, then SCC priorization would come into play. </p>
<p>For more about SCC priorization, see: <a href="https://docs.openshift.com/container-platform/3.11/architecture/additional_concepts/authorization.html#scc-prioritization">https://docs.openshift.com/container-platform/3.11/architecture/additional_concepts/authorization.html#scc-prioritization</a></p>
<p>On the worker that the pod runs at, verify the container's and processes' UID:</p>
<pre><code>[root@node-0 ~]# docker ps  | grep test
47b2d7df970c        gcr.io/google_containers/busybox@sha256:d8d3bc2c183ed2f9f10e7258f84971202325ee6011ba137112e01e30f206de67                          &quot;/bin/sh -c 'while...&quot;   About a minute ago   Up About a minute                       k8s_busybox_test-0_test_6dfbf91e-d5a1-11ea-a312-fa163e8752f1_0
8b3ef77e9213        registry.redhat.io/openshift3/ose-pod:v3.11.248                                                                                   &quot;/usr/bin/pod&quot;           About a minute ago   Up About a minute                       k8s_POD_test-0_test_6dfbf91e-d5a1-11ea-a312-fa163e8752f1_0
[root@node-0 ~]# docker inspect 47b2d7df970c | grep -i user
            &quot;UsernsMode&quot;: &quot;&quot;,
            &quot;User&quot;: &quot;65000&quot;,
[root@node-0 ~]# ps aux | grep 'date; sleep 1'
65000      5172  0.0  0.0   3164   352 ?        Ss   11:53   0:00 /bin/sh -c while true; do date; sleep 1; done
root       6616  0.0  0.0 112808   972 pts/0    R+   11:55   0:00 grep --color=auto date; sleep 1
</code></pre>

<p>Also note that the FsGroupID was set automatically for the filesystem:</p>
<pre><code>[root@node-0 ~]# ls /mnt/local-storage/loopbacks/ -al
total 8
drwxr-xr-x. 6 root root         42 Jul 30 13:30 .
drwxr-xr-x. 3 root root         23 Jul 30 13:28 ..
drwxrwsr-x. 2 root root       1024 Aug  3 10:06 a
drwxrwsr-x. 2 root root       1024 Aug  3 09:55 b
drwxrwsr-x. 2 root 1000090000 1024 Aug  3 09:55 c
drwxr-xr-x. 3 root root       1024 Jul 30 13:30 d
</code></pre>

<p>And it was assigned as GID to the user inside the pod:</p>
<pre><code>$ oc rsh test-0
/ $ id
uid=65000 gid=0(root) groups=1000090000
</code></pre>

<h3 id="resetting-the-lab_1">Resetting the lab</h3>
<p>Delete the statefulSet, PVC, etc again. Continue once all is deleted:</p>
<pre><code>$ oc get statefulset
No resources found.
$ oc get pods
No resources found.
$ oc get pvc
No resources found.
</code></pre>

<h3 id="creating-a-custom-scc">Creating a custom SCC</h3>
<p>Let's now modify <code>pod.spec.securityContext</code> and set fsGroup:</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: &quot;test&quot;
spec:
  clusterIP: None
  # the list of ports that are exposed by this service
  ports:
    - name: http
      port: 80
  # will route traffic to pods having labels matching this selector
  selector:
    name: &quot;test&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test
spec:
  selector:
    matchLabels:
       app: test
  serviceName: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      securityContext:
        runAsUser: 65000
        fsGroup: 65000
      containers:
        - image: gcr.io/google_containers/busybox
          command:
            - &quot;/bin/sh&quot;
            - &quot;-c&quot;
            - &quot;while true; do date; sleep 1; done&quot;
          name: busybox
          volumeMounts:
            - name: vol
              mountPath: /mnt
  volumeClaimTemplates:
    - metadata:
        name: vol
      spec:
        accessModes: [&quot;ReadWriteOnce&quot;]
        storageClassName: local-loopbacks
        resources:
          requests:
            storage: 90Mi
</code></pre>

<p>This of course must fail:</p>
<pre><code> oc apply -f statefulset.yaml 
service/test created
statefulset.apps/test created
$ oc describe statefulset test | tail
  StorageClass:  local-loopbacks
  Labels:        &lt;none&gt;
  Annotations:   &lt;none&gt;
  Capacity:      90Mi
  Access Modes:  [ReadWriteOnce]
Events:
  Type     Reason            Age               From                    Message
  ----     ------            ----              ----                    -------
  Normal   SuccessfulCreate  7s                statefulset-controller  create Claim vol-test-0 Pod test-0 in StatefulSet test success
  Warning  FailedCreate      2s (x11 over 7s)  statefulset-controller  create Pod test-0 in StatefulSet test failed error: pods &quot;test-0&quot; is forbidden: unable to validate against any security context constraint: [fsGroup: Invalid value: []int64{65000}: 65000 is not an allowed group]
</code></pre>

<p>Let's create a custom SCC to change this. The following group was created by inspecting the <code>restricted</code> SCC with <code>oc get scc restricted -o yaml</code> and then by changing the name, the fsGroup ranges and by removing some of the metadata.</p>
<p><code>restricted-fsgroup.yaml</code>:</p>
<pre><code>allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
allowPrivilegeEscalation: true
allowPrivilegedContainer: false
allowedCapabilities: null
apiVersion: security.openshift.io/v1
defaultAddCapabilities: null
fsGroup:
  type: MustRunAs
  ranges:
    - min: 65000
      max: 66000
kind: SecurityContextConstraints
metadata:
  name: restricted-fsgroup
# priority: 10  # it's possible to prioritize this SCC - we are not doing this here
readOnlyRootFilesystem: false
requiredDropCapabilities:
- KILL
- MKNOD
- SETUID
- SETGID
runAsUser:
  type: MustRunAsRange
seLinuxContext:
  type: MustRunAs
supplementalGroups:
  type: RunAsAny
users: []
volumes:
- configMap
- downwardAPI
- emptyDir
- persistentVolumeClaim
- projected
- secret
</code></pre>

<pre><code>$ oc apply -f restricted-fsgroup.yaml 
securitycontextconstraints.security.openshift.io/restricted-fsgroup created
$ oc get scc
NAME                 PRIV      CAPS      SELINUX     RUNASUSER          FSGROUP     SUPGROUP    PRIORITY   READONLYROOTFS   VOLUMES
anyuid               false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    10         false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
hostaccess           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath persistentVolumeClaim projected secret]
hostmount-anyuid     false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath nfs persistentVolumeClaim projected secret]
hostnetwork          false     []        MustRunAs   MustRunAsRange     MustRunAs   MustRunAs   &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
kube-state-metrics   false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
node-exporter        false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
nonroot              false     []        MustRunAs   MustRunAsNonRoot   RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
privileged           true      [*]       RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
restricted           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
restricted-fsgroup   false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
</code></pre>

<p>Add this restricted-fsgroup to the default service account's SCCs:</p>
<pre><code>$ oc adm policy add-scc-to-user restricted-fsgroup -z default
scc &quot;restricted-fsgroup&quot; added to: [&quot;system:serviceaccount:test:default&quot;]
$ oc get scc restricted-fsgroup -o yaml | grep users -A1
(...)
users:
- system:serviceaccount:test:default
(...)
</code></pre>

<p>Delete the statefulSet, PVC, etc again. Continue once all is deleted:</p>
<pre><code>$ oc get statefulset
No resources found.
$ oc get pods
No resources found.
$ oc get pvc
No resources found.
</code></pre>

<p>The statefulSet can now spawn the pod and the pod is assigned to SCC <code>restricted-fsgroup</code>:</p>
<pre><code>$ oc apply -f statefulset.yaml
$ oc get pods
NAME      READY     STATUS    RESTARTS   AGE
test-0    1/1       Running   0          17s
$ oc describe statefulset test | tail
  StorageClass:  local-loopbacks
  Labels:        &lt;none&gt;
  Annotations:   &lt;none&gt;
  Capacity:      90Mi
  Access Modes:  [ReadWriteOnce]
Events:
  Type    Reason            Age   From                    Message
  ----    ------            ----  ----                    -------
  Normal  SuccessfulCreate  30s   statefulset-controller  create Claim vol-test-0 Pod test-0 in StatefulSet test success
  Normal  SuccessfulCreate  30s   statefulset-controller  create Pod test-0 in StatefulSet test successful
$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted-fsgroup
</code></pre>

<p>The pod now runs with group ID 65000:</p>
<pre><code>$ oc rsh test-0
/ $ id
uid=65000 gid=0(root) groups=65000
</code></pre>

<p>And that matches the group ID of the mount's directory:</p>
<pre><code>[root@node-0 ~]# ls /mnt/local-storage/loopbacks/ -al
total 8
drwxr-xr-x. 6 root root    42 Jul 30 13:30 .
drwxr-xr-x. 3 root root    23 Jul 30 13:28 ..
drwxrwsr-x. 2 root root  1024 Aug  3 10:06 a
drwxrwsr-x. 2 root 65000 1024 Aug  3 09:55 b
drwxrwsr-x. 2 root root  1024 Aug  3 09:55 c
drwxr-xr-x. 3 root root  1024 Jul 30 13:30 d
</code></pre>

<h2 id="scc-matching-and-priority">SCC matching and priority</h2>
<p>Keep in mind that both SCCs are active at the same time - and will be selected depending on which SCC is matched by the requested pod.</p>
<h3 id="matching-based-on-allowed-security-context">Matching based on allowed security context</h3>
<p>Let's change <code>fsGroup: 65000</code> to <code>fsGroup: 1000090000</code>:</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: &quot;test&quot;
spec:
  clusterIP: None
  # the list of ports that are exposed by this service
  ports:
    - name: http
      port: 80
  # will route traffic to pods having labels matching this selector
  selector:
    name: &quot;test&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test
spec:
  selector:
    matchLabels:
       app: test
  serviceName: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      securityContext:
        runAsUser: 65000
        fsGroup: 1000090000
      containers:
        - image: gcr.io/google_containers/busybox
          command:
            - &quot;/bin/sh&quot;
            - &quot;-c&quot;
            - &quot;while true; do date; sleep 1; done&quot;
          name: busybox
          volumeMounts:
            - name: vol
              mountPath: /mnt
  volumeClaimTemplates:
    - metadata:
        name: vol
      spec:
        accessModes: [&quot;ReadWriteOnce&quot;]
        storageClassName: local-loopbacks
        resources:
          requests:
            storage: 90Mi
</code></pre>

<p>Reset the lab again, then deploy the modified deployment.</p>
<p>Now, the pod's SCC is <code>restricted</code> because the requested GID only matches the restricted but not the restricted-fsgroup SCC:</p>
<pre><code>$ oc apply -f statefulset.yaml
service/test created
$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted
</code></pre>

<h3 id="name-as-tiebreaker">Name as tiebreaker</h3>
<p>Now, what happens if we remove the request for a specific fsGroup from the pod?</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: &quot;test&quot;
spec:
  clusterIP: None
  # the list of ports that are exposed by this service
  ports:
    - name: http
      port: 80
  # will route traffic to pods having labels matching this selector
  selector:
    name: &quot;test&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test
spec:
  selector:
    matchLabels:
       app: test
  serviceName: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      securityContext:
        runAsUser: 65000
      containers:
        - image: gcr.io/google_containers/busybox
          command:
            - &quot;/bin/sh&quot;
            - &quot;-c&quot;
            - &quot;while true; do date; sleep 1; done&quot;
          name: busybox
          volumeMounts:
            - name: vol
              mountPath: /mnt
  volumeClaimTemplates:
    - metadata:
        name: vol
      spec:
        accessModes: [&quot;ReadWriteOnce&quot;]
        storageClassName: local-loopbacks
        resources:
          requests:
            storage: 90Mi
</code></pre>

<p>Reset the lab again, then apply the statefulset.</p>
<pre><code>$ oc apply -f statefulset.yaml 
service/test created
statefulset.apps/test created
$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted
</code></pre>

<pre><code>$ oc rsh test-0
/ $ id
uid=65000 gid=0(root) groups=1000090000
</code></pre>

<pre><code>[root@node-0 ~]# ls /mnt/local-storage/loopbacks/ -al
total 8
drwxr-xr-x. 6 root root         42 Jul 30 13:30 .
drwxr-xr-x. 3 root root         23 Jul 30 13:28 ..
drwxrwsr-x. 2 root 1000090000 1024 Aug  3 10:06 a
drwxrwsr-x. 2 root root       1024 Aug  3 09:55 b
drwxrwsr-x. 2 root root       1024 Aug  3 09:55 c
drwxr-xr-x. 3 root root       1024 Jul 30 13:30 d
</code></pre>

<p>Both SCCs have the same priority, are equally restrictive. So the tiebreaker is the name:</p>
<ul>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/additional_concepts/authorization.html#scc-prioritization">https://docs.openshift.com/container-platform/3.11/architecture/additional_concepts/authorization.html#scc-prioritization</a></li>
</ul>
<pre><code>    Highest priority first, nil is considered a 0 priority

    If priorities are equal, the SCCs will be sorted from most restrictive to least restrictive

    If both priorities and restrictions are equal the SCCs will be sorted by name
</code></pre>

<p>Let's suppose this had a different name:</p>
<pre><code>$ oc delete -f restricted-fsgroup.yaml
securitycontextconstraints.security.openshift.io &quot;restricted-fsgroup&quot; deleted
$ oc apply -f fsgroup.yaml 
securitycontextconstraints.security.openshift.io/fsgroup created
$ oc adm policy add-scc-to-user fsgroup -z default
scc &quot;fsgroup&quot; added to: [&quot;system:serviceaccount:test:default&quot;]
$ oc get scc
NAME                 PRIV      CAPS      SELINUX     RUNASUSER          FSGROUP     SUPGROUP    PRIORITY   READONLYROOTFS   VOLUMES
anyuid               false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    10         false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
fsgroup              false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
hostaccess           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath persistentVolumeClaim projected secret]
hostmount-anyuid     false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath nfs persistentVolumeClaim projected secret]
hostnetwork          false     []        MustRunAs   MustRunAsRange     MustRunAs   MustRunAs   &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
kube-state-metrics   false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
node-exporter        false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
nonroot              false     []        MustRunAs   MustRunAsNonRoot   RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
privileged           true      [*]       RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
restricted           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
</code></pre>

<p>Then we'd use the <code>fsgroup</code> SCC:</p>
<pre><code>$ oc apply -f statefulset.yaml 
service/test created
statefulset.apps/test created
$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: fsgroup
</code></pre>

<pre><code>$ oc rsh test-0
id
/ $ id
uid=65000 gid=0(root) groups=65000
</code></pre>

<pre><code>[root@node-0 ~]# ls /mnt/local-storage/loopbacks/ -al
total 8
drwxr-xr-x. 6 root root         42 Jul 30 13:30 .
drwxr-xr-x. 3 root root         23 Jul 30 13:28 ..
drwxrwsr-x. 2 root      65000 1024 Aug  3 10:06 a
drwxrwsr-x. 2 root root       1024 Aug  3 09:55 b
drwxrwsr-x. 2 root root       1024 Aug  3 09:55 c
drwxr-xr-x. 3 root root       1024 Jul 30 13:30 d
</code></pre>

<h3 id="using-the-priority-field-as-a-tiebreaker">Using the priority field as a tiebreaker</h3>
<p>And is there a way to prioritize our policy without changing the name? Yes, with the priority field. Change the SCC's name again to <code>restricted-fsgroup</code>. So based on the name, it would lose against <code>restricted</code>. But also set the priority to <code>1</code> which is higher than <code>restricted</code>s priority of <code>0</code>:</p>
<pre><code>$ cat restricted-fsgroup.yaml 
allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
allowPrivilegeEscalation: true
allowPrivilegedContainer: false
allowedCapabilities: null
apiVersion: security.openshift.io/v1
defaultAddCapabilities: null
fsGroup:
  type: MustRunAs
  ranges:
    - min: 65000
      max: 66000
kind: SecurityContextConstraints
metadata:
  name: restricted-fsgroup
readOnlyRootFilesystem: false
requiredDropCapabilities:
- KILL
- MKNOD
- SETUID
- SETGID
runAsUser:
  type: MustRunAsRange
seLinuxContext:
  type: MustRunAs
supplementalGroups:
  type: RunAsAny
users: []
volumes:
- configMap
- downwardAPI
- emptyDir
- persistentVolumeClaim
- projected
- secret
priority: 1
</code></pre>

<p>After applying this, we see:</p>
<pre><code>$ oc get scc
NAME                 PRIV      CAPS      SELINUX     RUNASUSER          FSGROUP     SUPGROUP    PRIORITY   READONLYROOTFS   VOLUMES
anyuid               false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    10         false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
hostaccess           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath persistentVolumeClaim projected secret]
hostmount-anyuid     false     []        MustRunAs   RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir hostPath nfs persistentVolumeClaim projected secret]
hostnetwork          false     []        MustRunAs   MustRunAsRange     MustRunAs   MustRunAs   &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
kube-state-metrics   false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
node-exporter        false     []        RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
nonroot              false     []        MustRunAs   MustRunAsNonRoot   RunAsAny    RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
privileged           true      [*]       RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;none&gt;     false            [*]
restricted           false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;none&gt;     false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
restricted-fsgroup   false     []        MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    1          false            [configMap downwardAPI emptyDir persistentVolumeClaim projected secret]
</code></pre>

<pre><code>$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted-fsgroup
</code></pre>

<h3 id="demonstrating-that-priority-only-comes-into-play-if-sccs-overlap">Demonstrating that priority only comes into play if SCCs overlap</h3>
<p>But should we decide that we not like  a fsGroup within 65000-65999, we can request the namespace's default and still use <code>restricted</code>, even though we changed the priority:</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: &quot;test&quot;
spec:
  clusterIP: None
  # the list of ports that are exposed by this service
  ports:
    - name: http
      port: 80
  # will route traffic to pods having labels matching this selector
  selector:
    name: &quot;test&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test
spec:
  selector:
    matchLabels:
       app: test
  serviceName: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      securityContext:
        runAsUser: 65000
        fsGroup: 1000090000
      containers:
        - image: gcr.io/google_containers/busybox
          command:
            - &quot;/bin/sh&quot;
            - &quot;-c&quot;
            - &quot;while true; do date; sleep 1; done&quot;
          name: busybox
          volumeMounts:
            - name: vol
              mountPath: /mnt
  volumeClaimTemplates:
    - metadata:
        name: vol
      spec:
        accessModes: [&quot;ReadWriteOnce&quot;]
        storageClassName: local-loopbacks
        resources:
          requests:
            storage: 90Mi
</code></pre>

<p>See this:</p>
<pre><code>$ oc apply -f statefulset.yaml 
service/test created
statefulset.apps/test created
$ oc get pod test-0 -o yaml | grep scc
    openshift.io/scc: restricted
</code></pre>

<h2 id="summary">Summary</h2>
<p>Lessons learned: we can apply multiple SCCs to a ServiceAccount. The default SCC is always <code>restricted</code>. The matching goes by priority first, then most restrictive policy, then by name. And if a policy does not match a specific request, another one might "jump in" and "help out". </p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="[https://www.openshift.com/blog/managing-sccs-in-openshift">https://www.openshift.com/blog/managing-sccs-in-openshift</a></li>
<li><a href="[https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html">https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html</a></li>
<li><a href="[https://docs.openshift.com/container-platform/3.11/install_config/persistent_storage/pod_security_context.html">https://docs.openshift.com/container-platform/3.11/install_config/persistent_storage/pod_security_context.html</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
